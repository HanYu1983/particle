// Compiled by ClojureScript 0.0-2268
goog.provide('test.battleSpirits');
goog.require('cljs.core');
goog.require('lib.tool');
goog.require('lib.tool');
test.battleSpirits._ = require("underscore");
test.battleSpirits.request = require("request");
test.battleSpirits.async = require("async");
test.battleSpirits.fs = require("fs");
test.battleSpirits.imageUrl = (function imageUrl(prod,id){return ("http://www.carddass.com/crusade/image/cardlist/"+cljs.core.str.cljs$core$IFn$_invoke$arity$1(prod)+"/"+cljs.core.str.cljs$core$IFn$_invoke$arity$1(id)+".jpg");
});
test.battleSpirits.output = "/Users/hanyu/Documents/big_workspace/particle/goapp/src/common/txt/crusadeList/";
test.battleSpirits.outputImageDir = "output/crusadeList/";
test.battleSpirits.prods = cljs.core.PersistentVector.fromArray(["123001","123901","221901","240201","86004","86011","86901","123002","193001","235001","240202","86005","86012","123003","193002","235002","240203","86006","86013","123004","193003","235901","240901","86007","86014","123005","193004","240001","86001","86008","86015","123006","193901","240002","86002","86009","86016","123101","221001","240101","86003","86010","86017"], true);
test.battleSpirits.fetchImage = (function fetchImage(prod,id,cb){console.log("fetchImage",id);
return test.battleSpirits.request.call(null,test.battleSpirits.imageUrl.call(null,prod,id)).pipe(test.battleSpirits.fs.createWriteStream((''+cljs.core.str.cljs$core$IFn$_invoke$arity$1(test.battleSpirits.outputImageDir)+cljs.core.str.cljs$core$IFn$_invoke$arity$1(prod)+"/"+cljs.core.str.cljs$core$IFn$_invoke$arity$1(id)+".jpg"))).on("close",(function (){console.log("ok for fetchImage",id);
return setTimeout(cb,(3000));
}));
});
test.battleSpirits.fetchAllImage = (function fetchAllImage(){return test.battleSpirits.async.waterfall([(function (cb){return test.battleSpirits.async.map(cljs.core.clj__GT_js.call(null,cljs.core.map.call(null,(function (p1__5106_SHARP_){return (''+cljs.core.str.cljs$core$IFn$_invoke$arity$1(test.battleSpirits.output)+cljs.core.str.cljs$core$IFn$_invoke$arity$1(p1__5106_SHARP_)+".json");
}),cljs.core.take.call(null,(1),test.battleSpirits.prods))),lib.tool.getFile,cb);
}),(function (datas,cb){var alls = cljs.core.reduce.call(null,(function (p1__5109_SHARP_,p2__5110_SHARP_){return cljs.core.concat.call(null,p1__5109_SHARP_,p2__5110_SHARP_);
}),cljs.core.List.EMPTY,cljs.core.map.call(null,(function (p1__5108_SHARP_){return p1__5108_SHARP_.data;
}),cljs.core.map.call(null,(function (p1__5107_SHARP_){return JSON.parse(p1__5107_SHARP_);
}),cljs.core.js__GT_clj.call(null,datas))));console.log("start fetch image length:",cljs.core.count.call(null,alls));
return cb.call(null,null,alls);
}),(function (datas,cb){var pids = cljs.core.clj__GT_js.call(null,cljs.core.map.call(null,(function (p1__5111_SHARP_){return new cljs.core.PersistentVector(null, 2, 5, cljs.core.PersistentVector.EMPTY_NODE, [p1__5111_SHARP_.prodid,p1__5111_SHARP_.info_18], null).call(null);
}),datas));return console.log(pids);
})],(function (err,rets){return console.log("fetchAllImage done!");
}));
});
