<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8"/>
	<title>card</title>
	<meta name="description" content="" />
	
	<link rel="stylesheet" type="text/css" href="../common/js/lib/jquery-easyui-1.4.3/themes/black/easyui.css">
	<link rel="stylesheet" type="text/css" href="../common/js/lib/jquery-easyui-1.4.3/themes/icon.css">
	<link rel="stylesheet" type="text/css" href="../common/css/normalize.css">
		
	<script type="text/javascript" src="../common/js/lib/leo.utils.js"></script>
	<script type="text/javascript" src="../common/js/lib/underscore/underscore.js"></script>
	<script type="text/javascript" src="../common/js/lib/jquery-easyui-1.4.3/jquery.min.js"></script>
	<script type="text/javascript" src="../common/js/lib/jquery-easyui-1.4.3/jquery.easyui.min.js"></script>
	<script type="text/javascript" src="http://www.jeasyui.com/easyui/jquery.edatagrid.js"></script>
	<script type="text/javascript" src="../common/js/lib/jquery/jquery.tmpl.min.js"></script>
		
</head>
<style>
body{
	position:absolute;
	top:0;
	left:0;
	width:100%;
	height:100%;
	background-color:#333333;
}
.group{
	position:relative;
	width:100%;
}
.hori{
	display:inline-block;
}
</style>
<body>
	<div id="cc" class="easyui-layout" style="width:100%;height:100%;">
		<div data-options="region:'center',title:'卡牌列表'" >
			<div class="group">
				<table id="grid_cards" class="easyui-datagrid" data-options="autoRowHeight:true, remoteSort:false,multiSort:true,fitColumns:true,singleSelect:true" style="width:100%;">
					<thead>
						<tr>
							<!--
							<th data-options="field:'id',width:'4%',sortable:'true'" editor="{type:'validatebox',options:{required:false}}">ID</th>
							-->
							<th data-options="field:'ctype',width:'8%',sortable:'true'" editor="{type:'validatebox',options:{required:false}}">卡片類別</th>
							<th data-options="field:'name',width:'8%',sortable:'true'" editor="{type:'validatebox',options:{required:false}}">名稱</th>
							<th data-options="field:'type',width:'4%',sortable:'true'" editor="{type:'validatebox',options:{required:false}}">類別</th>
							<th data-options="field:'level',width:'4%',sortable:'true'" editor="{type:'validatebox',options:{required:false}}">等級</th>
							<th data-options="field:'weight',width:'4%',sortable:'true'" editor="{type:'validatebox',options:{required:false}}">重量</th>
							<th data-options="field:'power',width:'4%',sortable:'true'" editor="{type:'validatebox',options:{required:false}}">武力</th>
							<th data-options="field:'sname',width:'8%',sortable:'true'" editor="{type:'validatebox',options:{required:false}}">技能名稱</th>
							<th data-options="field:'stype',width:'8%',sortable:'true'" editor="{type:'validatebox',options:{required:false}}">技能類別</th>
							<th data-options="field:'scost',width:'8%',sortable:'true'" editor="{type:'validatebox',options:{required:false}}">技能消耗</th>
							<th data-options="field:'stext',width:'45%',sortable:'true'" editor="{type:'validatebox',options:{required:false}}">內文</th>
						</tr>
					</thead>
					<tbody></tbody>
				</table>
			</div>
		</div>
		<div data-options="region:'east',title:'新增卡牌',split:true,collapsible:false" style="width:30%;">
			<div class="group" style="text-align:center; margin-top:30px;">
				<div class="hori"><span id="txt_id" style="color:yellow"></span></div>
			</div>
			<div class="group" style="text-align:center; margin-top:10px;">
				<div class="group" ctype="ctype">
					<div class="hori">卡片類別</div>
					<div class="hori" style="width:100%;">
						<select class="easyui-combobox" style="width:80%;">
							<option>武器</option>
							<option>防具</option>
							<option>道具</option>
							<option>招式</option>
							<option>狀態</option>
							<option>反應</option>
						</select>
					</div>
				</div>
				<div class="group" ctype="name">
					<div class="hori">武器名稱</div>
					<div class="hori" style="width:100%;"><input class="easyui-textbox" style="width:80%"></div>
				</div>
				<div class="group" ctype="level">
					<div class="hori">武器等級</div>
					<div class="hori" style="width:100%;">
						<select class="easyui-combobox" style="width:80%;">
							<option value="1">1</option>
							<option value="2">2</option>
						</select>
					</div>
				</div>
				<div class="group" ctype="weight">
					<div class="hori">武器重量</div>
					<div class="hori" style="width:100%;">
						<select class="easyui-combobox" style="width:80%;">
							<option value="1">1</option>
							<option value="2">2</option>
							<option value="3">3</option>
							<option value="4">4</option>
						</select>
					</div>
				</div>
				<div class="group" ctype="power">
					<div class="hori">武器武力</div>
					<div class="hori" style="width:100%;"><input class="easyui-textbox" style="width:80%" value="2"></div>
				</div>
				<div class="group" ctype="type">
					<div class="hori">武器類別</div>
					<div class="hori" style="width:100%;">
						<select class="easyui-combobox" style="width:80%;">
							<option>-</option>
							<option>拳</option>
							<option>鞋</option>
							<option>小刀</option>
							<option>劍</option>
							<option>刀</option>
							<option>棍</option>
							<option>槍</option>
							<option>大刀</option>
							<option>斧</option>
							<option>大劍</option>
							<option>其它</option>
						</select>
					</div>
				</div>
				<div class="group" ctype="sname">
					<div class="hori">技能名稱</div>
					<div class="hori" style="width:100%;"><input class="easyui-textbox" style="width:80%"></div>
				</div>
				<div class="group" ctype="stype">
					<div class="hori">技能類別</div>
					<div class="hori" style="width:100%;">
						<select class="easyui-combobox" style="width:80%;">
							<option>-</option>
						</select>
					</div>
				</div>
				<div class="group" ctype="scost">
					<div class="hori">技能消耗</div>
					<div class="hori" style="width:100%;"><input class="easyui-textbox" style="width:80%"></div>
				</div>
				<div class="group" ctype="stext">
					<div class="hori">技能內文</div>
					<div class="hori" style="width:100%;"><input id="txt_note" class="easyui-textbox" data-options="multiline:true" style="width:80%; height:250px;"></input></div>
					
				</div>
				<div class="group">
					<div class="hori">
						<a id="btn_modify" href="#" class="easyui-linkbutton" onclick="onBtnClick(this)" data-options="iconCls:'icon-edit'" style="width:100px; height:60px; margin-top:10px;">修改</a>
					</div>
					<div class="hori">
						<a id="btn_add" href="#" class="easyui-linkbutton" onclick="onBtnClick(this)" data-options="iconCls:'icon-add'" style="width:100px; height:60px; margin-top:10px;">新增</a>
					</div>
					<div class="hori">
						<a id="btn_remove" href="#" class="easyui-linkbutton" onclick="onBtnClick(this)" data-options="iconCls:'icon-remove'" style="width:100px; height:60px; margin-top:10px;">移除</a>
					</div>
				</div>
			</div>
			
		</div>
	</div>
	<script src="js/capi.js"></script>
	<script>
	
	openLoading( '同步中...' );
	resetRows( function(){
		closeLoading();
	});
	
	function resetRows( cb ){
		
		capi.cardList( function( err, ret ){
			
			if( err != null ){
				alert1( err );
			}else{
				setRows( _.map( ret.info, modelToView ) );
			}
			if( cb ) cb();
		});
	}
	
	var currentRow = undefined;
	
	$('.easyui-textbox ' ).textbox({
		onChange:onUIChange
	});
	
	$('.easyui-combobox' ).combobox({
		onChange:onUIChange
	});
	
	function onUIChange(nv, ov){
		var ctype =$( this ).parent().parent().attr('ctype');
		if( currentRow != undefined ){
			currentRow.row[ctype] = nv;
		}
	}
	
	
//	$('#grid_cards').edatagrid();
	$('#grid_cards').datagrid( {
		onAfterEdit:function( index, row, changes ){
			console.log( index, row, changes );
		},
		onSelect:function( index, row ){
			currentRow = {
				id:index,
				row:row
			}
			showCard( row );
		}
	});
		
	/*
	//test
	setRows([
				{name:'value11', type:'value12', level:'2', weight:'3', power:'3', sname:'sname', stype:'stype', scost:'cost', stext:'text'},
				{name:'value11', type:'value12', level:'2', weight:'3', power:'3', sname:'sname', stype:'stype', scost:'cost', stext:'text'}
			]);
			
	appendRow( {name:'3', type:'3', level:'2', weight:'3', power:'3', sname:'sname', stype:'stype', scost:'cost', stext:'text'} );
	deleteRow( 1 );
	*/
	
	function modify(){
		if( currentRow != undefined ){
			openLoading( '同步中...' );
			capi.addCard( viewToModel( currentRow.row ), function(err, ret){
				if( err != null ){
					closeLoading();
					alert1( err );
				}else{
					resetRows( function(){
						closeLoading();
					});
				}
			});
		}
	}
	
	function onBtnClick( dom ){
		switch( dom.id ){
			case 'btn_modify':
				modify();
				break;
			case 'btn_add':
				var newobj;
				if( currentRow != undefined ){
					newobj = {	
									ctype: currentRow.row.ctype,
									name: currentRow.row.name, 
									type: currentRow.row.type, 
									level: currentRow.row.level, 
									weight: currentRow.row.weight, 
									power: currentRow.row.power, 
									sname: currentRow.row.sname, 
									stype: currentRow.row.stype, 
									scost: currentRow.row.scost, 
									stext: currentRow.row.stext } ;
				}else{
					newobj = {id:'', ctype:'武備', name:'拳', type:'拳', level:'1', weight:'1', power:'1', sname:'', stype:'招式', scost:'0', stext:''}
				}
				
				openLoading( '同步中...' );
				capi.addCard( viewToModel( newobj ), function(err, ret){
					if( err != null ){
						closeLoading();
						alert1( err );
					}else{
						resetRows( function(){
							closeLoading();
						});
					}
				});
				
				break;
			case 'btn_remove':
				if( currentRow != undefined ){
					
					openLoading( '同步中...' );
					capi.deleteCard( {Id:currentRow.row.id}, function(err, ret){
						
						currentRow = undefined;
						if( err != null ){
							closeLoading();
							alert1( err );
						}else{
							resetRows( function(){
								closeLoading();
							});
						}
					});
				}
		}
	}
	
	function setRows( datas ){
		$('#grid_cards').datagrid({
			data: datas
		});
		if( currentRow != undefined ){
			selectRow( currentRow.id );
		}
	}
	
	function selectRow( index ){
		$('#grid_cards').datagrid( 'selectRow', index );
	}
	
	function appendRow( row ){
		$('#grid_cards').datagrid('appendRow', row );
	}
	
	function deleteRow( index ){
		$('#grid_cards').datagrid( 'deleteRow', index );
		currentRow = undefined;
	}
	
	function getRowIndex( row ){
		$('#grid_cards').datagrid( 'getRowIndex', row );
	}
	
	function updateRow( index, row ){
		$('#grid_cards').datagrid('updateRow',{
			index: index,
			row: row
		});
	}
	
	function showCard( data ){
		$('#txt_id').html( data.id );
		setCombobox( getCombo( 'ctype' ), data.ctype );
		setText( getInput( 'name' ), data.name );
		setCombobox( getCombo( 'type' ), data.type );
		setCombobox( getCombo( 'weight' ), data.weight );
		setCombobox( getCombo( 'level' ), data.level );
		setText( getInput( 'power' ), data.power );
		setText( getInput( 'sname' ), data.sname );
		setCombobox( getCombo( 'stype' ), data.stype );
		setText( getInput( 'scost' ), data.scost );
		setText( getInput( 'stext' ), data.stext );
	}
	
	function setText( textbox, str ){
		textbox.textbox( {
			value:str
		} );
	}
	
	function setCombobox( combo, str ){
		combo.combobox( {
			value:str
		} );
	}
	
	function getInput( type ){
		return $('.group[ctype=' + type + ']').find( '.easyui-textbox' );
	}
	
	function getCombo( type ){
		return $('.group[ctype=' + type + ']').find( '.easyui-combobox' );
	}
	
	function viewToModel( view ){
		return {
			Id: view.id,
			WName: view.name,
			WLevel: view.level,
			WWeight: view.weight,
			WPower: view.power,
			WType: view.type,
			SName: view.sname,
			SType: view.stype,
			SCost: view.scost,
			SText: view.stext,
			Type: view.ctype
		}
	}
	
	function modelToView( model ){
		return {
			id:model.id,
			name:model.weapon.name,
			level:model.weapon.level,
			weight:model.weapon.weight,
			power:model.weapon.power,
			type:model.weapon.type,
			sname:model.skill.name,
			stype:model.skill.type,
			scost:model.skill.cost,
			stext:model.skill.text,
			ctype:model.type
		}
	}
	
	function alert1( msg ){
		$.messager.alert('error', msg);
	}
	
	function slide( msg ){
		$.messager.show({
			title:'tip',
			msg: msg,
			timeout:1000,
			showType:'slide'
		});
	}
	
	function openLoading( msg ){
		var win = $.messager.progress({
			title:'tip',
			msg:msg
		});
	}
	
	function closeLoading(){
		$.messager.progress('close');
	}
	</script>
	<script src="js/manager.js"></script>
</body>
</html>