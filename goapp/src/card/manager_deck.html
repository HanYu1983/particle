<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8"/>
	<title>余氏組牌機</title>
	<!--page information for search engine-->
	<meta name="title" content="余氏組牌機" />
	<meta name="keyword" content="余氏組牌機,卡牌風雲,三國志大戰,集換式卡牌,線上卡牌,虛擬桌面,組牌機" />
	<meta name="description" content="余氏組牌機" />
	<link rel="image_src" href=""/>
	
	<!--share information for fb-->
	<meta property="og:description" content="余氏組牌機" />
	<meta property="og:title" content="余氏組牌機" />
	<meta property="og:url" content="http://particle-979.appspot.com/card/manager_sango.html#"/>
	<meta name="description" content="" />
	
	<link rel="stylesheet" type="text/css" href="../common/js/lib/jquery-easyui-1.4.3/themes/black/easyui.css">
	<link rel="stylesheet" type="text/css" href="../common/js/lib/jquery-easyui-1.4.3/themes/icon.css">
	<link rel="stylesheet" type="text/css" href="../common/css/normalize.css">
		
	<script type="text/javascript" src="../common/js/lib/leo.utils.js"></script>
	<script type="text/javascript" src="../common/js/lib/underscore/underscore-min.js"></script>
	<script type="text/javascript" src="../common/js/lib/jquery-easyui-1.4.3/jquery.min.js"></script>
	<script type="text/javascript" src="../common/js/lib/jquery-easyui-1.4.3/jquery.easyui.min.js"></script>
	<script type="text/javascript" src="../common/js/lib/jquery/jquery.tmpl.min.js"></script>
	<script type="text/javascript" src="../common/js/lib/google/ga.js"></script>
	<script src="../common/js/lib/csv.js"></script>
	<script src="../common/js/lib/purl.js"></script>	
	<script src="../common/js/sangoWar.js"></script>	
	<script src="../common/js/yugioh.js"></script>	
	<script src="../common/js/cardsearch.js"></script>	
	<script src='js/api.js'></script>
</head>
<style>
body{
	position:absolute;
	top:0;
	left:0;
	width:100%;
	height:100%;
}
.group{
	position:relative;
	width:100%;
}
.hori{
	display:inline-block;
}

.card_item_root{
	position:relative;
	width:100%;
	height:60px;
	border:1px black solid;
}

.big_card_root{
	position:relative;
	display:inline-block;
	width:260px;
	height:390px;;
	cursor:pointer;
	border:1px black solid;
}

.big_card_root_focus{
	border:1px red solid;
}
</style>
<script id="tmpl_bigCard" type="jquery-x-tmpl">
	<div cid=${id} class="big_card_root">
		<img src=${url} style="position:relative; top:0; left:0; width:100%; height:100%;" />
		<img style="position:absolute; left:0; top:0; width:100%; height:100%;" src="images/sampleTxt.png"/>
		<div style="position:absolute; left:0; top:0;  width:100%; height:100%; background-color:black; opacity:.5;"></div>
		<div style="position:absolute; top:0; left:0; padding-left:50px; padding-right:10px; padding-top:10px; ">
			<div>${id}</div>
			<div game="sangoWar">${cname}</div>
			<div game="sangoWar">${ability}</div>
			<div game="sangoWar">${content}</div>
			<br/>
			<div game="sangoWar">${counter}</div>
			
			<div game="yugioh">${name}</div>
			<div game="yugioh">level ${level}</div>
			<div game="yugioh">${type}</div>
			<div game="yugioh">${race}</div>
			<div game="yugioh">${text}</div>
		</div>
	</div>
</script>
<script id="tmpl_cardItem" type="jquery-x-tmpl">
	<div id=${itemId} cid=${id} class="card_item_root">
		<div class="hori" style="position:relative; top:0; left:0; height:100%; vertical-align:top;">
			<a id="btn_remove" href="#" class="easyui-linkbutton" style="width:30px; height:100%;" data-options="iconCls:'icon-remove'"></a>
		</div>
		<div class="hori" style="position:relative; top:0; left:0; height:100%; vertical-align:top;">
			<a id="btn_copy" href="#" class="easyui-linkbutton" style="width:30px; height:100%;" data-options="iconCls:'icon-add'"></a>
		</div>
		<div class="hori" style="height:100%;">
			<img src=${url}  style="height:100%;" />
		</div>
		<div class="hori" style=" vertical-align:top;">
			<div>${id}</div>
			<div game="sangoWar">${cname}</div>
			<div game="sangoWar">${ctype}</div>
			
			<div game="yugioh">${name}</div>
			<div game="yugioh">level ${level}</div>
			<div game="yugioh">${type}</div>
		</div>
	</div>
</script>
			<!--
			alias: coldata[11],
			setcode: coldata[12]
			-->
<script id="tmpl_yugiohForm" type="jquery-x-tmpl">
	<table border=1>	
		<tr>
			<td>星級</td>
			<td>
				<select name="level_1">
					<option></option>
					<option>1</option>
					<option>2</option>
					<option>3</option>
					<option>4</option>
					<option>5</option>
					<option>6</option>
					<option>7</option>
					<option>8</option>
					<option>9</option>
					<option>10</option>
					<option>11</option>
					<option>12</option>
				</select>
				以上
				<select name="level_2">
					<option></option>
					<option>1</option>
					<option>2</option>
					<option>3</option>
					<option>4</option>
					<option>5</option>
					<option>6</option>
					<option>7</option>
					<option>8</option>
					<option>9</option>
					<option>10</option>
					<option>11</option>
					<option>12</option>
				</select>
				以下
			</td>
		</tr>
		<tr>
			<td>屬性</td>
			<td>
				<select name="attr">
					<option></option>
					<option>Earth</option>
					<option>Water</option>
					<option>Fire</option>
					<option>Wind</option>
					<option>Light</option>
					<option>Dark</option>
					<option>Divine</option>
				</select>
			</td>
		</tr>
		<tr>
			<td>種族</td>
			<td>
				<select name="race">
					<option></option>
					<option>Warrior</option>
					<option>Spellcaster</option>
					<option>Fairy</option>
					<option>Fiend</option>
					<option>Zombie</option>
					<option>Machine</option>
					<option>Aqua</option>
					<option>Pyro</option>
					<option>Rock</option>
					<option>Winged Beast</option>
					<option>Plant</option>
					<option>Insect</option>
					<option>Thunder</option>
					<option>Dragon</option>
					<option>Beast</option>
					<option>Beast-Warrior</option>
					<option>Dinosaur</option>
					<option>Fish</option>
					<option>Sea Serpent</option>
					<option>Reptile</option>
					<option>Psychic</option>
					<option>Divine-Beast</option>
					<option>Creator God</option>
					<option>Wyrm</option>
				</select>
			</td>
		</tr>
		
		<tr>
			<td>卡片類型</td>
			<td>
				<select name="ctype">
					<option></option>
					<option>Monster</option>
					<option>Spell</option>
					<option>Trap</option>
				</select>
				<select name="ctype2">
					<option></option>
					<option>Normal</option>
					<option>Effect</option>
					<option>Fusion</option>
					<option>Ritual</option>
					<option>Trap Monsters</option>
					<option>Spirit</option>
					<option>Union</option>
					<option>Gemini</option>
					<option>Tuner</option>
					<option>Synchro</option>
					<option>Token</option>
					<option>Quick-Play</option>
					<option>Continuous</option>
					<option>Equip</option>
					<option>Field</option>
					<option>Counter</option>
					<option>Flip</option>
					<option>Toon</option>
					<option>Xyz</option>
					<option>Pendulum</option>
				</select>
			</td>
		</tr>
		<tr>
			<td>攻擊力</td>
			<td>
				<select name="atk_1">
					<option></option>
					<option>500</option>
					<option>1000</option>
					<option>1500</option>
					<option>2000</option>
					<option>2500</option>
					<option>3000</option>
					<option>3500</option>
					<option>4000</option>
					<option>4500</option>
					<option>5000</option>
				</select>
				以上
				<select name="atk_2">
					<option></option>
					<option>500</option>
					<option>1000</option>
					<option>1500</option>
					<option>2000</option>
					<option>2500</option>
					<option>3000</option>
					<option>3500</option>
					<option>4000</option>
					<option>4500</option>
					<option>5000</option>
				</select>
				以下
			</td>
		</tr>
		<tr>
			<td>防守力</td>
			<td>
				<select name="def_1">
					<option></option>
					<option>500</option>
					<option>1000</option>
					<option>1500</option>
					<option>2000</option>
					<option>2500</option>
					<option>3000</option>
					<option>3500</option>
					<option>4000</option>
					<option>4500</option>
					<option>5000</option>
				</select>
				以上
				<select name="def_2">
					<option></option>
					<option>500</option>
					<option>1000</option>
					<option>1500</option>
					<option>2000</option>
					<option>2500</option>
					<option>3000</option>
					<option>3500</option>
					<option>4000</option>
					<option>4500</option>
					<option>5000</option>
				</select>
				以下
			</td>
		</tr>
		<tr>
			<td>左擺蕩</td>
			<td>
				<select name="lscale_1">
					<option></option>
					<option>1</option>
					<option>2</option>
					<option>3</option>
					<option>4</option>
					<option>5</option>
					<option>6</option>
					<option>7</option>
					<option>8</option>
					<option>9</option>
					<option>10</option>
				</select>
				以上
				<select name="lscale_2">
					<option></option>
					<option>1</option>
					<option>2</option>
					<option>3</option>
					<option>4</option>
					<option>5</option>
					<option>6</option>
					<option>7</option>
					<option>8</option>
					<option>9</option>
					<option>10</option>
				</select>
				以下
			</td>
		</tr>
		<tr>
			<td>右擺蕩</td>
			<td>
				<select name="rscale_1">
					<option></option>
					<option>1</option>
					<option>2</option>
					<option>3</option>
					<option>4</option>
					<option>5</option>
					<option>6</option>
					<option>7</option>
					<option>8</option>
					<option>9</option>
					<option>10</option>
				</select>
				以上
				<select name="rscale_2">
					<option></option>
					<option>1</option>
					<option>2</option>
					<option>3</option>
					<option>4</option>
					<option>5</option>
					<option>6</option>
					<option>7</option>
					<option>8</option>
					<option>9</option>
					<option>10</option>
				</select>
				以下
			</td>
		</tr>
		<tr>
		  <td >
			卡片名稱檢索<br>
		  </td>
		  <td colspan="3">
			<input type="text" name="card_name" size=32>
			<br>
		  </td>
		</tr>
		<tr>
		  <td >
			卡片規則檢索<br>
		  </td>
		  <td colspan="3">
			<input type="text" name="rule" size=32>
			<br>
		  </td>
		</tr>
		 <tr>
		  <td >
			id檢索<br>
		  </td>
		  <td colspan="3">
			  <input id="txt_id" type="text" name="id" size=16>
		  </td>
		</tr>
	</table>
</script>
<script id="tmpl_sangoWarForm" type="jquery-x-tmpl">
	<table cellpadding=2 cellspacing=0 border=1>	
		<tr>
		  <td >
			勢力<br>
		  </td>
		  <td colspan="3">
			  <select name="ntype">
				  <option></option>
				  <option>蜀</option>
				  <option>魏</option>
				  <option>呉</option>
				  <option>漢</option>
				  <option>群</option>
				  <option>他</option>
			  </select>
		  </td>
		</tr>
		<tr>
		  <td >
			卡片種類<br>
		  </td>
		  <td colspan="3">
			  <select name="ctype">
				  <option></option>
				  <option>武将</option>
				  <option>武将/兵隊</option>
				  <option>計略</option>
				  <option>キャンペーン</option>
			  </select>
			</td>
		</tr>
		<tr>
		  <td  width="25%">
			指定cost<br>
		  </td>
		  <td width="25%">
			<select name="cost_1">
			  <option></option>
			  <option>1</option>
			  <option>2</option>
			  <option>3</option>
			  <option>4</option>
				<option>5</option>
			</select>
			以上
			<select name="cost_2">
			  <option></option>
			  <option>1</option>
			  <option>2</option>
			  <option>3</option>
			  <option>4</option>
				<option>5</option>
			</select>
			以下
			<br>
		  </td>
		  <td  width="25%">
			武力<br>
		  </td>
		  <td width="25%">
			<select name="power_1">
			  <option value=""></option>
			  <option value="500">500</option>
			  <option value="1000">1000</option>
			  <option value="1500">1500</option>
			  <option value="2000">2000</option>
			  <option value="2500">2500</option>
			  <option value="3000">3000</option>
			  <option value="3500">3500</option>
			  <option value="4000">4000</option>
			  <option value="4500">4500</option>
			</select>
			以上
			<select name="power_2">
			  <option value=""></option>
			  <option value="500">500</option>
			  <option value="1000">1000</option>
			  <option value="1500">1500</option>
			  <option value="2000">2000</option>
			  <option value="2500">2500</option>
			  <option value="3000">3000</option>
			  <option value="3500">3500</option>
			  <option value="4000">4000</option>
			  <option value="4500">4500</option>
			</select>
			以下   
			<br>
		  </td>
		</tr>
		<tr>
		  <td>
			合計cost<br>
		  </td>
		  <td>
			<select name="costAll_1">
			  <option value=""></option>
			  <option>1</option>
			  <option>2</option>
			  <option>3</option>
			  <option>4</option>
				<option>5</option>
				<option>6</option>
				<option>7</option>
				<option>8</option>
				<option>9</option>
				<option>10</option>
			</select>
			以上
			<select name="costAll_2">
			  <option value=""></option>
			  <option>1</option>
			  <option>2</option>
			  <option>3</option>
			  <option>4</option>
				<option>5</option>
				<option>6</option>
				<option>7</option>
				<option>8</option>
				<option>9</option>
				<option>10</option>
			</select>
			以下
			<br>
		  </td>
		  <td >
			攻城<br>
		  </td>
		  <td>
			<select name="acity">
			  <option value=""></option>
			  <option>1</option>
			  <option>2</option>
			</select>
		  </td>
		</tr>
		<tr>
		  <td >
			兵種<br>
		  </td>
		  <td colspan="3">
			<select name="atype">
				<option></option>
				<option>槍兵</option>
				<option>騎兵</option>
				<option>弓兵</option>
				<option>歩兵</option>
				<option>象兵</option>
			</select>
		  </td>
		</tr>
		<tr>
		  <td >
			特徵<br>
		  </td>
		  <td colspan="3">
			  <select name="symbol">
				  <option></option>
				  <option>計略/戦闘</option>
				  <option>計略/メイン</option>
				  <option>女性</option>
				  <option>南蛮・女性</option>
				  <option>魏五将</option>
				  <option>五虎将</option>
				  <option>軍師</option>
				  <option>黄巾</option>
				  <option>兵隊</option>
				  <option>旗本四天王</option>
				  <option>君主</option>
				  <option>賢女</option>
				  <option>西園八校尉</option>
			  </select>
		  </td>
		</tr>
		<tr>
		  <td >
			特殊規則<br>
		  </td>
		  <td colspan="3">
			<input type="checkbox" name="戦象">戦象
			<input type="checkbox" name="走射">走射
			<input type="checkbox" name="決起">決起
			<input type="checkbox" name="奇襲">奇襲
			<input type="checkbox" name="長槍">長槍
			<input type="checkbox" name="外交">外交
			<input type="checkbox" name="伏兵">伏兵
			<input type="checkbox" name="乱舞">乱舞
			<input type="checkbox" name="憂国">憂国
			<input type="checkbox" name="支援">支援
			<input type="checkbox" name="募兵">募兵
			<input type="checkbox" name="貫通">貫通
			<input type="checkbox" name="援軍">援軍
			<input type="checkbox" name="回避">回避
			<input type="checkbox" name="防柵">防柵
			<input type="checkbox" name="補佐">補佐
			<input type="checkbox" name="連弩">連弩
			<input type="checkbox" name="舞闘">舞闘
			<input type="checkbox" name="強進">強進
			<input type="checkbox" name="先駆">先駆
			<input type="checkbox" name="覚醒">覚醒
			<input type="checkbox" name="国防">国防
			<input type="checkbox" name="突撃">突撃
			<input type="checkbox" name="威圧">威圧
			<input type="checkbox" name="同盟">同盟
		  </td>
		</tr>
		<tr>
		  <td >
			卡片名稱檢索<br>
		  </td>
		  <td colspan="3">
			<input type="text" name="card_name" size=32>
			<br>
		  </td>
		</tr>
		<tr>
		  <td >
			卡片規則檢索<br>
		  </td>
		  <td colspan="3">
			<input type="text" name="rule" size=32>
			<br>
		  </td>
		</tr>
		 <tr>
		  <td >
			id檢索<br>
		  </td>
		  <td colspan="3">
			  <input id="txt_id" type="text" name="id" size=16>
		  </td>
		</tr>
	  </table>
</script>
<body>
	<div id="cc" class="easyui-layout" style="width:100%;height:100%;">
		<div data-options="region:'north',title:'條件',split:true" style="height:330px;">
			<div class="group" style="text-align:center; margin-top:10px;">
				<div class="group">
					<form id="form_container" name="form_value" class="hori">
						<!-- by script -->
					</form>
				</div>
				<div class="group">
					<div class="hori">
						<a id="btn" href="#" class="easyui-linkbutton" style="width:200px; height:40px;" onclick="app.view.onResetClick()" data-options="iconCls:'icon-edit'">重設</a>
					</div>
					<div class="hori">
						<a id="btn_search" href="#" class="easyui-linkbutton" style="width:200px; height:40px;" onclick="app.view.onSearchClick()" data-options="iconCls:'icon-search',disabled:true">搜尋</a>
					</div>
				</div>
				
			</div>
		</div>
		<div data-options="region:'center',title:'結果'">
			<div id="pag_bigCard" class="easyui-pagination" data-options="pageSize:20,layout:['first','links','last']"></div>
			<div id="mc_bigCardContainer" >
				
			</div>
		</div>
		<div data-options="region:'east',title:'組牌'" style="width:350px; overflow-x:hidden;">
			<div class="group" style="text-align:center; margin-top:10px;">
				<div class="hori">
					<span id="txt_count" style="color:yellow">0</span>張
				</div>
				<div class="hori">
					<div class="hori">
						<a id="btn" href="#" class="easyui-linkbutton" style="width:100px; height:40px;" onclick="app.view.onClearClick()" data-options="iconCls:'icon-remove'">清空</a>
					</div>
					<div class="hori">
						<a id="btn_output" href="#" class="easyui-linkbutton" style="width:100px; height:40px;" onclick="app.view.onSaveClick()" data-options="iconCls:'icon-save',disabled:true">匯入/匯出</a>
					</div>
				</div>
			</div>
			<div id="mc_cardContainer" class="group" style="margin-top:10px;">
				
			</div>
		</div>
	</div>
	<div id="win_output" class="easyui-window" title="匯入/匯出" data-options="minimizable:false,maximizable:false,collapsible:false,closed:true,modal:true" style="width:500px;height:300px" >
		<div class="group" style="text-align:center;">
			<input class="easyui-textbox" data-options="multiline:true" style="width:100%; height:200px">
			<div class="hori" style="margin-top:10px;">
				<a id="btn" href="#" class="easyui-linkbutton" style="width:80px; height:40px;" onclick="app.view.onLoadClick()" data-options="iconCls:'icon-save'">匯入</a>
				<a id="btn" href="#" class="easyui-linkbutton" style="width:120px; height:40px;" onclick="window.open('https://particle-979.appspot.com/manager/index.html#');" data-options="iconCls:'icon-back'">去輸入牌組</a>
				<a id="btn" href="#" class="easyui-linkbutton" style="width:140px; height:40px;" onclick="window.open('https://particle-979.appspot.com/card/index.html#');" data-options="iconCls:'icon-redo'">去玩三國志大戰</a>
			</div>
		</div>
	</div>
	<script>
	googleTracking.init( 'UA-55273266-3' );
	
	var game = (function( hashobj ){
		if( hashobj.game == undefined ) return 'sangoWar';
		switch( hashobj.game ){
			case 'sangoWar':
			case 'yugioh':
				return hashobj.game;
			default:
				return 'sangoWar';
		}
	})( leo.utils.getHash() );
	
	var cardlist;
	var itemId = 0;
	var form_container = $('#form_container' );
	var tmpl_form = $('#tmpl_' + game + 'Form' );
	
	form_container.append( tmpl_form.tmpl() );
	
	switch( game ){
		case 'yugioh':
			yugioh.load( "js/yugiohList.txt", onLoadGameCallback)
			break;
		case 'sangoWar':
			sangoWar.load( "js/sangoList.txt", onLoadGameCallback);
	}
	
	function onLoadGameCallback( err, _cardlist ){
		cardlist = _cardlist;
		$("#btn_search").linkbutton( 'enable' );
		$("#btn_output").linkbutton( 'enable' );
	}
	
	function getId(){
		return itemId++;
	}
	
	function handleResponse( cb ) {
		return function ( err, ret ) {
			if ( err != null ) {
				alert( '錯誤:' + err );
			}else {
				cb( ret );
			}
		}
	}
	
	var app = app || {};
	app.view = app.view || {};
	
	(function( module ){
		var mc_bigCardContainer = $('#mc_bigCardContainer' );
		var win_output = $('#win_output' );
		var mc_cardContainer = $('#mc_cardContainer' );
		var txt_count = $('#txt_count' );
		var pag_bigCard = $('#pag_bigCard' );
		var currentPage = 0;
		var ary_cards;
		var ary_deck = [];
		
		function createBigCard(){
			if( ary_cards == undefined ) return; 
			mc_bigCardContainer.empty();
			
			var sid = currentPage * 20;
			var eid = currentPage * 20 + 20;
			
			if( eid > ary_cards.length ){
				eid = ary_cards.length;
			}
			
			var showCards = ary_cards.slice( sid, eid );
			_.each( showCards, function( card ){
				switch( game ){
					case 'yugioh':
						card.url = api.getCardImageWithPackageName( 'yugioh', card.id );
						break;
					case 'sangoWar':
						card.url = api.getCardImageWithPackageName( 'sangoWar', sangoWar.formatKey( card.id ) );
				}
				
				if( card.url == undefined ) {
					card.url = 'images/cardback.png';
				}
				
				var div = $("#tmpl_bigCard").tmpl( card );
				div.attr( 'data', JSON.stringify( card ));
				div.click( function(){
					var thisDom = $(this);
					outFocusAll();
					thisDom.addClass( 'big_card_root_focus' );
					pushToDeck( JSON.parse( thisDom.attr( 'data' ) ));
				});
				mc_bigCardContainer.append( div );
			});
			
			function outFocusAll(){
				mc_bigCardContainer.find( 'div' ).removeClass( 'big_card_root_focus' );
			}
		}
		
		function setDeck(){
			
			var oldtop = mc_cardContainer.parent().scrollTop();
			mc_cardContainer.empty();
			
			ary_deck.sort( function( aobj, bobj ){
				switch( game ){
					case 'sangoWar':
						return aobj.cname.localeCompare( bobj.cname );
					default:
						return aobj.id.localeCompare( bobj.id );
				}
			});
			
			txt_count.html( ary_deck.length );
			
			_.each( ary_deck, function( card ){
				var cardItem = $("#tmpl_cardItem" ).tmpl( card );
				mc_cardContainer.append( cardItem );
				
				cardItem.find( '#btn_remove' ).linkbutton( {
					onClick:function(){
						var removeId = $(this ).parent().parent().attr( 'id' );
						removeCardFromDeck( removeId );	
						setDeck();
					}
				});
				
				cardItem.find( '#btn_copy' ).linkbutton( {
					onClick:function(){
						var addId = $(this ).parent().parent().attr( 'id' );
						coptyCardFromDeck( addId );
					}
				});
				
				cardItem.click( function(){
					var showId = $( this ).attr( 'id' );
					searchCardFromDeck( showId );
				});
			});
			
			if( oldtop != 0 ){
				mc_cardContainer.parent().scrollTop( oldtop );
			}
			
		}
		
		function removeCardFromDeck( itemId ){
			var removeItem = _.find( ary_deck, function( cardItem ){
				return cardItem.itemId == itemId;
			});
			ary_deck.splice( ary_deck.indexOf( removeItem ), 1 );
		}
		
		function coptyCardFromDeck( itemId ){
			var beCopyItem = _.find( ary_deck, function( cardItem ){
				return cardItem.itemId == itemId;
			});
			
			var copyItem = JSON.parse( JSON.stringify( beCopyItem ) );
			copyItem.itemId = getId();
			
			ary_deck.push( copyItem );
			setDeck();
		}
		
		function searchCardFromDeck( itemId ){
			var searchCard = _.find( ary_deck, function( cardItem ){
				return cardItem.itemId == itemId;
			});
			searchCards( 'id=' + searchCard.id );
		}
		
		function pushToDeck( card ){
			var copyCard = JSON.parse( JSON.stringify( card ) );
			copyCard.itemId = getId();
			ary_deck.push( copyCard );
			setDeck();
		}
		
		function onSearchClick(){
			googleTracking.click( 'onSearchClick' );
			searchCards( $( document.form_value ).serialize() );
		}
		
		function searchCards( searchstr ){
			currentPage = 0;
			pag_bigCard.pagination( 'select', 1 );
			
			ary_cards = searchLib( searchstr ).slice();
			
			createBigCard();
			setPagination( ary_cards.length );
		}
		
		// 三國尋找方法實做
		function sangoWarQuerystring2fns( qstr ){
			var url = $.url("?" + qstr)
			var query = url.data.param.query
			var fns = []
			for( var k in query ){
				var v = query[k]
				if( v == "" ){
					continue
				}
				switch( k ){
				case "id":
					fns.push( cardsearch.attrEq( "id", v ) )
					break
				case "acity":
					fns.push( cardsearch.attrEq( "acity", parseInt(v) ) )
					break
				case "atype":
					fns.push( cardsearch.attrEq( "atype2", v ) )
					break
				case "card_name":
					fns.push( cardsearch.attrEq( "cname", v ) )
					break
				case "costAll_2":
					fns.push( cardsearch.attrLe( "costA", parseInt(v) ))
					break
				case "costAll_1":
					fns.push( cardsearch.attrGe( "costA", parseInt(v) ))
					break
				case "cost_2":
					fns.push( cardsearch.attrLe( "cost", parseInt(v) ))
					break
				case "cost_1":
					fns.push( cardsearch.attrGe( "cost", parseInt(v) ))
					break
				case "ctype":
					fns.push( cardsearch.attrEq( "ctype", v ) )
					break
				case "ntype":
					fns.push( cardsearch.attrEq( "ntype", v ) )
					break
				case "power_2":
					fns.push( cardsearch.attrLe( "power", parseInt(v) ))
					break
				case "power_1":
					fns.push( cardsearch.attrGe( "power", parseInt(v) ))
					break
				case "rule":
					fns.push( cardsearch.attrEq( "content", v ))
					break
				case "symbol":
					fns.push( cardsearch.attrEq( "atype", v ) )
					break
				default:
					if( v == "on" ){
						fns.push( cardsearch.attrEq( "ability", k ))
					}
				}
			}
			return fns
		}
		
		// 遊戲王尋找方法實做
		/*
						id: coldata[0],
						name: coldata[1],
						level: parseInt(coldata[2]),
						attribute: coldata[3],
						race: coldata[4],
						type: coldata[5],
						lscale: parseInt(coldata[6]),
						rscale: parseInt(coldata[7]),
						attack: parseInt(coldata[8]),
						defence: parseInt(coldata[9]),
						text: decoded,
						alias: coldata[11],
						setcode: coldata[12]
		*/
		function yugiohQuerystring2fns( qstr ){
			var url = $.url("?" + qstr)
			var query = url.data.param.query
			var fns = []
			for( var k in query ){
				var v = query[k]
				if( v == "" ){
					continue
				}
				switch( k ){
				case "card_name":
					fns.push( cardsearch.attrEq( "name", v ) )
					break;
				case "rule":
					fns.push( cardsearch.attrEq( "text", v ))
					break
				case "id":
					fns.push( cardsearch.attrEq( "id", v ) )
					break
				case "attr":
					fns.push( cardsearch.attrEq( "attribute", v ) )
					break
				case 'race':
					fns.push( cardsearch.attrEq( "race", v ) )
					break
				case "ctype":
					fns.push( cardsearch.attrEq( "type", v ) )
					break
				case "ctype2":
					fns.push( cardsearch.attrEq( "type", v ) )
					break	
				case 'lscale_1':
					fns.push( cardsearch.attrGe( "lscale", v ) )
					break;
				case 'lscale_2':
					fns.push( cardsearch.attrLe( "lscale", v ) )
					break;
				case 'rscale_1':
					fns.push( cardsearch.attrGe( "rscale", v ) )
					break;
				case 'rscale_2':
					fns.push( cardsearch.attrLe( "rscale", v ) )
					break;
				case 'level_1':
					fns.push( cardsearch.attrGe( "level", v ) )
					break;
				case 'level_2':
					fns.push( cardsearch.attrLe( "level", v ) )
					break;
				case 'atk_1':
					fns.push( cardsearch.attrGe( "attack", v ) )
					break;
				case 'atk_2':
					fns.push( cardsearch.attrLe( "attack", v ) )
					break;
				case 'def_1':
					fns.push( cardsearch.attrGe( "defence", v ) )
					break;
				case 'def_2':
					fns.push( cardsearch.attrLe( "defence", v ) )
					break;
				default:
					if( v == "on" ){
						fns.push( cardsearch.attrEq( "ability", k ))
					}
				}
			}
			return fns
		}
		
		function searchLib( str ){
			var fns = (function(){
				switch( game ){
					case 'yugioh':
						return yugiohQuerystring2fns(str)
					case 'sangoWar':
						return sangoWarQuerystring2fns(str);
				}
			})();
			return cardsearch.search( fns, cardlist );
		}
		
		function setPagination( total ){
			pag_bigCard.pagination({ total : total, onSelectPage : function(pageNumber,pageSize) {
				currentPage = pageNumber - 1;
				if( currentPage < 0 ) currentPage = 0;
				createBigCard();
			}});
		}
		
		function onClearClick(){
			googleTracking.click( 'onClearClick' );
			ary_deck = [];
			mc_cardContainer.empty();
			setDeck();
		}
		
		function onSaveClick(){
			googleTracking.click( 'onSaveClick' );
			win_output.window('open' );
			var ary_new = _.map( ary_deck, function( card ){
				switch( game ){
				default:
					return card.id
				case 'sangoWar':
					return sangoWar.formatKey( card.id );
				}
			});
			var outputstr = JSON.stringify( ary_new );
			outputstr = outputstr.substr( 1, outputstr.length - 2 );
			win_output.find( '.easyui-textbox' ).textbox( 'setText', outputstr);
		}
		
		function onLoadClick(){
			googleTracking.click( 'onLoadClick' );
			var str = win_output.find( '.easyui-textbox' ).textbox( 'getText');
			str = '[' + str + ']';
			try{
				var inputobj = JSON.parse( str );
				win_output.window('close' );
				
				var lostCards = [];
				ary_deck = _.map( inputobj, function( incard ){
					var retobj = _.find( cardlist, function( oricard ){
						return oricard.id.indexOf( incard.replace( '.jpg', '' ) ) == 0;
					});
					if( retobj == undefined ){
						lostCards.push( incard );
					}
					return retobj;
				});
				
				ary_deck = _.filter( ary_deck, function( cardItem ){
					return cardItem != undefined;
				});
				
				if( ary_deck.length == 0 ){
					showMessage( '系統中沒有任何您所輸入的卡片哦' );
				}else{
					if( lostCards.length > 0 ){
						showMessage( '系統中找不到這些卡片哦! 代碼: ' + JSON.stringify( lostCards ) );
					}
					
					_.each( ary_deck, function( card ){
						card.itemId = getId();
						switch( game ){
							case 'yugioh':
								card.url = api.getCardImageWithPackageName( 'yugioh', card.id );
								break;
							case 'sangoWar':
								card.url = api.getCardImageWithPackageName( 'sangoWar', sangoWar.formatKey( card.id ) );
						}
						if( card.url == undefined ) {
							card.url = 'images/cardback.png';
						}
					});
					setDeck();
				}
			}catch( e ){
				$.messager.alert('提示','格式錯誤哦');
			}
		}
		
		function showMessage( msg ){
			$.messager.show({
				title:'提示',
				msg: msg,
				timeout:5000,
				showType:'slide'
			});
		}
		
		function onResetClick(){
			googleTracking.click( 'onResetClick' );
			$('form').find( 'select' ).val('');
			$('form').find( 'input[type=checkbox]' ).prop('checked', false);
			$('form').find( 'input[type=text]' ).val('');
		}
		
		
		module.onResetClick = onResetClick;
		module.onSearchClick = onSearchClick;
		module.onClearClick = onClearClick;
		module.onSaveClick = onSaveClick;
		module.onLoadClick = onLoadClick;
	})( app.view );
	</script>
</body>
</html>