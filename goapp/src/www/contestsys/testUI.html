<html>
	<head>
		<meta charset="utf-8"/>
	</head>
	<body>
<!--                                              -->
<div style="width:100%;height:100%;">
	<div class="easyui-layout" style="width:100%;height:100%;">
        <div data-options="region:'west',split:true" title="比賽" style="width:200px;">
			<div class="easyui-accordion" data-options="fit:true,border:false" style='overflow: auto;'>
                <ul class="easyui-tree" id="gameTree" data-options="onClick: onClickGameTree">
		            <li>
		                <span>比賽1</span>
		                <ul>
		                    <li>index.html</li>
		                    <li>about.html</li>
		                    <li>welcome.html</li>
		                </ul>
		            </li>
					
					<li>
		                <span>比賽2</span>
		                <ul>
		                    <li>index.html</li>
		                    <li>about.html</li>
		                    <li>welcome.html</li>
		                </ul>
		            </li>
		        </ul>
            </div>
		</div>
        <div data-options="region:'center'">
            <div class="easyui-tabs" style='height:100%'>
		        <div title="新增/修改比賽">
					<div class="easyui-panel" style="padding:5px;">
						<form name="form_peopleJoin" class="easyui-form" data-options="novalidate:true">
							小名<input class="easyui-textbox" name="name" style="width:100px" data-options="required:true">
							參加碼<input name="pwd" type="password" class="easyui-textbox">
							<a href="#" class="easyui-linkbutton" data-options="plain:false" onclick="onClick('joinContest')">參加比賽</a>
							<a href="#" class="easyui-linkbutton" data-options="plain:false" onclick="onClick('leaveContest')">退出比賽</a>
						</form>
					</div>
					<div class="easyui-panel" style="padding:5px;">
						<a href="#" class="easyui-linkbutton" data-options="plain:true,iconCls:'icon-add'" onclick="onClick('newContest')">新增草搞</a>
				        <a href="#" class="easyui-linkbutton" data-options="plain:true,iconCls:'icon-remove'" onclick="onClick('removeContest')">刪除</a>
						<a href="#" class="easyui-linkbutton" data-options="plain:true,iconCls:'icon-ok'" onclick="onClick('commitContest')">發佈</a>
						<a href="#" class="easyui-linkbutton" data-options="plain:true,iconCls:'icon-edit'" onclick="onClick('updateContest')">修改</a>
						<a href="#" class="easyui-linkbutton" data-options="plain:true">更新比賽列表</a>
				    </div>
					<form name="form_contest" class="easyui-form" data-options="novalidate:true">
						狀態
						<div style="margin-bottom:20px">
			                <select class="easyui-combobox" name="state" disabled style="width:100%">
				                <option value="0">草搞</option>
				                <option value="1">進行中</option>
								<option value="2">結束</option>
							</select>
			            </div>
						遊戲
						<div style="margin-bottom:20px">
			                <select class="easyui-combobox" name="game">
				                <option value="sengoku">戰國大戰</option>
				                <option value="sengo">三國大戰</option>
								<option value="gundamWarN">鋼彈大戰NexA</option>
								<option value="gundamWar">鋼彈大戰</option>
							</select>
			            </div>
						名稱
			            <div style="margin-bottom:20px">
			                <input class="easyui-textbox" name="name" style="width:100%" data-options="required:true">
			            </div>
						描述
			            <div style="margin-bottom:20px">
							<textarea rows="4" cols="50" name="description">description</textarea>
			            </div>
						參加碼
						<div style="margin-bottom:20px">
							<input name="pwd" type="password" class="easyui-textbox">
				        </div>
						比賽開始
						<div style="margin-bottom:20px">
				            <input class="easyui-datebox" name="startTime">
				        </div>
			        </form>
		        </div>
		        <div title="賽程管理">
					<div class="easyui-accordion" data-options="multiple:true" style="width:100%;">
						<div title="賽程" style='height:300px'>
				            <div id='infovis' style='width:600px; height:300px'></div>
				        </div>
				        <div title="玩家" data-options="selected:true">
				            <table id="dg" class="easyui-datagrid" style='width:100%'
						            data-options="
						                iconCls: 'icon-edit',
						                singleSelect: true,
										collapsible:false,
						                toolbar: '#tb',
						                onClickCell: onClickCell,
						                onEndEdit: onEndEdit
						            ">
						        <thead>
						            <tr>
						                <th data-options="field:'ID',width:80,align:'center'">ID</th>
						                <th data-options="field:'Name',width:100,align:'center'">小名</th>
						                <th data-options="field:'Power',width:80,align:'center',editor:'numberbox'">種子選手</th>
						            </tr>
						        </thead>
								<tbody>
									<tr>
										<td field="ID">ID</td>
										<td field="Name">Name</td>
										<td field="Power">0</td>
									</tr>
								</tbody>
						    </table>
						 
						    <div id="tb" style="height:auto">
						        <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-remove',plain:true" onclick="removeit()">強制退出比賽</a>
						        <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-save',plain:true" onclick="accept()">確認修改</a>
						        <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-undo',plain:true" onclick="reject()">取消修改</a>
								<a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-update',plain:true">重新排賽</a>
						    </div>
				        </div>
					</div>
		        </div>
		        <div title="玩家">
					<form name="form_player" class="easyui-form" data-options="novalidate:true">
						ID
			            <div style="margin-bottom:20px">
							ID
			            </div>
			        </form>
					<table class="easyui-datagrid" title="你的比賽" style="width:100%"
				            data-options="singleSelect:true,collapsible:true">
				        <thead>
				            <tr>
				                <th data-options="field:'contestId',width:80,align:'center'">比賽名稱</th>
								<th data-options="field:'pos',width:100,align:'center'">場</th>
								<th data-options="field:'left',width:100,align:'center'">左玩家</th>
				                <th data-options="field:'right',width:100,align:'center'">右玩家</th>
								<th data-options="field:'winner',width:100,align:'center'">勝利玩家</th>
				                <th data-options="field:'func',width:200,align:'center'">判定</th>
				            </tr>
				        </thead>
						<tbody>
							<tr>
								<td field="contestId">contestId</td>
								<td field="pos">pos</td>
								<td field="left">left</td>
								<td field="right">right</td>
								<td field="winner">winner</td>
								<td field="func">
									<a href="#" class="easyui-linkbutton" data-options="plain:true,iconCls:'icon-ok'">發佈勝利</a>
				        			<a href="#" class="easyui-linkbutton" data-options="plain:true,iconCls:'icon-cancel'">發佈失敗</a>
								</td>
							</tr>
						</tbody>
				    </table>
				</div>
				<div title="Help" data-options="iconCls:'icon-help',closable:true" style="padding:10px">
		            This is the help content.
		        </div>
		    </div>
        </div>
    </div>
</div>

	
		<link rel="stylesheet" type="text/css" href="../common/js/lib/jquery-easyui-1.4.3/themes/black/easyui.css">
		<link rel="stylesheet" type="text/css" href="../common/js/lib/jquery-easyui-1.4.3/themes/icon.css">
		<link rel="stylesheet" type="text/css" href="../common/css/normalize.css">
		<script type="text/javascript" src="../common/js/lib/jquery-easyui-1.4.3/jquery.min.js"></script>
		<script type="text/javascript" src="../common/js/lib/jquery-easyui-1.4.3/jquery.easyui.min.js"></script>
		<script type="text/javascript" src="../common/js/lib/jquery/jquery.tmpl.min.js"></script>
		<script name='editPeopleList' type="text/javascript">
	        var editIndex = undefined;
	        function endEditing(){
	            if (editIndex == undefined){return true}
	            if ($('#dg').datagrid('validateRow', editIndex)){
	                $('#dg').datagrid('endEdit', editIndex);
	                editIndex = undefined;
	                return true;
	            } else {
	                return false;
	            }
	        }
	        function onClickCell(index, field){
	            if (editIndex != index){
	                if (endEditing()){
	                    $('#dg').datagrid('selectRow', index)
	                            .datagrid('beginEdit', index);
	                    var ed = $('#dg').datagrid('getEditor', {index:index,field:field});
	                    if (ed){
	                        ($(ed.target).data('textbox') ? $(ed.target).textbox('textbox') : $(ed.target)).focus();
	                    }
	                    editIndex = index;
	                } else {
	                    setTimeout(function(){
	                        $('#dg').datagrid('selectRow', editIndex);
	                    },0);
	                }
	            }
	        }
	        function onEndEdit(index, row){
				/*
	            var ed = $(this).datagrid('getEditor', {
	                index: index,
	                field: 'productid'
	            });
	            row.productname = $(ed.target).combobox('getText');
				*/
	        }
	        function append(){
	            if (endEditing()){
	                $('#dg').datagrid('appendRow',{status:'P'});
	                editIndex = $('#dg').datagrid('getRows').length-1;
	                $('#dg').datagrid('selectRow', editIndex)
	                        .datagrid('beginEdit', editIndex);
	            }
	        }
	        function removeit(){
				$.messager.confirm('系統', '確定要退出?', function(r){
	                if(r){
						if (editIndex == undefined){return}
			            $('#dg').datagrid('cancelEdit', editIndex)
			                    .datagrid('deleteRow', editIndex);
			            editIndex = undefined;
	                }else{
						
					}
	            });
	        }
	        function accept(){
	            if (endEditing()){
	                $('#dg').datagrid('acceptChanges');
	            }
	        }
	        function reject(){
	            $('#dg').datagrid('rejectChanges');
	            editIndex = undefined;
	        }
	        function getChanges(){
	            var rows = $('#dg').datagrid('getChanges');
	            alert(rows.length+' rows are changed!');
	        }
	    </script>
		
		
		<script src='../common/js/lib/jit-yc.js'></script>
		
		<script>
var model = {};
(function(module){
	
	var ctx = null
	function loadContext(cb){
		$.ajax({
			url: '../fn/contestsys/',
			dataType:'json',
			success: (info)=>{
				if(info.Error != null){
					cb(info.Error)
				}else{
					ctx = info.Info
					cb(null, info.Info)
				}
			},
			error: (xhr, res, err)=>{
				cb(err)
			}
		})
	}
	function getCurrentContext(){
		return ctx
	}
	
	var id = null
	function setId(fbid){
		id = fbid
	}
	
	function updateContest(contestId, info, cb){
		$.ajax({
			url: '../fn/contestsys/UpdateContest/'+contestId+'/'+id,
			dataType:'json',
			data: info,
			success: (info)=>{
				if(info.Error != null){
					cb(info.Error)
				}else{
					cb(null, info.Info)
				}
			},
			error: (xhr, res, err)=>{
				cb(err)
			}
		})
	}
	
	function newContest(cb){
		$.ajax({
			url: '../fn/contestsys/CreateContest/'+id,
			dataType:'json',
			success: (info)=>{
				if(info.Error != null){
					cb(info.Error)
				}else{
					cb(null, info.Info)
				}
			},
			error: (xhr, res, err)=>{
				cb(err)
			}
		})
	}
	
	function deleteContest(contestId, cb){
		$.ajax({
			url: '../fn/contestsys/DeleteContest/'+contestId+'/'+id,
			dataType:'json',
			success: (info)=>{
				if(info.Error != null){
					cb(info.Error)
				}else{
					cb(null, info.Info)
				}
			},
			error: (xhr, res, err)=>{
				cb(err)
			}
		})
	}
	
	function upgradeContest(contestId, cb){
		$.ajax({
			url: '../fn/contestsys/UpgradeContest/'+contestId+'/'+id,
			dataType:'json',
			success: (info)=>{
				if(info.Error != null){
					cb(info.Error)
				}else{
					cb(null, info.Info)
				}
			},
			error: (xhr, res, err)=>{
				cb(err)
			}
		})
	}
	
	function joinContest(contestId, info, cb){
		$.ajax({
			url: '../fn/contestsys/JoinContest/'+contestId+'/'+id,
			dataType:'json',
			data: info,
			success: (info)=>{
				if(info.Error != null){
					cb(info.Error)
				}else{
					cb(null, info.Info)
				}
			},
			error: (xhr, res, err)=>{
				cb(err)
			}
		})
	}
	
	function leaveContest(contestId, info, cb){
		$.ajax({
			url: '../fn/contestsys/LeaveContest/'+contestId+'/'+id,
			dataType:'json',
			data: info,
			success: (info)=>{
				if(info.Error != null){
					cb(info.Error)
				}else{
					cb(null, info.Info)
				}
			},
			error: (xhr, res, err)=>{
				cb(err)
			}
		})
	}
	
	
	var currentContestId = null
	function setCurrentContestId(id){
		currentContestId = id
	}
	function getCurrentContestId(){
		return currentContestId
	}
	
	module.loadContext = loadContext
	module.getCurrentContext = getCurrentContext
	module.setCurrentContestId = setCurrentContestId
	module.getCurrentContestId = getCurrentContestId
	module.updateContest = updateContest
	module.newContest = newContest
	module.deleteContest = deleteContest
	module.upgradeContest = upgradeContest
	module.joinContest = joinContest
	module.leaveContest = leaveContest
	module.setId = setId
})(model)

var view = {};
(function(module){
	
	function updateContestListView(ctx){
		var root = []
		for(var k in ctx.ContestSys.Contests){
			var contest = ctx.ContestSys.Contests[k]
			var sub = []
			for(var j in contest.Peoples){
				var p = contest.Peoples[j]
				var subNode = {
					id: p.ID,
					text: p.Name+"("+p.ID+")",
					belongContest: contest.ID,
					isContest: false,
				}
				sub.push(subNode)
			}
			var node = {
				id: contest.ID,
				text: contest.Name+"("+contest.ID+")",
				children: sub,
				isContest: true,
			}
			root.push(node)
		}
		$('#gameTree').tree({data: root})
	}
	
	function updateContestDetailView(ctx, contestId){
		var contest = ctx.ContestSys.Contests[contestId]
		var d = new Date(contest.StartTime)
		var timeStr = (d.getUTCDay()+1)+"/"+(d.getUTCMonth()+1)+"/"+d.getUTCFullYear()
		$(document.form_contest).form('load',{
	        name:contest.Name,
	        description:contest.Description,
			game:contest.Game,
			startTime:timeStr,
			state:contest.State+"",
			pwd:contest.Password
	    });
	}
	
	function getContestDetail(){
		var game = document.form_contest.game.value
		var name = document.form_contest.name.value
		var description = document.form_contest.description.value
		var startTime = new Date(document.form_contest.startTime.value).getTime()
		var pwd = document.form_contest.pwd.value
		var value = {
			game: game,
			name: name,
			description: description,
			startTime: startTime,
			pwd: pwd
		}
		console.log(value)
		return value
	}
	
	function updateContestPeopleListView(ctx, contestId){
		var contest = ctx.ContestSys.Contests[contestId]
		var rows = []
		for(var k in contest.Peoples){
			var p = contest.Peoples[k]
			var node = {
				ID: p.ID,
				Name: p.Name,
				Power: 0
			}
			rows.push(node)
		}
		var json = {
			total: rows.length,
			rows: rows
		}
		$('#dg').datagrid({data: json})
	}
	
	var st = new $jit.RGraph({  
	    //Where to append the visualization  
	    injectInto: 'infovis',  
		duration: 100, 
	    //Optional: create a background canvas that plots  
	    //concentric circles.  
	    background: {  
	      CanvasStyles: {  
	        strokeStyle: '#555'  
	      }  
	    },  
	    //Add navigation capabilities:  
	    //zooming by scrolling and panning.  
	    Navigation: {  
	      enable: true,  
	      panning: true,  
	      zooming: 10  
	    },  
	    //Set Node and Edge styles.  
	    Node: {  
	        color: '#ddeeff'  
	    },  
	      
	    Edge: {  
	      color: '#C17878',  
	      lineWidth:1.5  
	    },  
	  
	    onBeforeCompute: function(node){  
		
	    },  
	      
	    //Add the name of the node in the correponding label  
	    //and a click handler to move the graph.  
	    //This method is called once, on label creation.  
	    onCreateLabel: function(domElement, node){  
	        domElement.innerHTML = node.name;  
	        domElement.onclick = function(){  
	            st.onClick(node.id, {  
	                onComplete: function() {
						
	                }  
	            });  
	        };  
	    },  
	    //Change some label dom properties.  
	    //This method is called each time a label is plotted.  
	    onPlaceLabel: function(domElement, node){  
	        var style = domElement.style;  
	        style.display = '';  
	        style.cursor = 'pointer';  
	  
	        if (node._depth <= 1) {  
	            style.fontSize = "0.8em";  
	            style.color = "#ccc";  
	          
	        } else if(node._depth == 2){  
	            style.fontSize = "0.7em";  
	            style.color = "#494949";  
	          
	        } else {  
	            style.display = 'none';  
	        }  
	  
	        var left = parseInt(style.left);  
	        var w = domElement.offsetWidth;  
	        style.left = (left - w / 2) + 'px';  
	    }  
	});  
	
	function updateContestFlowView(ctx, contestId, pos){
		var list = ctx.DualSys.Duals.filter(data=>data.Contest == contestId)
		if(list.length == 0){
			return
		}
		var nodes = {}
		var getNode = (id)=>{
			if(nodes[id] != null){
				return nodes[id]
			}
			var node = {
				id: id,
				name: id,
				data: {},
				children: []
			}
			nodes[node.id] = node
			return node
		}
		var newList = list.reduce((acc, data)=>{
			var node = getNode(data.ID)
			if(data.Left != ""){
				node.children.push(getNode(data.Left))
			}
			if(data.Right != ""){
				node.children.push(getNode(data.Right))
			}
			acc.push(node)
			return acc
		}, [])

		var root = newList[newList.length-1]
		//load JSON data  
		st.loadJSON(root);  
		//trigger small animation  
		st.graph.eachNode(function(n) {  
		  var pos = n.getPos();  
		  pos.setc(-200, -200);  
		});  
		st.compute('end');  
		st.fx.animate({  
		  modes:['polar'],  
		  duration: 2000  
		});
		if(!!pos){
			st.onClick(pos, 'animate')
		}else{
			st.onClick(st.root); 
		}
	}
	
	function alert(type, msg){
		$.messager.alert('系統',msg,type);
	}
	
	function confirm(msg, cb){
		$.messager.confirm('系統', msg, cb);
	}
	
	function getJoinInfo(){
		var name = document.form_peopleJoin.name.value
		var pwd = document.form_peopleJoin.pwd.value
		return {
			name: name,
			pwd: pwd
		}
	}
	module.updateContestListView = updateContestListView
	module.updateContestDetailView = updateContestDetailView
	module.updateContestPeopleListView = updateContestPeopleListView
	module.getContestDetail = getContestDetail
	module.updateContestFlowView = updateContestFlowView
	module.alert = alert
	module.confirm = confirm
	module.getJoinInfo = getJoinInfo
})(view)
		</script>
		<script>
			function onClickGameTree(node){
				var contestId = node.isContest ? node.id : node.belongContest
				model.setCurrentContestId(contestId)
				view.updateContestDetailView(model.getCurrentContext(), contestId)
				view.updateContestPeopleListView(model.getCurrentContext(), contestId)
				
				if(node.isContest == true){
					view.updateContestFlowView(model.getCurrentContext(), contestId)
				}else{
					var people = model.getCurrentContext().ContestSys.Contests[contestId].Peoples[node.id]
					console.log(people)
					view.updateContestFlowView(model.getCurrentContext(), contestId, people.Pos)
				}
				
			}
			
			function onClick(cmd){
				console.log(cmd)
				if(cmd == 'newContest'){
					model.newContest((err, info)=>{
						if(err!=null){
							view.alert('error', err)
						}else{
							var contestId = info
							model.setCurrentContestId(contestId)
							updateView()
						}
					})
				}
				
				if(cmd == 'removeContest'){
					var contestId = model.getCurrentContestId()
					if(contestId == null){
						view.alert('info', "請選擇比賽")
						return
					}
					view.confirm('是否刪除'+contestId, ok=>{
						if(ok){
							model.deleteContest(contestId, (err, info)=>{
								if(err!=null){
									view.alert('error', err)
								}else{
									updateView()
								}
							})
						}
					})
				}
				
				if(cmd == 'updateContest'){
					var data = view.getContestDetail()
					model.updateContest(model.getCurrentContestId(), data, (err, info)=>{
						if(err!=null){
							view.alert('error', err)
						}else{
							updateView()
						}
					})
				}
				
				if(cmd == 'commitContest'){
					model.upgradeContest(model.getCurrentContestId(), (err, info)=>{
						if(err!=null){
							view.alert('error', err)
						}else{
							updateView()
						}
					})
				}
				
				if(cmd == 'joinContest'){
					var joinInfo = view.getJoinInfo()
					model.joinContest(model.getCurrentContestId(), joinInfo, (err, info)=>{
						if(err!=null){
							view.alert('error', err)
						}else{
							updateView()
						}
					})
				}
				
				if(cmd == 'leaveContest'){
					model.leaveContest(model.getCurrentContestId(), (err, info)=>{
						if(err!=null){
							view.alert('error', err)
						}else{
							updateView()
						}
					})
				}
			}
			
			function updateView(){
				model.loadContext((err, info)=>{
					if(err != null){
						view.alert('error', err)
					}else{
						view.updateContestListView(info)
						view.updateContestDetailView(info, model.getCurrentContestId())
						view.updateContestPeopleListView(info, model.getCurrentContestId())
						view.updateContestFlowView(info, model.getCurrentContestId())
					}
				})
			}
			
			function init(){
				model.setId('han')
				updateView()
			}
			
			init()
		</script>
<!--                   EASY UI END                           -->


	</body>
</html>