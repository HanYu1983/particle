<html>
	<head>
		<meta charset="utf-8"/>
	</head>
	<body>
<div style="width:100%;height:100%;">
	<div class="easyui-layout" style="width:100%;height:100%;">
        <div data-options="region:'west',split:true" title="比賽" style="width:200px;">
			<div class="easyui-accordion" data-options="fit:true,border:false" style='overflow: auto;'>
                <ul class="easyui-tree" id="gameTree" data-options="onClick: onClickGameTree">
		        </ul>
            </div>
		</div>
        <div data-options="region:'center'">
            <div id="tab_main" class="easyui-tabs" style='height:100%'>
				<div title="玩家">
					<form name="form_player" class="easyui-form" data-options="novalidate:true">
						<div style="margin-bottom:20px">
							ID<input class="easyui-textbox" name="id" disabled>
			            </div>
						<div style="margin-bottom:20px">
							<fb:login-button scope="public_profile,email" onlogin="onClick('login')"></fb:login-button>
			            </div>
					</form>
					
					<form name="form_winner" class="easyui-form" data-options="novalidate:true">
						場次
			            <div style="margin-bottom:20px">
							<input class="easyui-textbox" name="pos" disabled>
							<a href="#" class="easyui-linkbutton" data-options="plain:true,iconCls:'icon-ok'" onclick="onClick('commitWinner')">發佈勝利</a>
					        <a href="#" class="easyui-linkbutton" data-options="plain:true,iconCls:'icon-cancel'" onclick="onClick('commitFail')">發佈失敗</a>
				            <a href="#" class="easyui-linkbutton" data-options="plain:true" onclick="onClick('cancelWinner')">取消發佈</a>
							<a href="#" class="easyui-linkbutton" data-options="plain:true" onclick="onClick('upgrade')">升格</a>
						</div>
					</form>
					
					<table id='dg_duals' class="easyui-datagrid" title="你的比賽" style="width:100%"
				            data-options="singleSelect:true,collapsible:true,onClickRow:onClickDualsRow">
				        <thead>
				            <tr>
				                <th data-options="field:'contestName',width:80,align:'center'">比賽名稱</th>
								<th data-options="field:'pos',width:100,align:'center'">場次</th>
								<th data-options="field:'left',width:100,align:'center'">左玩家</th>
				                <th data-options="field:'right',width:100,align:'center'">右玩家</th>
								<th data-options="field:'winner',width:100,align:'center'">勝利玩家</th>
				            </tr>
				        </thead>
				    </table>
				</div>
				
		        <div title="新增/修改比賽">
					<div class="easyui-panel">
						<form name="form_peopleJoin" class="easyui-form">
							參加碼<input name="pwd" type="password" class="easyui-textbox">
							小名<input class="easyui-textbox" name="name" style="width:100px">
							<a href="#" class="easyui-linkbutton" data-options="plain:false" onclick="onClick('joinContest')">參加比賽</a>
							<a href="#" class="easyui-linkbutton" data-options="plain:false" onclick="onClick('leaveContest')">退出比賽</a>
						</form>
					</div>
					<div class="easyui-panel">
						<a href="#" class="easyui-linkbutton" data-options="plain:true,iconCls:'icon-add'" onclick="onClick('newContest')">新增草搞</a>
				        <a href="#" class="easyui-linkbutton" data-options="plain:true,iconCls:'icon-remove'" onclick="onClick('removeContest')">刪除</a>
						<a href="#" class="easyui-linkbutton" data-options="plain:true,iconCls:'icon-edit'" onclick="onClick('updateContest')">修改</a>
						<a href="#" class="easyui-linkbutton" data-options="plain:true,iconCls:'icon-ok'" onclick="onClick('commitContest')">草搞>公佈>開始>結束</a>
				    </div>
					<form name="form_contest" class="easyui-form" data-options="novalidate:true">
						狀態
						<div style="margin-bottom:20px">
			                <select class="easyui-combobox" name="state" disabled style="width:100%">
				                <option value="0">草搞</option>
				                <option value="1">公佈</option>
								<option value="2">開始</option>
								<option value="3">結束</option>
							</select>
			            </div>
						遊戲
						<div style="margin-bottom:20px">
			                <select class="easyui-combobox" name="game">
				                <option value="sengoku">戰國大戰</option>
				                <option value="sengo">三國大戰</option>
								<option value="gundamWarN">鋼彈大戰NexA</option>
								<option value="gundamWar">鋼彈大戰</option>
							</select>
			            </div>
						名稱
			            <div style="margin-bottom:20px">
			                <input class="easyui-textbox" name="name" style="width:100%">
			            </div>
						描述
			            <div style="margin-bottom:20px">
							<textarea rows="4" cols="50" name="description">description</textarea>
			            </div>
						參加碼
						<div style="margin-bottom:20px">
							<input name="pwd" type="password" class="easyui-textbox">
				        </div>
						報名截止
						<div style="margin-bottom:20px">
				            <input class="easyui-datebox" name="startTime">
				        </div>
						管理者
						<div style="margin-bottom:20px">
			                <input class="easyui-textbox" name="owner" style="width:100%" disabled>
			            </div>
			        </form>
		        </div>
		        <div title="賽程管理">
					<div class="easyui-accordion" data-options="multiple:true" style="width:100%;">
						<div title="賽程" style='height:300px'>
				            <div id='infovis' style='width:100%; height:300px'></div>
				        </div>
				        <div title="玩家" data-options="selected:true">
							<form name="form_peoplePower" class="easyui-form">
								ID<input class="easyui-textbox" name="id" style="width:100px" disabled>
								種子選手<input name="power" class="easyui-textbox">
								<a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-save',plain:true" onclick="onClick('confirmDualPower')">確認修改</a>
								<a href="javascript:void(0)" class="easyui-linkbutton" data-options="plain:true" onclick="onClick('prepareDual')">重新排賽</a>
								<a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-remove',plain:true" onclick="onClick('kickPeople')">強制退出比賽</a>
							</form>
							
				            <table id="dg_people" class="easyui-datagrid" style='width:100%'
						            data-options="
						                iconCls: 'icon-edit',
						                singleSelect: true,
						                onClickRow: onClickPeopleRow
						            ">
						        <thead>
						            <tr>
						                <th data-options="field:'ID',width:80,align:'center'">ID</th>
						                <th data-options="field:'Name',width:100,align:'center'">小名</th>
						                <th data-options="field:'Power',width:80,align:'center'">種子選手</th>
						            </tr>
						        </thead>
						    </table>
				        </div>
					</div>
		        </div>
		        
				<div title="Help" data-options="iconCls:'icon-help',closable:true" style="padding:10px">
		            This is the help content.
		        </div>
		    </div>
        </div>
    </div>
</div>

	
		<link rel="stylesheet" type="text/css" href="../common/js/lib/jquery-easyui-1.4.3/themes/black/easyui.css">
		<link rel="stylesheet" type="text/css" href="../common/js/lib/jquery-easyui-1.4.3/themes/icon.css">
		<link rel="stylesheet" type="text/css" href="../common/css/normalize.css">
		<script type="text/javascript" src="../common/js/lib/jquery-easyui-1.4.3/jquery.min.js"></script>
		<script type="text/javascript" src="../common/js/lib/jquery-easyui-1.4.3/jquery.easyui.min.js"></script>
		<script type="text/javascript" src="../common/js/lib/jquery/jquery.tmpl.min.js"></script>
		<script src='../common/js/lib/jit-yc.js'></script>
		<script src='js/fb.js'></script>
		<script src='js/model.js'></script>
		<script src='js/view.js'></script>
		<script>
			function onClickGameTree(node){
				var isGroup = node.isGroup
				if(isGroup){
					return
				}
				var contestId = node.isContest ? node.id : node.belongContest
				model.setCurrentContestId(contestId)
				view.updateContestDetailView(model.getCurrentContext(), contestId)
				view.updateContestPeopleListView(model.getCurrentContext(), contestId)
				
				if(node.isContest == true){
					view.updateContestFlowView(model.getCurrentContext(), contestId)
					view.selectMainTab(1)
				}else{
					var people = model.getCurrentContext().ContestSys.Contests[contestId].Peoples[node.id]
					model.setCurrentPeopleId(people.ID)
					
					view.updateContestFlowView(model.getCurrentContext(), contestId, people.Pos)
					view.selectMainTab(2)
					view.selectPeople(model.getCurrentContext(), contestId, people.ID)
					view.updatePeoplePowerForm(model.getCurrentContext(), contestId, people.ID)
				}
			}
			
			function onClickDualsRow(idx, row){
				var pos = row.pos
				var contest = row.contestId
				model.setCurrentContestId(contest)
				model.setCurrentPos(pos)
				view.updateWinnerForm(model.getCurrentContext(), pos)
			}
			
			function onClickPeopleRow(idx, row){
				var peopleId = row.ID
				model.setCurrentPeopleId(peopleId)
				view.updatePeoplePowerForm(model.getCurrentContext(), model.getCurrentContestId(), peopleId)
			}
			
			function onClick(cmd){
				console.log(cmd)
				if(cmd == 'login'){
					fb.checkLoginState()
				}
				
				if(cmd == 'newContest'){
					model.newContest((err, info)=>{
						if(err!=null){
							view.alert('error', err)
						}else{
							var contestId = info
							model.setCurrentContestId(contestId)
							updateView()
						}
					})
				}
				
				if(cmd == 'removeContest'){
					var contestId = model.getCurrentContestId()
					if(contestId == null){
						view.alert('info', "請選擇比賽")
						return
					}
					view.confirm('是否刪除'+contestId, ok=>{
						if(ok){
							model.deleteContest(contestId, (err, info)=>{
								if(err!=null){
									view.alert('error', err)
								}else{
									updateView()
								}
							})
						}
					})
				}
				
				if(cmd == 'updateContest'){
					var data = view.getContestDetail()
					model.updateContest(model.getCurrentContestId(), data, (err, info)=>{
						if(err!=null){
							view.alert('error', err)
						}else{
							updateView()
						}
					})
				}
				
				if(cmd == 'commitContest'){
					var contestId = model.getCurrentContestId()
					if(contestId == null){
						return
					}
					view.confirm('是否升格:'+contestId, ok=>{
						if(ok){
							model.upgradeContest(contestId, (err, info)=>{
								if(err!=null){
									view.alert('error', err)
								}else{
									updateView()
								}
							})
						}
					})
				}
				
				if(cmd == 'joinContest'){
					var joinInfo = view.getJoinInfo()
					if(joinInfo.name.trim() == ""){
						joinInfo.name = model.getCurrentName()
					}
					model.joinContest(model.getCurrentContestId(), joinInfo, (err, info)=>{
						if(err!=null){
							view.alert('error', err)
						}else{
							updateView()
						}
					})
				}
				
				if(cmd == 'leaveContest'){
					model.leaveContest(model.getCurrentContestId(), model.getId(), (err, info)=>{
						if(err!=null){
							view.alert('error', err)
						}else{
							updateView()
						}
					})
				}
				
				if(cmd == 'kickPeople'){
					var people = model.getCurrentPeopleId()
					if(people == null){
						view.alert('請選擇一位玩家')
						return
					}
					view.confirm('是否強制退出:'+model.getCurrentPeopleId(), ok=>{
						if(ok){
							model.leaveContest(model.getCurrentContestId(), people, (err, info)=>{
								if(err!=null){
									view.alert('error', err)
								}else{
									onClick('prepareDual')
								}
							})
						}
					})
				}
				
				if(cmd == 'prepareDual'){
					model.prepareDual(model.getCurrentContestId(), (err, info)=>{
						if(err!=null){
							view.alert('error', err)
						}else{
							updateView()
						}
					})
				}
				
				if(cmd == 'confirmDualPower'){
					var value = view.getPeoplePowerFormValue()
					model.updatePower(model.getCurrentContestId(), value.id, value.power, (err, info)=>{
						if(err!=null){
							view.alert('error', err)
						}else{
							onClick('prepareDual')
						}
					})
				}
				
				if(cmd == 'upgrade'){
					model.upgrade(model.getCurrentContestId(), model.getId(), (err, info)=>{
						if(err!=null){
							view.alert('error', err)
						}else{
							updateView()
						}
					})
				}
				
				if(cmd == 'cancelWinner'){
					var contest = model.getCurrentContestId()
					if(contest == null){
						console.log('no contest')
						return
					}
					model.cancelWinner(contest, (err, info)=>{
						if(err!=null){
							view.alert('error', err)
						}else{
							updateView()
						}
					})
				}
				
				if(cmd == 'commitWinner'){
					var contest = model.getCurrentContestId()
					if(contest == null){
						console.log('no contest')
						return
					}
					model.confirmWinner(contest, model.getId(), (err, info)=>{
						if(err!=null){
							view.alert('error', err)
						}else{
							updateView()
						}
					})
				}
				
				if(cmd == 'commitFail'){
					var contestId = model.getCurrentContestId()
					if(contestId == null){
						console.log('no contestId')
						return
					}
					var ctx = model.getCurrentContext()
					var contest = ctx.ContestSys.Contests[contestId]
					if((!!contest) == false){
						console.log('no contest')
						return
					}
					var pos = model.getCurrentPos()
					if(pos == null){
						console.log('no pos')
						return
					}
					var dual = ctx.DualSys.Duals.find(d=>d.ID == pos)
					if(dual == null){
						console.log('no dual')
						return
					}
					var peopleLeft = ""
					var peopleRight = ""
					for(var k in contest.Peoples){
						var p = contest.Peoples[k]
						if(p.Pos == dual.Left){
							peopleLeft = p.ID
						}
						if(p.Pos == dual.Right){
							peopleRight = p.ID
						}
					}
					var other = peopleLeft == model.getId() ? peopleRight : peopleLeft
					model.confirmWinner(contest.ID, other, (err, info)=>{
						if(err!=null){
							view.alert('error', err)
						}else{
							updateView()
						}
					})
				}
			}
			
			function updateView(){
				model.loadContext((err, info)=>{
					if(err != null){
						view.alert('error', err)
					}else{
						view.updateContestListView(info, model.getId())
						view.updateContestDetailView(info, model.getCurrentContestId())
						view.updateContestPeopleListView(info, model.getCurrentContestId())
						view.updateContestFlowView(info, model.getCurrentContestId())
						view.updatePeoplePowerForm(model.getCurrentContext(), model.getCurrentContestId(), model.getCurrentPeopleId())
						
						model.getDuals((err,duals)=>{
							if(err != null){
								view.alert('error', err)
							}else{
								view.updateDualsListView(info, model.getId(), duals)
							}
						})
					}
				})
			}
			function init(){
				fb.init((err, res)=>{
					if(err != null){
						view.alert('login err')
					}else{
						var fbId = res.userID
						model.setId(fbId)
						
						
						$(document.form_player).form('load', {
							id: fbId
						})
						updateView()
						
						
						fb.me((err, res)=>{
							var name = res.name
							model.setCurrentName(name)
						})
					}
				})
			}
			init()
		</script>


	</body>
</html>