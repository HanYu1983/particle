<meta charset="utf-8"/>
<html>
    <head>
        <script
            src="https://code.jquery.com/jquery-3.4.0.min.js"
            integrity="sha256-BJeo0qm959uMBGb65z40ejJYGSgR7REI4+CW1fNKwOg="
            crossorigin="anonymous"></script>
		<script src='../common/js/lib/async/async.js'></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/async/2.6.2/async.min.js"></script>
		<script src="https://unpkg.com/rxjs/bundles/rxjs.umd.min.js"></script>
		<script src="js/api.js"></script>
		<script src="https://www.chartjs.org/dist/2.8.0/Chart.min.js"></script>
		<script src='https://www.chartjs.org/samples/latest/utils.js'></script>
    </head>
    <body>
				<div style="width:75%;">
						<canvas id="canvas"></canvas>
				</div>
    </body>
    <script>

		function getColor(index){
			var colorstr = ['red', 'orange', 'yellow', 'green', 'blue', 'purple', 'grey'];
			index = index % colorstr.length;
			return window.chartColors[colorstr[index]];
		}

		function getTotalFromEarn(earn){
			var list = earn[1];
			var total = 0;
			for( var i = 0; i < list.length; ++i){
				total += list[i].money;
			}
			return total;
		}

		function getEarnConfig(data){
			console.log(data)

			var maxEarn = 0;
			for( var k in data){
				var name = k;
				var earn = data[k];
				maxEarn = Math.max(earn.length, maxEarn);
			}

			var day = []
			for( var i = 0; i < maxEarn; ++i){
				day.push(i);
			}

			var datasets = [];
			var colorId = 0;
			for( var k in data){
				var earn = data[k];
				var setData = [];
				for( var i = 0; i < maxEarn; ++i){
					if( i < earn.length){
						setData.push(getTotalFromEarn(earn[i]));
					}else{
						setData.push(0);
					}
				}
				var useColor = getColor(colorId++);
				var set = {
					label: k,
					backgroundColor: useColor,
					borderColor: useColor,
					data: setData,
					fill: false,
				};
				datasets.push( set );
			}


			var config = {
				type: 'line',
				data: {
					labels: day,
					datasets: datasets
				},
				options: {
					responsive: true,
					title: {
						display: true,
						text: '總收入圖表'
					},
					tooltips: {
						mode: 'index',
						intersect: false,
					},
					hover: {
						mode: 'nearest',
						intersect: true
					},
					scales: {
						xAxes: [{
							display: true,
							scaleLabel: {
								display: true,
								labelString: 'Month'
							}
						}],
						yAxes: [{
							display: true,
							scaleLabel: {
								display: true,
								labelString: 'Value'
							}
						}]
					}
				}
			};
			return config;
		}

		async.parallel({
			one: function(callback) {
					window.onload = function() {
						callback(null);
					};
			},
			two: function(callback) {
				queryData(function(infos){
					callback(null, infos);
				});
			}
		}, function(err, results) {
			var data = results.two;
			var config = getEarnConfig(data);
			var ctx = document.getElementById('canvas').getContext('2d');
			window.myLine = new Chart(ctx, config);
		});

		function queryData(  callback ){
			api.earnsDetail((err, data)=>{
				var boothStates = data.boothStates;
				var earns = data.earns;
				var ret = api.groupEarns(boothStates, earns);
				callback(ret)
			})
		}
    </script>
</html>