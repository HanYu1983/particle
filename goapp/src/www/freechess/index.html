<html>

<head>
	<meta charset="utf-8" />
	<link rel="stylesheet" type="text/css" href="../common/js/lib/jquery-easyui-1.4.3/themes/black/easyui.css">
	<link rel="stylesheet" type="text/css" href="../common/js/lib/jquery-easyui-1.4.3/themes/icon.css">
	<link rel="stylesheet" type="text/css" href="../common/css/normalize.css">
	<link rel="stylesheet" type="text/css" href="../common/css/vic.css">

	<script type="text/javascript" src="../common/js/lib/rectSelect/rectSelect.js"></script>
	<link rel="stylesheet" type="text/css" href="../common/js/lib/rectSelect/rectSelect.css">


	<script type="text/javascript" src="../common/js/lib/underscore/underscore-min.js"></script>
	<script type="text/javascript" src="../common/js/lib/jquery-easyui-1.4.3/jquery.min.js"></script>
	<script type="text/javascript" src="../common/js/lib/jquery-easyui-1.4.3/jquery.easyui.min.js"></script>
	<script type="text/javascript" src="../common/js/lib/jquery/jquery.cookie.js"></script>
	<script type="text/javascript" src="../common/js/lib/jquery/jquery.tmpl.min.js"></script>
	<script src="https://www.gstatic.com/firebasejs/4.12.1/firebase.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/node-uuid/1.4.8/uuid.min.js"></script>
	<script src="js/api.js"></script>
	<script src="js/ooxx.js"></script>

	<!-- firebase -->
	<script src="https://www.gstatic.com/firebasejs/4.12.1/firebase.js"></script>
	<script type="text/javascript" src="../common/js/lib/leo.utils.js"></script>
	<script src="../common/js/admin.js"></script>
	<script>admin.init()</script>
</head>
<style>
	body {
		background-color: #333333;
	}
</style>
<script id="tmpl_ooxxContent" type="jquery-x-tmpl">
		<div class="abs pivot" style="left:50%; top:50%;">
			<img id="table" class="rel" style="left:-256px; top:-256px" src="imgs\ooxx\table.png">
		</div>
		<div class="oo abs pivot lock" >
			<img class="rel" style="left:-256px; top:-256px" src="imgs\ooxx\o.png">
		</div>
		<div class="oo abs pivot lock" >
			<img class="rel" style="left:-256px; top:-256px" src="imgs\ooxx\o.png">
		</div>
		<div class="oo abs pivot lock" >
			<img class="rel" style="left:-256px; top:-256px" src="imgs\ooxx\o.png">
		</div>
		<div class="oo abs pivot lock" >
			<img class="rel" style="left:-256px; top:-256px" src="imgs\ooxx\o.png">
		</div>
		<div class="oo abs pivot lock" >
			<img class="rel" style="left:-256px; top:-256px" src="imgs\ooxx\o.png">
		</div>
		<div class="xx abs pivot lock" >
			<img class="rel" style="left:-256px; top:-256px" src="imgs\ooxx\x.png">
		</div>
		<div class="xx abs pivot lock" >
			<img class="rel" style="left:-256px; top:-256px" src="imgs\ooxx\x.png">
		</div>
		<div class="xx abs pivot lock" >
			<img class="rel" style="left:-256px; top:-256px" src="imgs\ooxx\x.png">
		</div>
		<div class="xx abs pivot lock" >
			<img class="rel" style="left:-256px; top:-256px" src="imgs\ooxx\x.png">
		</div>
		<div id="selection" class="abs pivot lock" >
			<img class="rel" style="left:-256px; top:-256px" src="imgs\ooxx\selection.png">
		</div>
	</script>
<script id="tmpl_singleIconData" type="jquery-x-tmpl">
		<div class="group singleIconData">
			<div class="hori">
				<a buttonid=${buttonId} href="#" class="easyui-linkbutton" style="width:60px;  " data-options="iconCls:'icon-add', disabled:false">生成</a>
			</div>
			<div class="hori">
				<input value=${content} class="easyui-textbox" style="width:130px;" />
			</div>
			<div class="hori">
				<img class="img_token" style="position:relative; top:7px; left:0; height:20px;" src=${tokenPath} />
			</div>
		</div>
	</script>
<style>
	.gameView {
		width: 100%;
		height: 100%;
		transition: .3s ease-in-out;
		overflow: hidden;
	}

	.gameUILayer {}

	.scaleBig {
		transform: scale(1);
	}

	.scaleSmall {
		transform: scale(.5);
	}
</style>

<body>
	<div class="easyui-panel group center left top" style="padding:5px;">
		<select id="combo_type" class="easyui-combobox" name="state" label="State:" labelPosition="top" style="">
			<option value="ooxx">井字遊戲</option>
			<option value="a">五子棋</option>
			<option value="b">中國象棋</option>
		</select>
		<a id="btn_createRoom" class="easyui-linkbutton" data-options="disabled:false">創房</a>
		<a id="btn_refreshRoom" class="easyui-linkbutton" data-options="disabled:false">隨機房</a>
	</div>
	<div class="group full">
		<div class="rel full left top">
			<div id="gameContent1" style="transform-origin: left top; background-color: darkred"
				class="rel left top gameView">

			</div>
			<div id="gameContent2" style="transform-origin: right top; background-color: darkgreen"
				class="abs right top gameView">

			</div>
			<div id="gameContent3" style="transform-origin: left bottom; background-color: darkgoldenrod"
				class="abs left top gameView">

			</div>
			<div id="gameContent4" style="transform-origin: right bottom; background-color: darkblue"
				class="abs left top gameView">

			</div>
			<div id="bigUIContainer" class="abs" style="padding:5px; left:0; top:0;">
				<a class="easyui-linkbutton">對奕</a>
				<a class="easyui-linkbutton">觀戰</a>
				<a id="btn_scaleSmall" class="easyui-linkbutton">縮小</a>
			</div>
		</div>
		<div tableSamllUiID="1" class="abs gameUILayer" style="left:0; top:0;">
			<div class="rel" style="padding:5px; left:0; top:0;">
				<a class="easyui-linkbutton">對奕</a>
				<a class="easyui-linkbutton">觀戰</a>
				<a class="easyui-linkbutton">放大</a>
			</div>
		</div>
		<div tableSamllUiID="2" class="abs gameUILayer" style="left:50%; top:0;">
			<div class="rel" style="padding:5px; left:0; top:0;">
				<a class="easyui-linkbutton">對奕</a>
				<a class="easyui-linkbutton">觀戰</a>
				<a class="easyui-linkbutton">放大</a>
			</div>
		</div>
		<div tableSamllUiID="3" class="abs gameUILayer" style="left:0; top:50%;">
			<div class="rel" style="padding:5px; left:0; top:0;">
				<a class="easyui-linkbutton">對奕</a>
				<a class="easyui-linkbutton">觀戰</a>
				<a class="easyui-linkbutton">放大</a>
			</div>
		</div>
		<div tableSamllUiID="4" class="abs gameUILayer" style="left:50%; top:50%;">
			<div class="rel" style="padding:5px; left:0; top:0;">
				<a class="easyui-linkbutton">對奕</a>
				<a class="easyui-linkbutton">觀戰</a>
				<a class="easyui-linkbutton">放大</a>
			</div>
		</div>
	</div>

</body>
<script>

	function log(title, msg) {
		console.log("====[" + title + "]====");
		console.log(msg);
		console.log("=======================");
	}

	$(document).ready(function () {

		function smallTable(table) {
			bigUIContainer.hide();
			smallUIContainer.show();

			_.each(ary_table, function (t) {
				t.show();
			});
			table.removeClass("scaleBig").addClass("scaleSmall");
		}

		function bigTable(table) {
			bigUIContainer.show();
			smallUIContainer.hide();

			_.each(ary_table, function (t) {
				t.hide();
			});
			table.show();
			table.removeClass("scaleSmall").addClass("scaleBig");

			currentBigTable = table;
		}

		function smallAllTable() {
			_.each(ary_table, (t) => {
				smallTable(t);
			});
			bigUIContainer.hide();
		}

		function refreshFourGameSmallUI(ctx) {
			smallUIContainer.each(function (id, dom) {
				refreshSmallUI(ctx, dom);
			});
		}

		function onOOXXTableClick(ooxx, roomId, x, y) {
			api.quickPut(roomId, myId, [x, y], (err, info) => {
				if (err) {
					return;
				}
				log("下子", info);
				ooxx.update(info);
			})
		}

		function refreshFourGame(ctx) {
			if (!ctx.games) {
				return {};
			}
			var retGames = {};
			var randomList = api.getRandomFourRoom(ctx);

			log("更新四間房", randomList);
			var tid = 0;
			_.each(randomList, (room) => {
				table = ary_table[tid];
				table.attr('roomId', room.id);
				retGames[room.id] = view.ooxx.setGame(table, room, myId, { onTableClick: onOOXXTableClick });
				tid++;
			});
			refreshFourGameSmallUI(ctx);
			return retGames;
		}

		function getGameIDBySmallUIButton(ui) {
			return getGameIDBySmallUI(ui.parent().parent());
		}

		function getGameIDBySmallUI(uidom) {
			id = uidom.attr("tableSamllUiID");
			return $("#gameContent" + id).attr('roomId');
		}

		function getBtnJoin(ui) {
			return ui.find("a").eq(0);
		}

		function getBtnWatch(ui) {
			return ui.find("a").eq(1);
		}

		function getBtnScale(ui) {
			return ui.find("a").eq(2);
		}

		function refreshSmallUI(data, dom) {
			var roomId = getGameIDBySmallUI($(dom));
			var btn_join = getBtnJoin($(dom));
			var btn_watch = getBtnWatch($(dom));
			var btn_scale = getBtnScale($(dom));

			btn_join.linkbutton('enable');
			btn_watch.linkbutton('enable');
			btn_scale.linkbutton('enable');

			if (!roomId) {
				btn_join.linkbutton('disable');
				btn_watch.linkbutton('disable');
				btn_scale.linkbutton('disable');
				return;
			}

			var canEnterGame = api.canEnterGame(api.getGameById(data, roomId), myId);
			var canWatchGame = api.canWatchGame(api.getGameById(data, roomId), myId);

			if (!canEnterGame) {
				btn_join.linkbutton('disable');
			}

			if (!canWatchGame) {
				btn_watch.linkbutton('disable');
			}
		}

		function getViewByModelId(id) {
			var views = _.filter(gameObj, (g) => {
				if (g.id == id) {
					return g;
				}
			});
			if (views.length == 0) {
				throw Error("應該要有房間,id:" + id);
			}
			return views[0];
		}

		function updateGameByData(roomId) {
			api.game(roomId, (err, room) => {
				var view = getViewByModelId(room.id);
				view.update(room);
			});
		}

		function handleMsg(msg) {
			log("接到指令", msg);
			switch (msg.type) {
				case 'update':
					updateGameByData(msg.gameID);
			}
		}

		api.insertServiceCallback((err, data) => {
			if( err ){
				$.messager.show({
					title: '提示',
					msg: err,
					timeout: 5000,
					showType: 'slide'
				});
			}
		})

		var gameObj = undefined;
		api.context((err, ctx) => {
			if (err) {
				return;
			}
			gameObj = refreshFourGame(ctx);
			smallAllTable();

			smallUIContainer.each(function (id, dom) {
				var btn_join = getBtnJoin($(dom));
				var btn_watch = getBtnWatch($(dom));
				var btn_scale = getBtnScale($(dom));

				btn_join.click(function (e) {
					var ui = $(e.currentTarget);
					var gameId = getGameIDBySmallUIButton(ui);
					api.quickJoin(
						gameId,
						myId,
						false,
						msg => {
							handleMsg(msg);
						},
						(isSuccess, info) => {
							console.log("target alive ", isSuccess, info)
						},
						(err, ctx) => {
							if (err) {
								return;
							}
							log("加入對奕", ctx);
							btn_join.linkbutton('disable');
						})
				});

				btn_watch.click(function (e) {
					var ui = $(e.currentTarget);
					var gameId = getGameIDBySmallUIButton(ui);
					api.quickJoin(
						gameId,
						myId,
						true,
						msg => {
							handleMsg(msg);
						},
						(isSuccess, info) => {
							console.log("target alive ", isSuccess, info)
						},
						(err, ctx) => {
							if (err) {
								return;
							}
							log("加入觀戰", ctx);
							btn_watch.linkbutton('disable');
						})
				});

				btn_scale.click(function () {
					bigTable(ary_table[id])
				});
			});
		});

		//var myId = api.getMyId();
		var myId = api.getUUID();
		var ary_table = [$("#gameContent1"), $("#gameContent2"), $("#gameContent3"), $("#gameContent4")];
		var ary_game = [$("#tmpl_ooxxContent")]
		var bigUIContainer = $("#bigUIContainer");
		var smallUIContainer = $(".gameUILayer");
		var btn_createRoom = $("#btn_createRoom");
		var btn_refreshRoom = $("#btn_refreshRoom");
		var combo_type = $("#combo_type");

		btn_createRoom.click(() => {
			selectType = combo_type.combobox('getValue');
			api.quickCreateGame(
				selectType, myId,
				msg => {
					handleMsg(msg);
				},
				(isSuccess, info) => {
					console.log("target alive ", isSuccess, info)
				},
				(err, ctx, room) => {
					if (err) {
						return;
					}
					log("創建方間", ctx);
					gameObj = refreshFourGame(ctx);
				});
		});

		btn_refreshRoom.click(() => {
			api.context((err, data) => {
				if (err) {
					return;
				}
				if (data.games) {
					gameObj = refreshFourGame(data);
				}
			});
		});

		currentBigTable = undefined;

		btn_scaleSmall = $("#btn_scaleSmall");
		btn_scaleSmall.click(function (e) {
			if (currentBigTable) {
				smallTable(currentBigTable);
			}
		});
	})
</script>

</html>