<html>
	<head>
		<title>幽夢幻境</title>
		<meta charset="utf-8"/>
		<link rel="stylesheet" type="text/css" href="../common/js/lib/jquery-easyui-1.4.3/themes/black/easyui.css">
		<link rel="stylesheet" type="text/css" href="../common/js/lib/jquery-easyui-1.4.3/themes/icon.css">
		<link rel="stylesheet" type="text/css" href="../common/css/normalize.css">
			
		<script type="text/javascript" src="../common/js/lib/rectSelect/rectSelect.js"></script>
		<link rel="stylesheet" type="text/css" href="../common/js/lib/rectSelect/rectSelect.css">
			
		<script type="text/javascript" src="../common/js/lib/leo.utils.js"></script>
		<script type="text/javascript" src="../common/js/lib/jquery-easyui-1.4.3/jquery.min.js"></script>
		<script type="text/javascript" src="../common/js/lib/jquery-easyui-1.4.3/jquery.easyui.min.js"></script>
		<script type="text/javascript" src="../common/js/lib/vic/vic.easyui.js"></script>
		<script type="text/javascript" src="../common/js/lib/jquery/jquery.cookie.js"></script>
		<script type="text/javascript" src="../common/js/lib/jquery/jquery.tmpl.min.js"></script>
		<script type="text/javascript" src="../common/js/lib/myapp.facebook.js"></script>
	</head>
	<style>
	body{
		-webkit-touch-callout: none;
		-webkit-user-select: none;
		-khtml-user-select: none;
		-moz-user-select: none;
		-ms-user-select: none;
		user-select: none;
		outline: 0;
	}

	.hori{
		display:inline-block;
	}
	
	.group{
		position:relative; 
		width:100%;
		min-width:250px;
	}
	
	.textImg{
		position:relative;
		width:100px;
		height:100px;
		margin-left:5px;
		display:inline-block;
		cursor:pointer;
	}
	
	.outline{
		outline:red solid 2px;
	}
	
	.outline{
		outline:red solid 2px;
	}
	</style>
	
</head>
<script id="tmpl_prop" type="jquery-x-tmpl">
	<div title="生命毫秒" style="overflow:auto; padding-top:10px;">
		<div class="group" style="text-align:center; margin-bottom:5px;">
			<div class="hori"><input class="easyui-numberspinner" style="width:80px;"></input></div>
			<div class="hori"><input class="easyui-numberspinner" style="width:80px;"></input></div>
			<div class="hori"><input class="easyui-numberspinner" style="width:80px;"></input></div>
			<div class="hori"><input class="easyui-numberspinner" style="width:80px;"></input></div>
			<div class="hori"><input class="easyui-numberspinner" style="width:80px;"></input></div>
		</div>
		<div class="group" style="text-align:center; margin-bottom:5px;">
			<div class="hori">
				<select id="cc" class="easyui-combobox" name="dept" style="width:100px;">
					<option value="aa">aitem1</option>
					<option>bitem2</option>
					<option>bitem3</option>
					<option>ditem4</option>
					<option>eitem5</option>
				</select>
			</div>
			<div class="hori"> <a href="#" class="easyui-linkbutton" data-options="iconCls:'icon-add'">新增</a></div>
			<div class="hori"> <a href="#" class="easyui-linkbutton" data-options="iconCls:'icon-remove'">刪除</a></div>
			<div class="hori"> <a href="#" class="easyui-linkbutton" data-options="iconCls:'icon-up'">上移</a></div>
			<div class="hori"> <a href="#" class="easyui-linkbutton" data-options="iconCls:'icon-down'">下移</a></div>
		</div>
		<table class="easyui-datagrid" style="width:100%; height:200px;">
			<thead>
				<tr>
					<th data-options="field:'type',width:'14%'">種類</th>
					<th data-options="field:'v1',width:'14%'">參數1</th>
					<th data-options="field:'v2',width:'14%'">參數2</th>
					<th data-options="field:'v3',width:'14%'">參數3</th>
					<th data-options="field:'v4',width:'14%'">參數4</th>
					<th data-options="field:'v5',width:'14%'">參數5</th>
				</tr>
			</thead>
			<tbody>
				<tr>
					<td>001</td><td>name1</td><td>2323</td>
				</tr>
				<tr>
					<td>002</td><td>name2</td><td>4612</td>
				</tr>
			</tbody>
		</table>
	</div>
</script>
<body>
	<div class="easyui-layout" style="width:100%;height:100%;">
        <div data-options="region:'north'" style="height:50px"></div>
        <div data-options="region:'east',split:true" title="West" style="width:70%;">
			<div class="easyui-layout" style="width:100%;height:100%;">
				<div data-options="region:'north',split:true" style="height:20%">
					<div class="group" style="text-align:center;">
						<div class="hori"><a id="btn_addTree" href="#" class="easyui-linkbutton" onclick="onHtmlClick(this)" data-options="iconCls:'icon-search'">新增</a></div>
						<div class="hori"><a id="btn_removeTree" href="#" class="easyui-linkbutton" onclick="onHtmlClick(this)" data-options="iconCls:'icon-search'">刪除</a></div>
					</div>
					<div class="group">
						<ul id="tree_particle" class="easyui-tree" data-options="dnd:true">
						
						</ul>
					</div>
				</div>
				<div data-options="region:'center',title:'Main Title',iconCls:'icon-ok'">
					<div class="group">
						<div class="hori" style="width:40%;">
							<div class="group" style="text-align:center; margin-top:10px;">
								<div class="hori">基本參數</div>
							</div>
							<div class="group" style="margin-top:10px;">
								<div class="group" style="text-align:center; margin-bottom:5px;">
									<div class="hori"><input id="spr_value" class="easyui-numberspinner" style="width:80px;"></input></div>
								</div>
								<div class="group" style="text-align:center;">
									<div class="hori" style="width:50%;">
										<table id="dgd_props" class="easyui-datagrid" data-options="fitColumns:true,singleSelect:true" style="width:100%;">
											<thead>
												<tr>
													<th data-options="field:'name',width:'53%'">屬性</th>
													<th data-options="field:'v',width:'53%'">參數1</th>
												</tr>
											</thead>
										</table>
									</div>
								</div>
							</div>
						</div>
						<div class="hori" style="width:50%; vertical-align:top;">
							<div class="group" style="text-align:center; margin-top:10px;">
								<div class="hori">進階參數</div>
							</div>
							<div class="group" style="margin-top:10px;">
								<div class="group" style="text-align:center; margin-bottom:5px;">
									<div class="hori">
										<select id="combo_advProps" class="easyui-combobox" name="dept" style="width:100px;">
											<option value="x">位置x</option>
											<option value="y">位置y</option>
											<option value="rot">角度</option>
											<option value="vx">速度x</option>
											<option value="vy">速度y</option>
											<option value="vr">轉速</option>
											<option value="fvx">作用力x</option>
											<option value="fvy">作用力y</option>
											<option value="fvr">作用力旋轉</option>
											<option value="scale-x">寬度</option>
											<option value="scale-y">高度</option>
											<option value="r">紅</option>
											<option value="g">綠</option>
											<option value="b">藍</option>
											<option value="a">alpha</option>
											<option value="emit-angle">發射角度</option>
											<option value="emit-range">發射範圍</option>
											<option value="emit-count">發射數目</option>
											<option value="emit-force">發射力道</option>
										</select>
									</div>
									<div class="hori">
										<select id="combo_advType" class="easyui-combobox" name="dept" style="width:100px;">
											<option value="const">常數</option>
											<option value="constAdd">常數累加</option>
											<option value="constMul">常數累乘</option>
											<option value="linear">線性</option>
											<option value="linearAdd">線性累加</option>
											<option value="linearMul">線性累乘</option>
											<option value="randStartAdd">亂數開始</option>
										</select>
									</div>
									<div class="hori"> <a href="#" id="btn_addAdvProp" class="easyui-linkbutton" onclick="onHtmlClick(this)" data-options="iconCls:'icon-add'">新增</a></div>
									<div class="hori"> <a href="#" id="btn_removeAdvProp" class="easyui-linkbutton" onclick="onHtmlClick(this)" data-options="iconCls:'icon-remove'">刪除</a></div>
									<div class="hori"> <a href="#" id="btn_upMove" class="easyui-linkbutton" onclick="onHtmlClick(this)" data-options="iconCls:'icon-undo'">上移</a></div>
									<div class="hori"> <a href="#" id="btn_downMove" class="easyui-linkbutton" onclick="onHtmlClick(this)" data-options="iconCls:'icon-redo'">下移</a></div>
								</div>
								<div class="group" style="text-align:center; margin-bottom:5px;">
									<div class="hori"><input id="spr_v1" class="easyui-numberspinner" style="width:80px;"></input></div>
									<div class="hori"><input id="spr_v2" class="easyui-numberspinner" style="width:80px;"></input></div>
									<div class="hori"><input id="spr_v3" class="easyui-numberspinner" style="width:80px;"></input></div>
									<div class="hori"><input id="spr_v4" class="easyui-numberspinner" style="width:80px;"></input></div>
									<div class="hori"><input id="spr_v5" class="easyui-numberspinner" style="width:80px;"></input></div>
								</div>
								<div class="group" style="text-align:center; margin-bottom:50px;">
									<div class="hori" style="width:90%;">
										<table id="dgd_advprops" class="easyui-datagrid" data-options="singleSelect:true" style="width:100%;">
											<thead>
												<tr>
													<th data-options="field:'name',width:'14%'">屬性</th>
													<th data-options="field:'type',width:'14%'">種類</th>
													<th data-options="field:'v1',width:'15%'">參數1</th>
													<th data-options="field:'v2',width:'15%'">參數2</th>
													<th data-options="field:'v3',width:'15%'">參數3</th>
													<th data-options="field:'v4',width:'15%'">參數4</th>
													<th data-options="field:'v5',width:'15%'">參數5</th>
												</tr>
											</thead>
										</table>
									</div>
								</div>
							</div>
						</div>
					</div>
					
					
				</div>
				<div data-options="region:'south', title:'貼圖',split:true" style="height:20%">
					<div id="mc_imgs" class="group">
					</div>
				</div>
			</div>
		</div>
        <div data-options="region:'center',title:'Main Title',iconCls:'icon-ok'" style="width:30%;">
           <div id="canvas_container" style="position:relative; width:100%; height:100%">
				<div id="webgl" style="position:relative; width:100%; height:100%; left:0; top:0;"></div>
			</div>
        </div>
    </div>
</body>
<script src='../common/js/lib/async.js'></script>
<script src='../common/js/lib/rxjs/rx.all.min.js'></script>
<script src='../common/js/lib/three.min.js'></script>
<script src='../common/js/lib/underscore/underscore-min.js'></script>
<script src='js/particle.js'></script>
<script src='js/api.js'></script>
<script src="js/haxe.js"></script>
<script type="text/javascript">

	var app = app || {};
	app.view = app.view || {};
	
	(function( module ){
		var event = $('<div></div>' );
		var tree_particle = $("#tree_particle" );
		var mc_imgs = $("#mc_imgs" );
		var spr_value = $("#spr_value" );
		var spr_v1 = $("#spr_v1" );
		var spr_v2 = $("#spr_v2" );
		var spr_v3 = $("#spr_v3" );
		var spr_v4 = $("#spr_v4" );
		var spr_v5 = $("#spr_v5" );
		var dgd_props = $("#dgd_props" );
		var dgd_advprops = $("#dgd_advprops" );
		var combo_advProps = $("#combo_advProps" );
		var combo_advType = $("#combo_advType" );
		var webgl = $('#webgl' );
		var isMouseDown = false;
		var targetPos = [0.0, 0.0];
		var currentPos = [0.0, 0.0];
		var ary_props = [ 	{id:'life', name:'生命'}, 
							{id:'x', name:'位置x'}, 
							{id:'y', name:'位置y'}, 
							{id:'rot', name:'弧度'}, 
							{id:'vx', name:'速度x'}, 
							{id:'vy', name:'速度y'}, 
							{id:'vr', name:'旋轉速度'}, 
							{id:'scale-x', name:'粒子寬度'}, 
							{id:'scale-y', name:'粒子高度'}, 
							{id:'r', name:'紅'}, 
							{id:'g', name:'綠'}, 
							{id:'b', name:'藍'}, 
							{id:'a', name:'alpha'}, 
							{id:'fvx', name:'作用力x'}, 
							{id:'fvy', name:'作用力y'}, 
							{id:'fvr', name:'作用力旋轉'}, 
							{id:'emit-count', name:'發射數目'}, 
							{id:'emit-duration', name:'週期毫秒'}, 
							{id:'emit-angle', name:'發射弧度'}, 
							{id:'emit-range', name:'發射範圍'}, 
							{id:'emit-force', name:'發射力道'}];
							
		vic.easyui.initSprWheel( $('.easyui-numberspinner' ) );
		/*
		$('.easyui-numberspinner' ).numberspinner( {
			precision:1
		});
		*/
		
		var tid = undefined;
		function keepUpdateGrid( cb ){
			if( tid != undefined ){
				clearInterval( tid );
			}
			tid = setInterval( function(){
				clearInterval( tid );
				cb();
			}, 100 );
		}
		
		spr_value.numberspinner( {
			onChange:function( nv, ov ){
				if( currentRow != undefined ){
					currentRow.row.v = nv;
					keepUpdateGrid( function(){
						vic.easyui.updateDatagridRow( dgd_props, currentRow.index, currentRow.row );
					});
					event.trigger( 'onPropChange', { currentRow: currentRow } );
				}
			}
		});
		
		spr_v1.numberspinner( {
			onChange:function( nv, ov ){
				if( currentAdvRow != undefined ){
					currentAdvRow.row.v1 = nv;
					keepUpdateGrid( function(){
						vic.easyui.updateDatagridRow( dgd_advprops, currentAdvRow.index, currentAdvRow.row );
					});
					event.trigger( 'onPropChange', { currentRow: currentAdvRow, rows:vic.easyui.getDatagridRows( dgd_advprops ) } );
				}
			}
		});
		
		spr_v2.numberspinner( {
			onChange:function( nv, ov ){
				if( currentAdvRow != undefined ){
					currentAdvRow.row.v2 = nv;
					keepUpdateGrid( function(){
						vic.easyui.updateDatagridRow( dgd_advprops, currentAdvRow.index, currentAdvRow.row );
					});
					event.trigger( 'onPropChange', { currentRow: currentAdvRow, rows:vic.easyui.getDatagridRows( dgd_advprops ) } );
				}
			}
		});
		
		spr_v3.numberspinner( {
			onChange:function( nv, ov ){
				if( currentAdvRow != undefined ){
					currentAdvRow.row.v3 = nv;
					keepUpdateGrid( function(){
						vic.easyui.updateDatagridRow( dgd_advprops, currentAdvRow.index, currentAdvRow.row );
					});
					event.trigger( 'onPropChange', { currentRow: currentAdvRow, rows:vic.easyui.getDatagridRows( dgd_advprops ) } );
				}
			}
		});
		
		spr_v4.numberspinner( {
			onChange:function( nv, ov ){
				if( currentAdvRow != undefined ){
					currentAdvRow.row.v4 = nv;
					keepUpdateGrid( function(){
						vic.easyui.updateDatagridRow( dgd_advprops, currentAdvRow.index, currentAdvRow.row );
					});
					event.trigger( 'onPropChange', { currentRow: currentAdvRow, rows:vic.easyui.getDatagridRows( dgd_advprops ) } );
				}
			}
		});
		
		spr_v5.numberspinner( {
			onChange:function( nv, ov ){
				if( currentAdvRow != undefined ){
					currentAdvRow.row.v5 = nv;
					keepUpdateGrid( function(){
						vic.easyui.updateDatagridRow( dgd_advprops, currentAdvRow.index, currentAdvRow.row );
					});
					event.trigger( 'onPropChange', { currentRow: currentAdvRow, rows:vic.easyui.getDatagridRows( dgd_advprops ) } );
				}
			}
		});
		
		combo_advProps.combobox({
			onChange:function( nv, ov ){
				if( currentAdvRow != undefined ){
					currentAdvRow.row.id = nv;
					currentAdvRow.row.name = keyToName( currentAdvRow.row.id );
					vic.easyui.updateDatagridRow( dgd_advprops, currentAdvRow.index, currentAdvRow.row );
					event.trigger( 'onPropChange', { currentRow: currentAdvRow, rows:vic.easyui.getDatagridRows( dgd_advprops ) } );
				}
			}
		});
		
		var currentAdvRow = undefined;
		dgd_advprops.datagrid({
			onSelect:function( index, row ){
				currentAdvRow = {index:index, row:row};
				
				vic.easyui.setSpinnerValue( spr_v1, row.v1, false );
				vic.easyui.setSpinnerValue( spr_v2, row.v2, false );
				vic.easyui.setSpinnerValue( spr_v3, row.v3, false );
				vic.easyui.setSpinnerValue( spr_v4, row.v4, false );
				vic.easyui.setSpinnerValue( spr_v5, row.v5, false );
				vic.easyui.setComboxSelect( combo_advProps, row.id, false );
				vic.easyui.setComboxSelect( combo_advType, row.tid, false );
			}
		});
		
		combo_advType.combobox({
			onChange:function( nv, ov ){
				if( currentAdvRow != undefined ){
					currentAdvRow.row.tid = nv;
					currentAdvRow.row.type = keyToName( currentAdvRow.row.tid );
					vic.easyui.updateDatagridRow( dgd_advprops, currentAdvRow.index, currentAdvRow.row );
					event.trigger( 'onPropChange', { currentRow: currentAdvRow, rows:vic.easyui.getDatagridRows( dgd_advprops ) } );
				}
			}
		});
			
		var currentRow = undefined;
		dgd_props.datagrid({
			onSelect:function( index, row ){
				currentRow =  {index:index, row:row};
				vic.easyui.setSpinnerValue( spr_value, row.v, false );
			}
		});
		
		var currentNode = undefined;
		tree_particle.tree( {
			onSelect:function( node ){
				currentNode = node;
				event.trigger( 'onTreeClick', { node:node } );
			}
		});
		
		webgl.mousedown( onmousedown );
		webgl.mouseup( onmouseup );
		webgl.mousemove( onMousemove );
		
		function onMousemove(e) {
			var px = e.offsetX;
			var py = e.offsetY;
			if ( isMouseDown ) {
				targetPos[0] = px;
				targetPos[1] = py;
				event.trigger( 'onMouseMove', { targetPos:targetPos } );
			}
		}
		
		function onmousedown( e ) {
			isMouseDown = true;
		}
		
		function onmouseup( e ) {
			isMouseDown = false;
		}
		
		function appendImage( id, dom ){
			$( dom ).attr( 'id', id );
			$( dom ).css( 'width', '100px' );
			$( dom ).css( 'height', '100px' );
			mc_imgs.append( dom );
			
			mc_imgs.undelegate( 'click' );
			mc_imgs.delegate( 'img', 'click', function(){
				setImgFocus( $(this).attr( 'id' ) );
				event.trigger( 'onImgClick', { id: $(this).attr( 'id' ) } );
			});
		}
		
		function setImgFocus( imgId ){
			mc_imgs.find('img').each( function( id, dom ){
				$( dom ).removeClass( 'outline' );
				if( dom.id == imgId ){
					$( dom ).addClass( 'outline' );
				}
			});
		}
		
		function setDgdProp( ary_props ){
			vic.easyui.setDatagridRows( dgd_props, ary_props );
			if( ary_props.length > 0 )
				vic.easyui.selectDatagridRow( dgd_props, 0 );
		}
		
		function setAdvDgdProp( ary_props ){
			vic.easyui.setDatagridRows( dgd_advprops, ary_props );
			if( ary_props.length > 0 )
				vic.easyui.selectDatagridRow( dgd_advprops, 0 );
		}
		
		function setTree( nodes, selectId ){
			vic.easyui.setTree( tree_particle, nodes );
			
			setTimeout( function(){
				vic.easyui.selectTreeNode( tree_particle,vic.easyui.getTreeNodeById( tree_particle, selectId ));
				event.trigger( 'onViewTreeChange' );
			}, 10 );
		}
		
		function addTree( model ){
			if( currentNode == undefined ){
				vic.easyui.appendTree( tree_particle, vic.easyui.getTreeNodeById( tree_particle, 0 ), { id:model.id, text:model.name, particle:model } );
			}else{
				vic.easyui.appendTree( tree_particle, currentNode, { id:model.id , text:model.name, particle:model } );
			}
			event.trigger( 'onViewTreeChange' );
		}
		
		function removeTree(){
			if( currentNode != undefined ){
				vic.easyui.removeTree( tree_particle, currentNode );
				currentNode = undefined;
				event.trigger( 'onViewTreeChange' );
			}
		}
		
		function addAdvProp(){
			var newf = {
				id: combo_advProps.combobox( 'getValue' ),
				tid: combo_advType.combobox( 'getValue' ),
				name: keyToName( combo_advProps.combobox( 'getValue' ) ),
				type: keyToName( combo_advType.combobox( 'getValue' ) ),
				v1: spr_v1.numberspinner( 'getValue' ),
				v2: spr_v2.numberspinner( 'getValue' ),
				v3: spr_v3.numberspinner( 'getValue' ),
				v4: spr_v4.numberspinner( 'getValue' ),
				v5: spr_v5.numberspinner( 'getValue' )
			};
			vic.easyui.appendDatagridRow( dgd_advprops, newf );
			vic.easyui.selectDatagridRow( dgd_advprops, vic.easyui.getDatagridRows( dgd_advprops ).length - 1 );
			
			event.trigger( 'onPropChange', { currentRow: currentAdvRow, rows:vic.easyui.getDatagridRows( dgd_advprops ) } );
		}
		
		function removeAdvProp(){
			if( currentAdvRow != undefined ){
				vic.easyui.deleteDatagridRow( dgd_advprops, currentAdvRow.index );
				currentAdvRow = undefined;
				var ary_rows = vic.easyui.getDatagridRows( dgd_advprops );
				if( ary_rows.length > 0 ){
					vic.easyui.selectDatagridRow( dgd_advprops, vic.easyui.getDatagridRows( dgd_advprops ).length - 1 );
				}
			}
			event.trigger( 'onPropChange', { currentRow: currentAdvRow, rows:vic.easyui.getDatagridRows( dgd_advprops ) } );
		}
		
		function upMove(){
			if( currentAdvRow != undefined ){
				if( currentAdvRow.index > 0 ){
					vic.easyui.deleteDatagridRow( dgd_advprops, currentAdvRow.index );
					vic.easyui.insertDatagridRow( dgd_advprops, currentAdvRow.index - 1, currentAdvRow.row );
					vic.easyui.selectDatagridRow( dgd_advprops, currentAdvRow.index - 1 );
				}
			}
			
			event.trigger( 'onPropChange', { currentRow: currentAdvRow, rows:vic.easyui.getDatagridRows( dgd_advprops ) } );
		}
		
		function downMove(){
			if( currentAdvRow != undefined ){
				var maxCount = vic.easyui.getDatagridRows( dgd_advprops ).length;
				if( currentAdvRow.index < maxCount - 1 ){
					vic.easyui.deleteDatagridRow( dgd_advprops, currentAdvRow.index );
					vic.easyui.insertDatagridRow( dgd_advprops, currentAdvRow.index + 1 , currentAdvRow.row );
					vic.easyui.selectDatagridRow( dgd_advprops, currentAdvRow.index + 1 );
				}
			}
			
			event.trigger( 'onPropChange', { currentRow: currentAdvRow, rows:vic.easyui.getDatagridRows( dgd_advprops ) } );
		}
		
		function getTreeRootNode(){
			return vic.easyui.getTreeNodeById( tree_particle, 0 );
		}
		
		module.webgl = webgl;
		module.tree_particle = tree_particle;
		module.addTree = addTree;
		module.removeTree = removeTree;
		module.addAdvProp = addAdvProp;
		module.removeAdvProp = removeAdvProp;
		module.upMove = upMove;
		module.downMove = downMove;
		module.setTree = setTree;
		module.setDgdProp = setDgdProp;
		module.setAdvDgdProp = setAdvDgdProp;
		module.getTreeRootNode = getTreeRootNode;
		module.appendImage = appendImage;
		module.setImgFocus = setImgFocus;
		module.event = event;
	})( app.view );
	
	
	var app = app || {};
	app.model = app.model || {};
	
	(function( module ){
		var particles =  {  
			  "id":0,
			  "name":"粒子",
			  "lifetime":0,
			  "vel":[  
				 0,
				 0,
				 0
			  ],
			  "pos":[  
				 0,
				 0,
				 0
			  ],
			  "mass":1,
			  "color":[  
				 1,
				 1,
				 1,
				 1
			  ],
			  "size":[  
				 40,
				 40
			  ],
			  "formulaList":[],
			  "tex":"0",
			  "blending":"add",
			  "emit":{  
				 "prototype":[  
					{  
					   "id":"1",
					   "name":"粒子",
					   "lifetime":2,
					   "vel":[  
						  0,
						  0,
						  0
					   ],
					   "pos":[  
						  0,
						  0,
						  0
					   ],
					   "mass":1,
					   "color":[  
						  1,
						  1,
						  1,
						  1
					   ],
					   "size":[  
						  40,
						  40
					   ],
					   "tex":0,
					   "blending":"add",
					   "formulaList":[  ]
					}
				 ],
				 "count":1,
				 "duration":0.05,
				 "angle":0,
				 "range":0,
				 "force":0
			  }
		   }
		
		function getParticles(){
			return particles;
		}
		
		function createParticle( id, name ){
			return { 
				"id":id,
				"name":name,
				"lifetime":1,
				"vel":[  
				 0,
				 0,
				 0
				],
				"pos":[  
				 256.52719250452884,
				 463.7413907217794,
				 0
				],
				"mass":1,
				"color":[  
				 1,
				 1,
				 1,
				 1
				],
				"size":[  
				 40,
				 40
				],
				"formulaList":[],
				"tex":"0",
				"blending":"add"
			}
		}
		
		module.getParticles = getParticles;
		module.createParticle = createParticle;
	})( app.model );
	
	
//	['images/fire_128_128.jpg'];
	
	loadImages( [
					{id:0, path:'images/glow.jpg' },
					{id:1, path:'images/leadB_32_32.png' },
					{id:2, path:'images/fire_128_128.jpg' },
					{id:3, path:'images/smoke_128_128_half_hlaf.png' }
				] );
	
	function loadImages( ary_image ){
		var imgItem = ary_image.shift();
		loadImage( imgItem.path, function( img ) {
			app.view.appendImage( imgItem.id, img );
			api.addTexture( imgItem.id, img );
		});
		if( ary_image.length > 0 ){
			loadImages( ary_image );
		}else{
			appStart( app.view, app.model );
		}
	}
	
	function appStart( view, model ){
		var webgl = view.webgl;
		var currentParticle = undefined;
		
		api.init( webgl );
		
		var particles = model.getParticles();
		
		var treeModel = {};
		modelToTree( particles, treeModel )
		view.setTree( [ treeModel ], 1 );
		
		view.event.on( 'onViewTreeChange', function(){
			updateRender();
		});
		
		view.event.on( 'onTreeClick', function( e, options ){
			view.setDgdProp( (function( node ){
				var p = node.particle;
				if( vic.easyui.getTreeIsLeaf( view.tree_particle, node ) ){
					return [
						{id:'lifetime', name:'生命毫秒', v: p.lifetime * 1000 },
						{id:'mass', name:'質量', v: p.mass},
						{id:'pos_r', name:'角度', v: radianToDegree( p.pos[2] )},
						{id:'vel_x', name:'速度x', v: p.vel[0]},
						{id:'vel_y', name:'速度y', v: p.vel[1]},
						{id:'vel_r', name:'轉速', v: radianToDegree( p.vel[2] )},
						{id:'size_x', name:'寬度', v: p.size[0]},
						{id:'size_y', name:'高度', v: p.size[1]}
					];
				}
				return [
					{id:'lifetime', name:'生命毫秒', v: p.lifetime * 1000 },
					{id:'mass', name:'質量', v: p.mass},
					{id:'pos_r', name:'角度', v: radianToDegree( p.pos[2] )},
					{id:'vel_x', name:'速度x', v: p.vel[0]},
					{id:'vel_y', name:'速度y', v: p.vel[1]},
					{id:'vel_r', name:'轉速', v: radianToDegree( p.vel[2] )},
					{id:'size_x', name:'寬度', v: p.size[0]},
					{id:'size_y', name:'高度', v: p.size[1]},
					{id:'count', name:'發射數目', v: p.emit.count},
					{id:'duration', name:'發射週期', v: p.emit.duration * 1000 },
					{id:'angle', name:'發射角度', v: radianToDegree( p.emit.angle )},
					{id:'range', name:'發射範圍', v: radianToDegree( p.emit.range )},
					{id:'force', name:'發射力道', v: p.emit.force}
				];
			})( options.node ));
			
			if( options.node.particle.formulaList != undefined ){
				view.setAdvDgdProp((function( node ){
					var p = node.particle;
					return _.map( p.formulaList, function( f ){
						var retobj = {
							id:f[0], tid:f[1], name:keyToName(f[0]), type:keyToName(f[1]), v1:f[2], v2:f[3], v3:f[4], v4:f[5], v5:f[6]
						}
						
						switch( retobj.id ){
							case 'rot':
							case 'vr':
							case 'emit-range':
							case 'emit-angle':
								retobj.v1 = radianToDegree( retobj.v1 );
								retobj.v2 = radianToDegree( retobj.v2 );
								retobj.v3 = radianToDegree( retobj.v3 );
								retobj.v4 = radianToDegree( retobj.v4 );
								retobj.v5 = radianToDegree( retobj.v5 );
								break;
						}
						return retobj;
					});
				})( options.node ));
			}
			
			view.setImgFocus( options.node.particle.tex );
			
			currentParticle = options.node.particle;
		});
		
		view.event.on( 'onMouseMove', function( e, options ){
			var rootParticle = view.getTreeRootNode().particle;
			rootParticle.pos[0] = options.targetPos[0];
			rootParticle.pos[1] = options.targetPos[1];
			updateRender();
		});
		
		view.event.on( 'onImgClick', function( e, options ){
			currentParticle.tex = options.id;
			updateRender();
		});
		
		view.event.on( 'onDgdPropsClick', function( e, options ){
			//console.log( options );
		});
		
		view.event.on( 'onPropChange', function( e, options ){
			if( currentParticle == undefined ) return;
			if( options.currentRow == undefined ) {
				currentParticle.formulaList = [];
				return;
			}
			var row = options.currentRow.row;
			var rows = options.rows;
			if( rows != undefined ){
				currentParticle.formulaList = _.map( rows, function( r ){
					
					var retobj = [r.id, r.tid, 
								parseInt( r.v1 ),
								parseInt( r.v2 ),
								parseInt( r.v3 ),
								parseInt( r.v4 ),
								parseInt( r.v5 )];
								
					switch( r.id ){
						case 'rot':
						case 'vr':
						case 'emit-range':
						case 'emit-angle':
							retobj[2] = degreeToRadian( retobj[2] );
							retobj[3] = degreeToRadian( retobj[3] );
							retobj[4] = degreeToRadian( retobj[4] );
							retobj[5] = degreeToRadian( retobj[5] );
							retobj[6] = degreeToRadian( retobj[6] );
							break;
					}
					return retobj;
				});
				
			}else{
				row.v = parseInt( row.v );
				switch( row.id ){
					case 'lifetime':
						currentParticle.lifetime = ( row.v / 1000 ); break;
					case 'pos_r':
						currentParticle.pos[0] = degreeToRadian( row.v ); break;
					case 'vel_x':
						currentParticle.vel[0] = row.v; break;
					case 'vel_y':
						currentParticle.vel[1] = row.v; break;
					case 'vel_r':
						currentParticle.vel[2] = degreeToRadian( row.v ); break;
					case 'size_x':
						currentParticle.size[0] = row.v; break;
					case 'size_y':
						currentParticle.size[1] = row.v; break;
					case 'count':
						currentParticle.emit.count = row.v; break;
					case 'duration':
						currentParticle.emit.duration = ( row.v / 1000 ); break;
					case 'range':
						currentParticle.emit.range = degreeToRadian( row.v ); break;
					case 'angle':
						currentParticle.emit.angle = degreeToRadian( row.v ); break;
					case 'force':
						currentParticle.emit.force = row.v; break;
					default:
						currentParticle[row.id] = row.v;
				}
			}
			updateRender();
		});
		
		function updateRender(){
			var retobj = { };
			treeToModel( vic.easyui.getTreeNodeById( view.tree_particle, 0 ), retobj );
			//console.log( 'render', JSON.stringify( retobj ) );
			api.editParticle( retobj );
		}
		
		function moveParticle(id, x, y) {
			api.changeCenterPos(id, x, y );
		}
		
		function modelToTree( fields, retobj ) {
			retobj.id = fields.id;
			retobj.text = fields.name;
			retobj.particle = fields;
			
			if ( fields.emit != undefined ) {
				retobj.children = [];
				_.each( fields.emit.prototype, function( p ){
					var tobj = {};
					retobj.children.push( tobj );
					modelToTree( p, tobj );
				});
			}
		}
		
		function treeToModel( node, outputData ) {
			var particleData = node.particle;
			outputData.id = particleData.id;
			outputData.lifetime = particleData.lifetime;
			outputData.vel = particleData.vel;
			outputData.pos = particleData.pos;
			outputData.mass = particleData.mass;
			outputData.color = particleData.color;
			outputData.size = particleData.size;
			outputData.tex = particleData.tex;
			outputData.blending = particleData.blending;
			outputData.formulaList = deepCopy( particleData.formulaList );
			
			if ( node.children && node.children.length > 0 ) {
				if( particleData.emit == undefined ){
					particleData.emit = {};
					particleData.emit.count = 1;
					particleData.emit.duration = .5;
					particleData.emit.angle = 0;
					particleData.emit.range = 0;
					particleData.emit.force = 100;
				}
				particleData.emit.prototype = [];
				if( outputData.emit == undefined ){
					outputData.emit = deepCopy( node.particle.emit );
				}
				_.each( node.children, function( nc ){
					var obj = { };
					outputData.emit.prototype.push( obj );
					treeToModel( nc, obj );
				});
			}
		}
	}
	
	function keyToName( key ){
		switch( key ){
			case 'x':return '位置x';break;
			case 'y':return '位置y';break;
			case 'rot':return '角度';break;
			case 'vx':return '速度x';break;
			case 'vy':return '速度y';break;
			case 'vr':return '轉速';break;
			case 'fvx':return '作用力x';break;
			case 'fvy':return '作用力y';break;
			case 'fvr':return '作用力旋轉';break;
			case 'scale-x':return '寬度';break;
			case 'scale-y':return '高度';break;
			case 'r':return '紅';break;
			case 'g':return '綠';break;
			case 'b':return '藍';break;
			case 'a':return 'alpha';break;
			case 'emit-angle':return '發射角度';break;
			case 'emit-range':return '發射範圍';break;
			case 'emit-count':return '發射數目';break;
			case 'emit-force':return '發射力道';break;
			case 'emit-duration':return '發射週期';break;
			case 'const':return '常數';break;
			case 'constAdd':return '常數累加';break;
			case 'constMul':return '常數累乘';break;
			case 'linear':return '線性';break;
			case 'linearAdd':return '線性累加';break;
			case 'linearMul':return '線性累乘';break;
			case 'randStartAdd':return '亂數開始';break;
		}
	}
	
	function deepCopy( obj ){
		return JSON.parse( JSON.stringify( obj ));
	}
	
	function radianToDegree( r ){
		return r / Math.PI * 180;
	}
	
	function degreeToRadian( d ){
		return d / 180 * Math.PI;
	}
	
	function getUid(){
		return leo.utils.generateUUID();
	}
	
	function loadImage( src, cb ) {
		var img = new Image();
		img.src = src;
		img.onload = function() {
			cb( img );
		};
	}
	
	function onHtmlClick( dom ){
		switch( dom.id ){
			case 'btn_addTree':
				var uid = getUid();
				app.view.addTree( app.model.createParticle( uid, uid ) );
				break;
			case 'btn_removeTree':
				app.view.removeTree();
				break;
			case 'btn_addAdvProp':
				app.view.addAdvProp();
				break;
			case 'btn_removeAdvProp':
				app.view.removeAdvProp();
				break;
			case 'btn_upMove':
				app.view.upMove();
				break;
			case 'btn_downMove':
				app.view.downMove();
				break;
		}
	}
</script>

</html>