<html>
	<head>
		<title>幽夢幻境</title>
		<meta charset="utf-8"/>
		<link rel="stylesheet" type="text/css" href="../common/js/lib/jquery-easyui-1.4.3/themes/black/easyui.css">
		<link rel="stylesheet" type="text/css" href="../common/js/lib/jquery-easyui-1.4.3/themes/icon.css">
		<link rel="stylesheet" type="text/css" href="../common/css/normalize.css">
		<link rel="stylesheet" media="screen" type="text/css" href="../common/js/lib/colorpicker/css/colorpicker.css" />
			
			
		<script type="text/javascript" src="../common/js/lib/rectSelect/rectSelect.js"></script>
		<link rel="stylesheet" type="text/css" href="../common/js/lib/rectSelect/rectSelect.css">
			
		<script type="text/javascript" src="../common/js/lib/leo.utils.js"></script>
		<script type="text/javascript" src="../common/js/lib/jquery-easyui-1.4.3/jquery.min.js"></script>
		<script type="text/javascript" src="../common/js/lib/jquery-easyui-1.4.3/jquery.easyui.min.js"></script>
		<script type="text/javascript" src="../common/js/lib/vic/vic.easyui.js"></script>
		<script type="text/javascript" src="../common/js/lib/jquery/jquery.cookie.js"></script>
		<script type="text/javascript" src="../common/js/lib/jquery/jquery.tmpl.min.js"></script>
		<script type="text/javascript" src="../common/js/lib/myapp.facebook.js"></script>
		<script type="text/javascript" src="../common/js/lib/colorpicker/js/colorpicker.js"></script>
	</head>
	<style>
	body{
		-webkit-touch-callout: none;
		-webkit-user-select: none;
		-khtml-user-select: none;
		-moz-user-select: none;
		-ms-user-select: none;
		user-select: none;
		outline: 0;
	}

	.hori{
		display:inline-block;
	}
	
	.group{
		position:relative; 
		width:100%;
		min-width:250px;
	}
	
	.textImg{
		position:relative;
		width:100px;
		height:100px;
		margin-left:5px;
		display:inline-block;
		cursor:pointer;
	}
	
	.outline{
		outline:red solid 2px;
	}
	
	.outline{
		outline:red solid 2px;
	}
	
	</style>
	
</head>
<script id="tmpl_prop" type="jquery-x-tmpl">
	<div class="group" ptype=${id}>
		<div class="hori"><div style="width:100px;">${name}</div></div>
		<div class="hori"><input id="spr_value" class="easyui-numberspinner" style="width:80px;"></input></div>
		<div class="hori"><a id="btn_rand" class="easyui-linkbutton" data-options="toggle:true">亂數</a></div>
		<div class="hori"><a id="btn_fric" class="easyui-linkbutton" data-options="toggle:true">阻力</a></div>
		<div class="hori"><a id="btn_custom" class="easyui-linkbutton" data-options="toggle:true">自訂</a></div>
	</div>
</script>
<body>
	<div class="easyui-layout" style="width:100%;height:100%;">
        <div data-options="region:'north'" style="height:50px">
			
		</div>
        <div data-options="region:'east',split:true" title="West" style="width:70%;">
			<div class="easyui-layout" style="width:100%;height:100%;">
				<div data-options="region:'north',split:true" style="height:20%">
					<div class="easyui-layout" style="width:100%;height:100%;">
						<div data-options="region:'center'" style="width:50%;">
							<div class="group" style="text-align:center;">
								<div class="hori"><a id="btn_addTree" href="#" class="easyui-linkbutton" onclick="onHtmlClick(this)" data-options="iconCls:'icon-search'">新增</a></div>
								<div class="hori"><a id="btn_removeTree" href="#" class="easyui-linkbutton" onclick="onHtmlClick(this)" data-options="iconCls:'icon-search'">刪除</a></div>
							</div>
							<div class="group">
								<ul id="tree_particle" class="easyui-tree" data-options="dnd:true">
									<!-- by script -->
								</ul>
							</div>
						</div>
						<div data-options="region:'east',split:true" style="width:50%;">
							<div class="group">
								<div class="group" style="text-align:center; margin-top:10px; ">
									<div class="hori">
										<div>粒子數目(最大2000) :</div>
										<div id="txt_count" style="color:yellow">0</div>
									</div>
								</div>
								<div class="group" style="text-align:center; margin-top:10px; ">
									<div class="hori">
										<div>FPS:</div>
										<div id="txt_fps" style="color:yellow">0</div>
									</div>
								</div>
								<div class="group" style="text-align:center; margin-top:10px;">
									<div class="hori">
										<div>背景顏色</div>
										<div style="position:relative; top:5px; left:4px;">
											<div id="cpr_back"></div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
					
				</div>
				<div data-options="region:'center',title:'Main Title',iconCls:'icon-ok'">
					
					<div class="group">
						<div class="hori" style="width:40%;">
							<div class="group" style="text-align:center; margin-top:10px;">
								<div class="hori">基本參數</div>
							</div>
							<div id="mc_propContainer" class="group" style="margin-top:10px; text-align:center;">
								<!-- by script -->
							</div>
							<div class="group" style="text-align:center;">
								<div class="hori">顏色</div>
								<div class="hori">
									<div style="position:relative; top:14px; ">
										<div id="cpr_color"></div>
									</div>
								</div>
							</div>
						</div>
						<div class="hori" style="width:50%; vertical-align:top;">
							<div class="group" style="text-align:center; margin-top:10px;">
								<div class="hori">進階參數</div>
							</div>
							<div class="group" style="margin-top:10px;">
								<div class="group" style="text-align:center; margin-bottom:5px;">
									<div class="hori">
										<select id="combo_advProps" class="easyui-combobox" name="dept" style="width:100px;">
											<option value="lifetime">生命毫秒</option>
											<option value="x">位置x</option>
											<option value="y">位置y</option>
											<option value="rot">角度</option>
											<option value="vx">速度x</option>
											<option value="vy">速度y</option>
											<option value="vr">轉速</option>
											<option value="scale-x">寬度</option>
											<option value="scale-y">高度</option>
											<option value="r">紅</option>
											<option value="g">綠</option>
											<option value="b">藍</option>
											<option value="a">alpha</option>
											<option value="emit-angle">發射角度</option>
											<option value="emit-range">發射範圍</option>
											<option value="emit-count">發射數目</option>
											<option value="emit-force">發射力道</option>
										</select>
									</div>
									<div class="hori">
										<select id="combo_advType" class="easyui-combobox" name="dept" style="width:100px;">
											<option value="const">常數</option>
											<option value="constAdd">常數累加</option>
											<option value="constMul">常數累乘</option>
											<option value="linear">線性</option>
											<option value="linearAdd">線性累加</option>
											<option value="linearMul">線性累乘</option>
											<option value="randStartAdd">亂數開始</option>
											<option value="rand">亂數重設</option>
											<option value="randAdd">亂數累加</option>
											<option value="custom">自訂</option>
										</select>
									</div>
									<div class="hori"> <a href="#" id="btn_addAdvProp" class="easyui-linkbutton" onclick="onHtmlClick(this)" data-options="iconCls:'icon-add'">新增</a></div>
									<div class="hori"> <a href="#" id="btn_removeAdvProp" class="easyui-linkbutton" onclick="onHtmlClick(this)" data-options="iconCls:'icon-remove'">刪除</a></div>
									<div class="hori"> <a href="#" id="btn_upMove" class="easyui-linkbutton" onclick="onHtmlClick(this)" data-options="iconCls:'icon-undo'">上移</a></div>
									<div class="hori"> <a href="#" id="btn_downMove" class="easyui-linkbutton" onclick="onHtmlClick(this)" data-options="iconCls:'icon-redo'">下移</a></div>
								</div>
								<div class="group" style="text-align:center; margin-bottom:5px;">
									<div class="hori"><input id="spr_v1" class="easyui-numberspinner" style="width:80px;" data-options="value:0"></input></div>
									<div class="hori"><input id="spr_v2" class="easyui-numberspinner" style="width:80px;" data-options="value:0"></input></div>
									<div class="hori"><input id="spr_v3" class="easyui-numberspinner" style="width:80px;" data-options="value:0"></input></div>
									<div class="hori"><input id="spr_v4" class="easyui-numberspinner" style="width:80px;" data-options="value:0"></input></div>
									<div class="hori"><input id="spr_v5" class="easyui-numberspinner" style="width:80px;" data-options="value:0"></input></div>
								</div>
								<div class="group" style="text-align:center; margin-bottom:50px;">
									<div class="hori" style="width:90%;">
										<table id="dgd_advprops" class="easyui-datagrid" data-options="singleSelect:true" style="width:100%;">
											<thead>
												<tr>
													<th data-options="field:'name',width:'14%'">屬性</th>
													<th data-options="field:'type',width:'14%'">種類</th>
													<th data-options="field:'v1',width:'15%'">參數1</th>
													<th data-options="field:'v2',width:'15%'">參數2</th>
													<th data-options="field:'v3',width:'15%'">參數3</th>
													<th data-options="field:'v4',width:'15%'">參數4</th>
													<th data-options="field:'v5',width:'15%'">參數5</th>
												</tr>
											</thead>
										</table>
									</div>
								</div>
							</div>
						</div>
					</div>
					
					
				</div>
				<div data-options="region:'south', title:'貼圖',split:true" style="height:20%">
					<div id="mc_imgs" class="group">
					</div>
				</div>
			</div>
		</div>
        <div data-options="region:'center',title:'Main Title',iconCls:'icon-ok'" style="width:30%;">
           <div id="canvas_container" style="position:relative; width:100%; height:100%">
				<div id="webgl" style="position:relative; width:100%; height:100%; left:0; top:0;"></div>
			</div>
        </div>
    </div>
</body>
<script src='../common/js/lib/async.js'></script>
<script src='../common/js/lib/rxjs/rx.all.min.js'></script>
<script src='../common/js/lib/three.min.js'></script>
<script src='../common/js/lib/underscore/underscore-min.js'></script>
<script src='js/particle.js'></script>
<script src='js/api.js'></script>
<script src="js/haxe.js"></script>
<script type="text/javascript">
	
	document.addEventListener("contextmenu", function(e){
		e.preventDefault();
	}, false);
		
	var app = app || {};
	app.view = app.view || {};
	
	(function( module ){
		var event = $('<div></div>' );
		var tree_particle = $("#tree_particle" );
		var mc_imgs = $("#mc_imgs" );
		//var spr_value = $("#spr_value" );
		var spr_v1 = $("#spr_v1" );
		var spr_v2 = $("#spr_v2" );
		var spr_v3 = $("#spr_v3" );
		var spr_v4 = $("#spr_v4" );
		var spr_v5 = $("#spr_v5" );
		//var dgd_props = $("#dgd_props" );
		var mc_propContainer = $("#mc_propContainer" );
		var dgd_advprops = $("#dgd_advprops" );
		var combo_advProps = $("#combo_advProps" );
		var combo_advType = $("#combo_advType" );
		var webgl = $('#webgl' );
		var isMouseDown = false;
		var targetPos = [0.0, 0.0];
		var currentPos = [0.0, 0.0];
		var cpr_color = $('#cpr_color');
		var cpr_back = $('#cpr_back');
		var txt_count = $('#txt_count');
		var txt_fps = $('#txt_fps');
		
		vic.easyui.initColorPicker( cpr_color, 36, 36, '#ffffff' );
		cpr_color.on( 'onColorChange', function( e, options ){
			//event.trigger( 'onPropChange', options );
			
			event.trigger( 'onPropChange', { currentRow: {
				row:{
					id:'color',
					v:0,
					extra:options.rgb
				}
			} } );
		});
		
		vic.easyui.initColorPicker( cpr_back, 36, 36, 'black' );
		cpr_back.on( 'onColorChange', function( e, options ){
			event.trigger( 'onBackColorChange', options );
		});
		
		function setInfo( count, fps ){
			txt_count.html( count );
			txt_fps.html( fps );
		}
		
		function setParticleColor( r, g, b ){
			vic.easyui.setColorPickerColor(cpr_color,  {r:Math.floor( r* 255 ), g:Math.floor( g* 255 ), b:Math.floor( b* 255 )} );
		}
		
		var ary_propsModel = [ 	{id:'lifetime', name:'生命', random:true, friction:false}, 
								{id:'mass', name:'質量', random:true, friction:false}, 
								{id:'rot', name:'角度', random:true, friction:false}, 
								{id:'vx', name:'速度x', random:true, friction:true}, 
								{id:'vy', name:'速度y', random:true, friction:true}, 
								{id:'vr', name:'旋轉速度', random:true, friction:false}, 
								{id:'scale-x', name:'粒子寬度', random:true, friction:false}, 
								{id:'scale-y', name:'粒子高度', random:true, friction:false}, 
								{id:'emit-count', name:'發射數目', random:false, friction:false}, 
								{id:'emit-duration', name:'週期毫秒', random:false, friction:false}, 
								{id:'emit-angle', name:'發射角度', random:true, friction:false}, 
								{id:'emit-range', name:'發射範圍', random:true, friction:false}, 
								{id:'emit-force', name:'發射力道', random:true, friction:false}];
							
		_.each( ary_propsModel, function( prop ){
			var dom = $( '#tmpl_prop' ).tmpl( prop );
			mc_propContainer.append( dom );
			
			
			
			dom.find( '.easyui-numberspinner' ).numberspinner({
				onChange:function(nv, ov ){
					var type = $( this ).parent().parent().attr( 'ptype' );
					event.trigger( 'onPropChange', { currentRow: {
						row:{
							id:type,
							v:nv
						}
					} } );
				}
			});
			
			dom.find( '.easyui-linkbutton' ).linkbutton( {
				onClick:function(){
					var type = $( this ).parent().parent().attr( 'ptype' );
					var id = $( this ).attr( 'id' );
					var advrows = vic.easyui.getDatagridRows( dgd_advprops );
					var ary_randomRow = [];
					var ary_remainRow = [];
					switch( id ){
						case 'btn_rand':
							ary_randomRow = _.filter( advrows, function( row ){
								return ( row.id == type && row.tid == 'randStartAdd' );
							});
							ary_remainRow = _.filter( advrows, function( row ){
								return !( row.id == type && row.tid == 'randStartAdd' );
							});
							if( ary_randomRow.length == 0 ){
								ary_remainRow.unshift( {id:type, name:keyToName(type), tid:'randStartAdd', type:keyToName( 'randStartAdd' ), v1:100, v2:0, v3:0, v4:0, v5:0 } );
							}
							break;
						case 'btn_fric':
							ary_randomRow = _.filter( advrows, function( row ){
								return ( row.id == type && row.tid == 'constMul' );
							});
							ary_remainRow = _.filter( advrows, function( row ){
								return !( row.id == type && row.tid == 'constMul' );
							});
							if( ary_randomRow.length == 0 ){
								ary_remainRow.push( {id:type, name:keyToName(type), tid:'constMul', type:keyToName( 'constMul' ), v1:950, v2:0, v3:0, v4:0, v5:0 } );
							}
							break;
						case 'btn_custom':
							ary_randomRow = _.filter( advrows, function( row ){
								return ( row.id == type && row.tid == 'custom' );
							});
							ary_remainRow = _.filter( advrows, function( row ){
								return !( row.id == type && row.tid == 'custom' );
							});
							if( ary_randomRow.length == 0 ){
								ary_remainRow.push( {id:type, name:keyToName(type), tid:'custom', type:keyToName( 'custom' ), v1:0, v2:50, v3:100, v4:50, v5:0 } );
							}
							break;
					}
					
					setAdvDgdProp( ary_remainRow );
					event.trigger( 'onPropChange', { currentRow: currentAdvRow, rows:vic.easyui.getDatagridRows( dgd_advprops ) } );
					
				}
			});
			
			if( !prop.random ){
				dom.find( '.easyui-linkbutton' ).eq(0).linkbutton( 'disable' );
			}
			/*
			if( !prop.friction ){
				dom.find( '.easyui-linkbutton' ).eq(1).linkbutton( 'disable' );
			}
			*/
		});
		
		vic.easyui.initSprWheel( $('.easyui-numberspinner' ) );
		
		/*
		$('.easyui-numberspinner' ).numberspinner( {
			precision:1
		});
		*/
		
		var tid = undefined;
		function keepUpdateGrid( cb ){
			if( tid != undefined ){
				clearInterval( tid );
			}
			tid = setInterval( function(){
				clearInterval( tid );
				cb();
			}, 100 );
		}
		/*
		spr_value.numberspinner( {
			onChange:function( nv, ov ){
				if( currentRow != undefined ){
					currentRow.row.v = nv;
					keepUpdateGrid( function(){
						vic.easyui.updateDatagridRow( dgd_props, currentRow.index, currentRow.row );
					});
					event.trigger( 'onPropChange', { currentRow: currentRow } );
				}
			}
		});
		*/
		spr_v1.numberspinner( {
			onChange:function( nv, ov ){
				if( currentAdvRow != undefined ){
					currentAdvRow.row.v1 = nv;
					keepUpdateGrid( function(){
						vic.easyui.updateDatagridRow( dgd_advprops, currentAdvRow.index, currentAdvRow.row );
					});
					event.trigger( 'onPropChange', { currentRow: currentAdvRow, rows:vic.easyui.getDatagridRows( dgd_advprops ) } );
				}
			}
		});
		
		spr_v2.numberspinner( {
			onChange:function( nv, ov ){
				if( currentAdvRow != undefined ){
					currentAdvRow.row.v2 = nv;
					keepUpdateGrid( function(){
						vic.easyui.updateDatagridRow( dgd_advprops, currentAdvRow.index, currentAdvRow.row );
					});
					event.trigger( 'onPropChange', { currentRow: currentAdvRow, rows:vic.easyui.getDatagridRows( dgd_advprops ) } );
				}
			}
		});
		
		spr_v3.numberspinner( {
			onChange:function( nv, ov ){
				if( currentAdvRow != undefined ){
					currentAdvRow.row.v3 = nv;
					keepUpdateGrid( function(){
						vic.easyui.updateDatagridRow( dgd_advprops, currentAdvRow.index, currentAdvRow.row );
					});
					event.trigger( 'onPropChange', { currentRow: currentAdvRow, rows:vic.easyui.getDatagridRows( dgd_advprops ) } );
				}
			}
		});
		
		spr_v4.numberspinner( {
			onChange:function( nv, ov ){
				if( currentAdvRow != undefined ){
					currentAdvRow.row.v4 = nv;
					keepUpdateGrid( function(){
						vic.easyui.updateDatagridRow( dgd_advprops, currentAdvRow.index, currentAdvRow.row );
					});
					event.trigger( 'onPropChange', { currentRow: currentAdvRow, rows:vic.easyui.getDatagridRows( dgd_advprops ) } );
				}
			}
		});
		
		spr_v5.numberspinner( {
			onChange:function( nv, ov ){
				if( currentAdvRow != undefined ){
					currentAdvRow.row.v5 = nv;
					keepUpdateGrid( function(){
						vic.easyui.updateDatagridRow( dgd_advprops, currentAdvRow.index, currentAdvRow.row );
					});
					event.trigger( 'onPropChange', { currentRow: currentAdvRow, rows:vic.easyui.getDatagridRows( dgd_advprops ) } );
				}
			}
		});
		
		combo_advProps.combobox({
			onChange:function( nv, ov ){
				if( currentAdvRow != undefined ){
					currentAdvRow.row.id = nv;
					currentAdvRow.row.name = keyToName( currentAdvRow.row.id );
					vic.easyui.updateDatagridRow( dgd_advprops, currentAdvRow.index, currentAdvRow.row );
					setAdvLinkButton();
					event.trigger( 'onPropChange', { currentRow: currentAdvRow, rows:vic.easyui.getDatagridRows( dgd_advprops ) } );
				}
			}
		});
		
		var currentAdvRow = undefined;
		dgd_advprops.datagrid({
			onSelect:function( index, row ){
				currentAdvRow = {index:index, row:row};
				
				vic.easyui.setSpinnerValue( spr_v1, row.v1, false );
				vic.easyui.setSpinnerValue( spr_v2, row.v2, false );
				vic.easyui.setSpinnerValue( spr_v3, row.v3, false );
				vic.easyui.setSpinnerValue( spr_v4, row.v4, false );
				vic.easyui.setSpinnerValue( spr_v5, row.v5, false );
				vic.easyui.setComboxSelect( combo_advProps, row.id, false );
				vic.easyui.setComboxSelect( combo_advType, row.tid, false );
			}
		});
		
		combo_advType.combobox({
			onChange:function( nv, ov ){
				if( currentAdvRow != undefined ){
					currentAdvRow.row.tid = nv;
					currentAdvRow.row.type = keyToName( currentAdvRow.row.tid );
					vic.easyui.updateDatagridRow( dgd_advprops, currentAdvRow.index, currentAdvRow.row );
					setAdvLinkButton();
					event.trigger( 'onPropChange', { currentRow: currentAdvRow, rows:vic.easyui.getDatagridRows( dgd_advprops ) } );
				}
			}
		});
		/*
		var currentRow = undefined;
		dgd_props.datagrid({
			onSelect:function( index, row ){
				currentRow =  {index:index, row:row};
				vic.easyui.setSpinnerValue( spr_value, row.v, false );
			}
		});
		*/
		var currentNode = undefined;
		tree_particle.tree( {
			onSelect:function( node ){
				if( currentNode == node ) return;
				currentNode = node;
				event.trigger( 'onTreeClick', { node:node } );
			}
		});
		
		webgl.mousedown( onmousedown );
		webgl.mouseup( onmouseup );
		webgl.mousemove( onMousemove );
		
		function onMousemove(e) {
			var px = e.offsetX;
			var py = e.offsetY;
			if ( isMouseDown ) {
				targetPos[0] = px;
				targetPos[1] = py;
				event.trigger( 'onMouseMove', { targetPos:targetPos } );
			}
		}
		
		function onmousedown( e ) {
			isMouseDown = true;
		}
		
		function onmouseup( e ) {
			isMouseDown = false;
		}
		
		function appendImage( id, dom ){
			$( dom ).attr( 'id', id );
			$( dom ).css( 'width', '100px' );
			$( dom ).css( 'height', '100px' );
			mc_imgs.append( dom );
			
			mc_imgs.undelegate( 'click' );
			mc_imgs.delegate( 'img', 'click', function(){
				setImgFocus( $(this).attr( 'id' ) );
				event.trigger( 'onImgClick', { id: $(this).attr( 'id' ) } );
			});
		}
		
		function setImgFocus( imgId ){
			mc_imgs.find('img').each( function( id, dom ){
				$( dom ).removeClass( 'outline' );
				if( dom.id == imgId ){
					$( dom ).addClass( 'outline' );
				}
			});
		}
		
		function disableAllProps(){
			$( 'div[ptype]' ).each( function( id, dom ){
				$( dom ).hide();
				//$( dom ).find( '.easyui-numberspinner' ).numberspinner( 'disable' );
				//$( dom ).find( '.easyui-linkbutton' ).linkbutton( 'disable' );
			});
		}
		
		function setDgdProp( ary_props ){
			disableAllProps();
			_.each( ary_props, function( prop ){
				var type = prop.id;
				var value = prop.v;
				var spr = $( 'div[ptype="' + type + '"]' ).find( '#spr_value' );
				spr.parent().parent().show();
				spr.numberspinner( 'enable' );
				vic.easyui.setSpinnerValue( spr, value, false );
			});
		/*
			vic.easyui.setDatagridRows( dgd_props, ary_props );
			if( ary_props.length > 0 )
				vic.easyui.selectDatagridRow( dgd_props, 0 );
				*/
		}

		
		function setAdvDgdProp( ary_props ){
			vic.easyui.setDatagridRows( dgd_advprops, ary_props );
			if( ary_props.length > 0 ){
				vic.easyui.selectDatagridRow( dgd_advprops, 0 );
			}
			setAdvLinkButton();
		}
		
		function setAdvLinkButton(){
			_.each( ary_propsModel, function( prop ){
				var dom = $( 'div[ptype="' + prop.id + '"]' );
				dom.find( '.easyui-linkbutton' ).eq(0).linkbutton( 'unselect' );
				dom.find( '.easyui-linkbutton' ).eq(1).linkbutton( 'unselect' );
				dom.find( '.easyui-linkbutton' ).eq(2).linkbutton( 'unselect' );
			});
			
			var ary_props = vic.easyui.getDatagridRows( dgd_advprops, ary_props );
			
			_.each( ary_props, function( prop ){
				switch( prop.tid ){
					case 'randStartAdd':
						var dom = $( 'div[ptype="' + prop.id + '"]' );
						dom.find( '.easyui-linkbutton' ).eq(0).linkbutton( 'select' );
						break;
					case 'constMul':
						var dom = $( 'div[ptype="' + prop.id + '"]' );
						dom.find( '.easyui-linkbutton' ).eq(1).linkbutton( 'select' );
						break;
					case 'custom':
						var dom = $( 'div[ptype="' + prop.id + '"]' );
						dom.find( '.easyui-linkbutton' ).eq(2).linkbutton( 'select' );
						break;
						/*
					case 'fvx':
						var dom = $( 'div[ptype="' + prop.id + '"]' );
						dom.find( '.easyui-linkbutton' ).eq(1).linkbutton( 'select' );
						break;
					case 'fvy':
						var dom = $( 'div[ptype="' + prop.id + '"]' );
						dom.find( '.easyui-linkbutton' ).eq(1).linkbutton( 'select' );
						break;
						*/
				}
			});
		}
		
		function setTree( nodes, selectId ){
			vic.easyui.setTree( tree_particle, nodes );
			
			setTimeout( function(){
				vic.easyui.selectTreeNode( tree_particle,vic.easyui.getTreeNodeById( tree_particle, selectId ));
				event.trigger( 'onViewTreeChange' );
			}, 10 );
		}
		
		function addTree( model ){
			if( currentNode == undefined ){
				vic.easyui.appendTree( tree_particle, vic.easyui.getTreeNodeById( tree_particle, 0 ), { id:model.id, text:model.name, particle:model } );
			}else{
				vic.easyui.appendTree( tree_particle, currentNode, { id:model.id , text:model.name, particle:model } );
			}
			event.trigger( 'onViewTreeChange' );
		}
		
		function removeTree(){
			if( currentNode != undefined ){
				vic.easyui.removeTree( tree_particle, currentNode );
				currentNode = undefined;
				event.trigger( 'onViewTreeChange' );
			}
		}
		
		function addAdvProp(){
			var newf = {
				id: combo_advProps.combobox( 'getValue' ),
				tid: combo_advType.combobox( 'getValue' ),
				name: keyToName( combo_advProps.combobox( 'getValue' ) ),
				type: keyToName( combo_advType.combobox( 'getValue' ) ),
				v1: spr_v1.numberspinner( 'getValue' ),
				v2: spr_v2.numberspinner( 'getValue' ),
				v3: spr_v3.numberspinner( 'getValue' ),
				v4: spr_v4.numberspinner( 'getValue' ),
				v5: spr_v5.numberspinner( 'getValue' )
			};
			vic.easyui.appendDatagridRow( dgd_advprops, newf );
			vic.easyui.selectDatagridRow( dgd_advprops, vic.easyui.getDatagridRows( dgd_advprops ).length - 1 );
			
			setAdvLinkButton();
			event.trigger( 'onPropChange', { currentRow: currentAdvRow, rows:vic.easyui.getDatagridRows( dgd_advprops ) } );
		}
		
		function removeAdvProp(){
			if( currentAdvRow != undefined ){
				vic.easyui.deleteDatagridRow( dgd_advprops, currentAdvRow.index );
				currentAdvRow = undefined;
				var ary_rows = vic.easyui.getDatagridRows( dgd_advprops );
				if( ary_rows.length > 0 ){
					vic.easyui.selectDatagridRow( dgd_advprops, vic.easyui.getDatagridRows( dgd_advprops ).length - 1 );
				}
				
				setAdvLinkButton();
			}
			event.trigger( 'onPropChange', { currentRow: currentAdvRow, rows:vic.easyui.getDatagridRows( dgd_advprops ) } );
		}
		
		function upMove(){
			if( currentAdvRow != undefined ){
				if( currentAdvRow.index > 0 ){
					vic.easyui.deleteDatagridRow( dgd_advprops, currentAdvRow.index );
					vic.easyui.insertDatagridRow( dgd_advprops, currentAdvRow.index - 1, currentAdvRow.row );
					vic.easyui.selectDatagridRow( dgd_advprops, currentAdvRow.index - 1 );
				}
			}
			
			event.trigger( 'onPropChange', { currentRow: currentAdvRow, rows:vic.easyui.getDatagridRows( dgd_advprops ) } );
		}
		
		function downMove(){
			if( currentAdvRow != undefined ){
				var maxCount = vic.easyui.getDatagridRows( dgd_advprops ).length;
				if( currentAdvRow.index < maxCount - 1 ){
					vic.easyui.deleteDatagridRow( dgd_advprops, currentAdvRow.index );
					vic.easyui.insertDatagridRow( dgd_advprops, currentAdvRow.index + 1 , currentAdvRow.row );
					vic.easyui.selectDatagridRow( dgd_advprops, currentAdvRow.index + 1 );
				}
			}
			
			event.trigger( 'onPropChange', { currentRow: currentAdvRow, rows:vic.easyui.getDatagridRows( dgd_advprops ) } );
		}
		
		function getTreeRootNode(){
			return vic.easyui.getTreeNodeById( tree_particle, 0 );
		}
		
		module.webgl = webgl;
		module.tree_particle = tree_particle;
		module.addTree = addTree;
		module.removeTree = removeTree;
		module.addAdvProp = addAdvProp;
		module.removeAdvProp = removeAdvProp;
		module.upMove = upMove;
		module.downMove = downMove;
		module.setTree = setTree;
		module.setDgdProp = setDgdProp;
		module.setAdvDgdProp = setAdvDgdProp;
	//	module.setAdvLinkButton = setAdvLinkButton;
		module.getTreeRootNode = getTreeRootNode;
		module.appendImage = appendImage;
		module.setImgFocus = setImgFocus;
		module.setParticleColor = setParticleColor;
		module.setInfo = setInfo;
		module.event = event;
	})( app.view );
	
	
	var app = app || {};
	app.model = app.model || {};
	
	(function( module ){
		var particles =  {  
			  "id":0,
			  "name":"粒子",
			  "lifetime":0,
			  "vel":[  
				 0,
				 0,
				 0
			  ],
			  "pos":[  
				 0,
				 0,
				 0
			  ],
			  "mass":1,
			  "color":[  
				 1,
				 1,
				 1,
				 1
			  ],
			  "size":[  
				 40,
				 40
			  ],
			  "formulaList":[],
			  "tex":"0",
			  "blending":"add",
			  "emit":{  
				 "prototype":[  
					{  
					   "id":"1",
					   "name":"粒子",
					   "lifetime":2,
					   "vel":[  
						  0,
						  0,
						  0
					   ],
					   "pos":[  
						  0,
						  0,
						  0
					   ],
					   "mass":1,
					   "color":[  
						  1,
						  1,
						  1,
						  1
					   ],
					   "size":[  
						  40,
						  40
					   ],
					   "tex":0,
					   "blending":"add",
					   "formulaList":[ 
							
					   ]
					}
				 ],
				 "count":1,
				 "duration":0.05,
				 "angle":0,
				 "range":0,
				 "force":0
			  }
		   }
		   
		   var event = $('<div></div>' );
		   /*
		particles.emit.prototype[0].view = {
			easyAdv:[
				{id:'lifetime', tid:'randStartAdd', show:false, v1:20, v2:0, v3:0, v4:0, v5:0 }, 
				{id:'mass', tid:'randStartAdd', show:false, v1:10, v2:0, v3:0, v4:0, v5:0 }, 
				{id:'rot', tid:'randStartAdd', show:false, v1:0, v2:0, v3:0, v4:0, v5:0 }, 
				{id:'vx', tid:'randStartAdd', show:true, v1:100, v2:0, v3:0, v4:0, v5:0 }, 
				{id:'vx', tid:'fvx', show:false, v1:0, v2:0, v3:0, v4:0, v5:0 }, 
				{id:'vy', tid:'randStartAdd', show:true, v1:100, v2:0, v3:0, v4:0, v5:0 }, 
				{id:'vy', tid:'fvx', show:false, v1:0, v2:0, v3:0, v4:0, v5:0 }, 
				{id:'vr', tid:'randStartAdd', show:false, v1:1, v2:0, v3:0, v4:0, v5:0 }, 
				{id:'scale-x', tid:'randStartAdd', show:false, v1:0, v2:0, v3:0, v4:0, v5:0 }, 
				{id:'scale-y', tid:'randStartAdd', show:false, v1:0, v2:0, v3:0, v4:0, v5:0 }, 
				{id:'emit-count', tid:'randStartAdd', show:false, v1:0, v2:0, v3:0, v4:0, v5:0 }, 
				{id:'emit-duration', tid:'randStartAdd', show:false, v1:0, v2:0, v3:0, v4:0, v5:0 }, 
				{id:'emit-angle', tid:'randStartAdd', show:false, v1:0, v2:0, v3:0, v4:0, v5:0 }, 
				{id:'emit-range', tid:'randStartAdd', show:false, v1:0, v2:0, v3:0, v4:0, v5:0 }, 
				{id:'emit-force', tid:'randStartAdd', show:false, v1:0, v2:0, v3:0, v4:0, v5:0 }
			]
		}
		*/
		
		var ary_elapsedTime = [];
		api.addEventListener( function ( info ) {
			switch( info[0] ) {
				case 'tick':
					var elapsedTime = info[1];
					if ( ary_elapsedTime.length > 20 ) {
						ary_elapsedTime.shift();
					}
					ary_elapsedTime.push( elapsedTime );
					
					var sum = _.reduce( ary_elapsedTime, function( t, curr ) {
						return curr + t;
					}, 0 );
					
					var fps = Math.ceil( 1 / ( sum / ary_elapsedTime.length ));
					
					api.info( function( err, data ) {
						if ( err == null ) {
							event.trigger( 'onInfoChange', {count:data.count, fps:fps} );
						}
					});
			}
		});
		
		
		function getParticles(){
			return particles;
		}
		
		function createParticle( id, name ){
			return { 
				"id":id,
				"name":name,
				"lifetime":1,
				"vel":[  
				 0,
				 0,
				 0
				],
				"pos":[  
				 0,
				 0,
				 0
				],
				"mass":1,
				"color":[  
				 1,
				 1,
				 1,
				 1
				],
				"size":[  
				 40,
				 40
				],
				"formulaList":[],
				"tex":"0",
				"blending":"add"
			}
		}
		
		module.getParticles = getParticles;
		module.createParticle = createParticle;
		module.event = event;
	})( app.model );
	
	
//	['images/fire_128_128.jpg'];
	
	loadImages( [
					{id:0, path:'images/glow.jpg' },
					{id:1, path:'images/leadB_32_32.png' },
					{id:2, path:'images/fire_128_128.jpg' },
					{id:3, path:'images/smoke_128_128_half_hlaf.png' }
				] );
	
	function loadImages( ary_image ){
		var imgItem = ary_image.shift();
		loadImage( imgItem.path, function( img ) {
			app.view.appendImage( imgItem.id, img );
			api.addTexture( imgItem.id, img );
		});
		if( ary_image.length > 0 ){
			loadImages( ary_image );
		}else{
			appStart( app.view, app.model );
		}
	}
	
	function appStart( view, model ){
		var webgl = view.webgl;
		var currentParticle = undefined;
		
		api.init( webgl );
		
		var particles = model.getParticles();
		
		var treeModel = {};
		modelToTree( particles, treeModel );
		console.log( treeModel );
		view.setTree( [ {
			id:'root',
			text:'渲染層',
			children:[treeModel]
		} ], 1 );
		
		view.event.on( 'onBackColorChange', function( e, options ){
			api.changeBgColor( options.rgb.r / 255, options.rgb.g / 255, options.rgb.b / 255 );
		});
		
		model.event.on( 'onInfoChange', function( e, options ){
			view.setInfo( options.count, options.fps );
		});
		
		view.event.on( 'onViewTreeChange', function( e, options ){
			updateRender();
		});
		
		view.event.on( 'onTreeClick', function( e, options ){
			if( options.node.particle == undefined ) return;
			view.setDgdProp( (function( node ){
				var p = node.particle;
				
				if( vic.easyui.getTreeIsLeaf( view.tree_particle, node ) ){
					return [
						{id:'lifetime', name:'生命毫秒', v: p.lifetime * 1000 },
						{id:'mass', name:'質量', v: p.mass},
						{id:'rot', name:'角度', v: radianToDegree( p.pos[2] )},
						{id:'vx', name:'速度x', v: p.vel[0]},
						{id:'vy', name:'速度y', v: p.vel[1]},
						{id:'vr', name:'轉速', v: radianToDegree( p.vel[2] )},
						{id:'scale-x', name:'寬度', v: p.size[0]},
						{id:'scale-y', name:'高度', v: p.size[1]}
					];
				}
				return [
					{id:'lifetime', name:'生命毫秒', v: p.lifetime * 1000 },
					{id:'mass', name:'質量', v: p.mass},
					{id:'rot', name:'角度', v: radianToDegree( p.pos[2] )},
					{id:'vx', name:'速度x', v: p.vel[0]},
					{id:'vy', name:'速度y', v: p.vel[1]},
					{id:'vr', name:'轉速', v: radianToDegree( p.vel[2] )},
					{id:'scale-x', name:'寬度', v: p.size[0]},
					{id:'scale-y', name:'高度', v: p.size[1]},
					{id:'emit-count', name:'發射數目', v: p.emit.count},
					{id:'emit-duration', name:'發射週期', v: p.emit.duration * 1000 },
					{id:'emit-angle', name:'發射角度', v: radianToDegree( p.emit.angle )},
					{id:'emit-range', name:'發射範圍', v: radianToDegree( p.emit.range )},
					{id:'emit-force', name:'發射力道', v: p.emit.force}
				];
			})( options.node ));
			
			if( options.node.particle.formulaList != undefined ){
				view.setAdvDgdProp((function( node ){
					var p = node.particle;
					return _.map( p.formulaList, function( f ){
						var retobj = {
							id:f[0], tid:f[1], name:keyToName(f[0]), type:keyToName(f[1]), v1:f[2], v2:f[3], v3:f[4], v4:f[5], v5:f[6]
						}
						switch( retobj.id ){
							case 'rot':
							case 'vr':
							case 'emit-range':
							case 'emit-angle':
								retobj.v1 = radianToDegree( retobj.v1 );
								retobj.v2 = radianToDegree( retobj.v2 );
								retobj.v3 = radianToDegree( retobj.v3 );
								retobj.v4 = radianToDegree( retobj.v4 );
								retobj.v5 = radianToDegree( retobj.v5 );
								break;
							case 'lifetime':
								retobj.v1 = retobj.v1 * 1000;
								retobj.v2 = retobj.v2 * 1000;
								retobj.v3 = retobj.v3 * 1000;
								retobj.v4 = retobj.v4 * 1000;
								retobj.v5 = retobj.v5 * 1000;
								break;
						}
						
						switch( retobj.tid ){
							case 'linearMul','constMul':
								retobj.v1 = retobj.v1 * 1000;
								retobj.v2 = retobj.v2 * 1000;
								retobj.v3 = retobj.v3 * 1000;
								retobj.v4 = retobj.v4 * 1000;
								retobj.v5 = retobj.v5 * 1000;
						}
						
						return retobj;
					});
				})( options.node ));
			}
			
			view.setImgFocus( options.node.particle.tex );
			view.setParticleColor( options.node.particle.color[0], options.node.particle.color[1], options.node.particle.color[2] );
			
			currentParticle = options.node.particle;
		});
		
		view.event.on( 'onMouseMove', function( e, options ){
			var renderRoots = vic.easyui.getTreeNodeById( view.tree_particle, 'root' );
			if( renderRoots.children.length > 0 ){
				_.each( renderRoots.children, function( root ){
					var rootParticle = root.particle;
					rootParticle.pos[0] = options.targetPos[0];
					rootParticle.pos[1] = options.targetPos[1];
				});
			}
			updateRender();
		});
		
		view.event.on( 'onImgClick', function( e, options ){
			currentParticle.tex = options.id;
			updateRender();
		});
		
		view.event.on( 'onDgdPropsClick', function( e, options ){
			//console.log( options );
		});
		
		view.event.on( 'onPropChange', function( e, options ){
			if( currentParticle == undefined ) return;
			if( options.currentRow == undefined ) {
				currentParticle.formulaList = [];
				return;
			}
			var row = options.currentRow.row;
			var rows = options.rows;
			if( rows != undefined ){
				currentParticle.formulaList = _.map( rows, function( r ){
					
					var retobj = [r.id, r.tid, 
								parseInt( r.v1 ),
								parseInt( r.v2 ),
								parseInt( r.v3 ),
								parseInt( r.v4 ),
								parseInt( r.v5 )];
								
					switch( r.id ){
						case 'rot':
						case 'vr':
						case 'emit-range':
						case 'emit-angle':
							retobj[2] = degreeToRadian( retobj[2] );
							retobj[3] = degreeToRadian( retobj[3] );
							retobj[4] = degreeToRadian( retobj[4] );
							retobj[5] = degreeToRadian( retobj[5] );
							retobj[6] = degreeToRadian( retobj[6] );
							break;
						case 'lifetime':
							retobj[2] = retobj[2] / 1000;
							retobj[3] = retobj[3] / 1000;
							retobj[4] = retobj[4] / 1000;
							retobj[5] = retobj[5] / 1000;
							retobj[6] = retobj[6] / 1000;
							break;
					}
					
					switch( r.tid ){
						case 'linearMul','constMul':
							retobj[2] = retobj[2] / 1000;
							retobj[3] = retobj[3] / 1000;
							retobj[4] = retobj[4] / 1000;
							retobj[5] = retobj[5] / 1000;
							retobj[6] = retobj[6] / 1000;
							break;
					}
					
					return retobj;
				});
				
			}else{
				row.v = parseInt( row.v );
				switch( row.id ){
					case 'color':
						currentParticle.color[0] = row.extra.r / 255;
						currentParticle.color[1] = row.extra.g / 255;
						currentParticle.color[2] = row.extra.b / 255;
						break;
					case 'lifetime':
						currentParticle.lifetime = ( row.v / 1000 ); break;
					case 'rot':
						currentParticle.pos[2] = degreeToRadian( row.v );break;
					case 'vx':
						currentParticle.vel[0] = row.v; break;
					case 'vy':
						currentParticle.vel[1] = row.v; break;
					case 'vr':
						currentParticle.vel[2] = degreeToRadian( row.v ); break;
					case 'scale-x':
						currentParticle.size[0] = row.v; break;
					case 'scale-y':
						currentParticle.size[1] = row.v; break;
					case 'emit-count':
						currentParticle.emit.count = row.v; break;
					case 'emit-duration':
						currentParticle.emit.duration = ( row.v / 1000 ); break;
					case 'emit-range':
						currentParticle.emit.range = degreeToRadian( row.v ); break;
					case 'emit-angle':
						currentParticle.emit.angle = degreeToRadian( row.v ); break;
					case 'emit-force':
						currentParticle.emit.force = row.v; break;
					default:
						currentParticle[row.id] = row.v;
				}
			}
			updateRender();
		});
		
		function updateRender(){
			var renderRoots = vic.easyui.getTreeNodeById( view.tree_particle, 'root' );
			if( renderRoots.children.length > 0 ){
				_.each( renderRoots.children, function( root ){
					var retobj = { };
					treeToModel( vic.easyui.getTreeNodeById( view.tree_particle, root.id ), retobj );
					console.log( retobj );
					try{
						api.editParticle( retobj );
					}catch( e ){
						//還不知道錯在哪裡，先catch起來
						console.log( e );
						
					}
				});
			}
		}
		
		function modelToTree( fields, retobj ) {
			retobj.id = fields.id;
			retobj.text = fields.name;
			retobj.particle = fields;
			
			if ( fields.emit != undefined ) {
				retobj.children = [];
				_.each( fields.emit.prototype, function( p ){
					var tobj = {};
					retobj.children.push( tobj );
					modelToTree( p, tobj );
				});
			}
		}
		
		function treeToModel( node, outputData ) {
			var particleData = node.particle;
			outputData.id = particleData.id;
			outputData.lifetime = particleData.lifetime;
			outputData.vel = particleData.vel;
			outputData.pos = particleData.pos;
			outputData.mass = particleData.mass;
			outputData.color = particleData.color;
			outputData.size = particleData.size;
			outputData.tex = particleData.tex;
			outputData.blending = particleData.blending;
			outputData.formulaList = deepCopy( particleData.formulaList );
			
			if ( node.children && node.children.length > 0 ) {
				if( particleData.emit == undefined ){
					particleData.emit = {};
					particleData.emit.count = 1;
					particleData.emit.duration = .5;
					particleData.emit.angle = 0;
					particleData.emit.range = 0;
					particleData.emit.force = 100;
				}
				particleData.emit.prototype = [];
				if( outputData.emit == undefined ){
					outputData.emit = deepCopy( node.particle.emit );
				}
				_.each( node.children, function( nc ){
					var obj = { };
					outputData.emit.prototype.push( obj );
					treeToModel( nc, obj );
				});
			}
		}
	}
	
	function keyToName( key ){
		switch( key ){
			case 'lifetime':return '生命毫秒'; break;
			case 'mass':return '質量'; break;
			case 'x':return '位置x';break;
			case 'y':return '位置y';break;
			case 'rot':return '角度';break;
			case 'vx':return '速度x';break;
			case 'vy':return '速度y';break;
			case 'vr':return '轉速';break;
			case 'fvx':return '作用力x';break;
			case 'fvy':return '作用力y';break;
			case 'fvr':return '作用力旋轉';break;
			case 'scale-x':return '寬度';break;
			case 'scale-y':return '高度';break;
			case 'r':return '紅';break;
			case 'g':return '綠';break;
			case 'b':return '藍';break;
			case 'a':return 'alpha';break;
			case 'emit-angle':return '發射角度';break;
			case 'emit-range':return '發射範圍';break;
			case 'emit-count':return '發射數目';break;
			case 'emit-force':return '發射力道';break;
			case 'emit-duration':return '發射週期';break;
			case 'const':return '常數';break;
			case 'constAdd':return '常數累加';break;
			case 'constMul':return '常數累乘';break;
			case 'linear':return '線性';break;
			case 'linearAdd':return '線性累加';break;
			case 'linearMul':return '線性累乘';break;
			case 'randStartAdd':return '亂數開始';break;
			case 'rand':return '亂數重設';break;
			case 'randAdd':return '亂數累加';break;
			case 'custom':return '自訂';break;
		}
	}
	
	function deepCopy( obj ){
		return JSON.parse( JSON.stringify( obj ));
	}
	
	function radianToDegree( r ){
		return r / Math.PI * 180;
	}
	
	function degreeToRadian( d ){
		return d / 180 * Math.PI;
	}
	
	function getUid(){
		return leo.utils.generateUUID();
	}
	
	function loadImage( src, cb ) {
		var img = new Image();
		img.src = src;
		img.onload = function() {
			cb( img );
		};
	}
	
	function onHtmlClick( dom ){
		switch( dom.id ){
			case 'btn_addTree':
				var uid = getUid();
				app.view.addTree( app.model.createParticle( uid, uid ) );
				break;
			case 'btn_removeTree':
				app.view.removeTree();
				break;
			case 'btn_addAdvProp':
				app.view.addAdvProp();
				break;
			case 'btn_removeAdvProp':
				app.view.removeAdvProp();
				break;
			case 'btn_upMove':
				app.view.upMove();
				break;
			case 'btn_downMove':
				app.view.downMove();
				break;
		}
	}
</script>

</html>