<html>
	<head>
		<title>幽夢幻境</title>
		<meta charset="utf-8"/>
		<link rel="stylesheet" type="text/css" href="../common/js/lib/jquery-easyui-1.4.3/themes/black/easyui.css">
		<link rel="stylesheet" type="text/css" href="../common/js/lib/jquery-easyui-1.4.3/themes/icon.css">
		<link rel="stylesheet" type="text/css" href="../common/css/normalize.css">
			
		<script type="text/javascript" src="../common/js/lib/rectSelect/rectSelect.js"></script>
		<link rel="stylesheet" type="text/css" href="../common/js/lib/rectSelect/rectSelect.css">
			
		<script type="text/javascript" src="../common/js/lib/leo.utils.js"></script>
		<script type="text/javascript" src="../common/js/lib/jquery-easyui-1.4.3/jquery.min.js"></script>
		<script type="text/javascript" src="../common/js/lib/jquery-easyui-1.4.3/jquery.easyui.min.js"></script>
		<script type="text/javascript" src="../common/js/lib/vic/vic.easyui.js"></script>
		<script type="text/javascript" src="../common/js/lib/jquery/jquery.cookie.js"></script>
		<script type="text/javascript" src="../common/js/lib/jquery/jquery.tmpl.min.js"></script>
		<script type="text/javascript" src="../common/js/lib/myapp.facebook.js"></script>
	</head>
	<style>
	body{
		-webkit-touch-callout: none;
		-webkit-user-select: none;
		-khtml-user-select: none;
		-moz-user-select: none;
		-ms-user-select: none;
		user-select: none;
		outline: 0;
	}

	.hori{
		display:inline-block;
	}
	
	.group{
		position:relative; 
		width:100%;
		min-width:250px;
	}
	
	.textImg{
		position:relative;
		width:100px;
		height:100px;
		margin-left:5px;
		display:inline-block;
		cursor:pointer;
	}
	
	.outline{
		outline:red solid 2px;
	}
	
	</style>
	
</head>
<script id="tmpl_prop" type="jquery-x-tmpl">
	<div title="生命毫秒" style="overflow:auto; padding-top:10px;">
		<div class="group" style="text-align:center; margin-bottom:5px;">
			<div class="hori"><input class="easyui-numberspinner" style="width:80px;"></input></div>
			<div class="hori"><input class="easyui-numberspinner" style="width:80px;"></input></div>
			<div class="hori"><input class="easyui-numberspinner" style="width:80px;"></input></div>
			<div class="hori"><input class="easyui-numberspinner" style="width:80px;"></input></div>
			<div class="hori"><input class="easyui-numberspinner" style="width:80px;"></input></div>
		</div>
		<div class="group" style="text-align:center; margin-bottom:5px;">
			<div class="hori">
				<select id="cc" class="easyui-combobox" name="dept" style="width:100px;">
					<option value="aa">aitem1</option>
					<option>bitem2</option>
					<option>bitem3</option>
					<option>ditem4</option>
					<option>eitem5</option>
				</select>
			</div>
			<div class="hori"> <a href="#" class="easyui-linkbutton" data-options="iconCls:'icon-add'">新增</a></div>
			<div class="hori"> <a href="#" class="easyui-linkbutton" data-options="iconCls:'icon-remove'">刪除</a></div>
			<div class="hori"> <a href="#" class="easyui-linkbutton" data-options="iconCls:'icon-up'">上移</a></div>
			<div class="hori"> <a href="#" class="easyui-linkbutton" data-options="iconCls:'icon-down'">下移</a></div>
		</div>
		<table class="easyui-datagrid" style="width:100%; height:200px;">
			<thead>
				<tr>
					<th data-options="field:'type',width:'14%'">種類</th>
					<th data-options="field:'v1',width:'14%'">參數1</th>
					<th data-options="field:'v2',width:'14%'">參數2</th>
					<th data-options="field:'v3',width:'14%'">參數3</th>
					<th data-options="field:'v4',width:'14%'">參數4</th>
					<th data-options="field:'v5',width:'14%'">參數5</th>
				</tr>
			</thead>
			<tbody>
				<tr>
					<td>001</td><td>name1</td><td>2323</td>
				</tr>
				<tr>
					<td>002</td><td>name2</td><td>4612</td>
				</tr>
			</tbody>
		</table>
	</div>
</script>
<body>
	<div class="easyui-layout" style="width:100%;height:100%;">
        <div data-options="region:'north'" style="height:50px"></div>
        <div data-options="region:'west',split:true" title="West" style="width:600px;">
			<div class="easyui-layout" style="width:100%;height:100%;">
				<div data-options="region:'north',split:true" style="height:300px">
					<div class="group" style="text-align:center;">
						<div class="hori"><a id="btn_addTree" href="#" class="easyui-linkbutton" onclick="onHtmlClick(this)" data-options="iconCls:'icon-search'">新增</a></div>
						<div class="hori"><a id="btn_removeTree" href="#" class="easyui-linkbutton" onclick="onHtmlClick(this)" data-options="iconCls:'icon-search'">刪除</a></div>
					</div>
					<div class="group">
						<ul id="tree_particle" class="easyui-tree" data-options="dnd:true">
						
						</ul>
					</div>
					
				</div>
				<div data-options="region:'center',title:'Main Title',iconCls:'icon-ok'">
					<div class="easyui-tabs" style="width:100%;height:100%">
						<div title="基本參數">
							<div class="group" style="height:100%;">
								<div class="group" style="text-align:center; margin-bottom:5px;">
									<div class="hori"><input id="spr_value" class="easyui-numberspinner" style="width:80px;"></input></div>
								</div>
								<div class="group" style="height:100%; text-align:center;">
									<div class="hori" style="width:50%; height:100%;">
										<table id="dgd_props" class="easyui-datagrid" data-options="fitColumns:true,singleSelect:true" style="width:100%;">
											<thead>
												<tr>
													<th data-options="field:'name',width:'53%'">屬性</th>
													<th data-options="field:'v',width:'53%'">參數1</th>
												</tr>
											</thead>
										</table>
									</div>
								</div>
							</div>
						</div>
						<div title="進階參數">
							<div class="group" style="height:100%;">
								<div class="group" style="text-align:center; margin-bottom:5px;">
									<div class="hori"><input class="easyui-numberspinner" style="width:80px;"></input></div>
									<div class="hori"><input class="easyui-numberspinner" style="width:80px;"></input></div>
									<div class="hori"><input class="easyui-numberspinner" style="width:80px;"></input></div>
									<div class="hori"><input class="easyui-numberspinner" style="width:80px;"></input></div>
									<div class="hori"><input class="easyui-numberspinner" style="width:80px;"></input></div>
								</div>
								<div class="group" style="text-align:center; margin-bottom:5px;">
									<div class="hori">
										<select id="combo_props" class="easyui-combobox" name="dept" style="width:100px;">
										</select>
									</div>
									<div class="hori">
										<select id="combo_type" class="easyui-combobox" name="dept" style="width:100px;">
											<option value="aa">aitem1</option>
											<option>bitem2</option>
											<option>bitem3</option>
											<option>ditem4</option>
											<option>eitem5</option>
										</select>
									</div>
									<div class="hori"> <a href="#" id="btn_addProp" class="easyui-linkbutton" onclick="onHtmlClick(this)" data-options="iconCls:'icon-add'">新增</a></div>
									<div class="hori"> <a href="#" id="btn_removeProp" class="easyui-linkbutton" onclick="onHtmlClick(this)" data-options="iconCls:'icon-remove'">刪除</a></div>
									<div class="hori"> <a href="#" id="btn_upMove" class="easyui-linkbutton" onclick="onHtmlClick(this)" data-options="iconCls:'icon-undo'">上移</a></div>
									<div class="hori"> <a href="#" id="btn_downMove" class="easyui-linkbutton" onclick="onHtmlClick(this)" data-options="iconCls:'icon-redo'">下移</a></div>
								</div>
								<div class="group" style="height:100%;">
									<table id="dgd_advprops" class="easyui-datagrid" data-options="singleSelect:true" style="width:100%;">
										<thead>
											<tr>
												<th data-options="field:'id',width:'14%'">屬性</th>
												<th data-options="field:'type',width:'14%'">種類</th>
												<th data-options="field:'v1',width:'15%'">參數1</th>
												<th data-options="field:'v2',width:'15%'">參數2</th>
												<th data-options="field:'v3',width:'15%'">參數3</th>
												<th data-options="field:'v4',width:'15%'">參數4</th>
												<th data-options="field:'v5',width:'15%'">參數5</th>
											</tr>
										</thead>
									</table>
								</div>
							</div>
						</div>
					</div>
					
					
				   
				</div>
			</div>
		</div>
        <div data-options="region:'center',title:'Main Title',iconCls:'icon-ok'">
           <div id="canvas_container" style="position:relative; width:100%; height:100%">
				<div id="webgl" style="position:relative; width:100%; height:100%; left:0; top:0;"></div>
				<!--
				<canvas id='webgl' width=800 height=600></canvas>
				-->
			</div>
        </div>
    </div>
</body>
<script src='../common/js/lib/async.js'></script>
<script src='../common/js/lib/rxjs/rx.all.min.js'></script>
<script src='../common/js/lib/three.min.js'></script>
<script src='../common/js/lib/underscore/underscore-min.js'></script>
<script src='js/particle.js'></script>
<script src='js/api.js'></script>
<script src="js/haxe.js"></script>
<script type="text/javascript">

	var app = app || {};
	app.view = app.view || {};
	
	(function( module ){
		var event = $('<div></div>' );
		var tree_particle = $("#tree_particle" );
		var spr_value = $("#spr_value" );
		var dgd_props = $("#dgd_props" );
		var dgd_advprops = $("#dgd_advprops" );
		var combo_props = $("#combo_props" );
		var webgl = $('#webgl' );
		var isMouseDown = false;
		var targetPos = [0.0, 0.0];
		var currentPos = [0.0, 0.0];
		var ary_props = [ 	{id:'life', name:'生命'}, 
							{id:'x', name:'位置x'}, 
							{id:'y', name:'位置y'}, 
							{id:'rot', name:'弧度'}, 
							{id:'vx', name:'速度x'}, 
							{id:'vy', name:'速度y'}, 
							{id:'vr', name:'旋轉速度'}, 
							{id:'scale-x', name:'粒子寬度'}, 
							{id:'scale-y', name:'粒子高度'}, 
							{id:'r', name:'紅'}, 
							{id:'g', name:'綠'}, 
							{id:'b', name:'藍'}, 
							{id:'a', name:'alpha'}, 
							{id:'emit-count', name:'發射數目'}, 
							{id:'emit-duration', name:'週期毫秒'}, 
							{id:'emit-angle', name:'發射弧度'}, 
							{id:'emit-range', name:'發射範圍'}, 
							{id:'emit-force', name:'發射力道'}];
		
		vic.easyui.setCombobox( combo_props, _.map( ary_props, function( prop ){
			return { label:prop.name, value:prop.id};
		}) );
		
		vic.easyui.setComboxSelect( combo_props, 'life' );
		vic.easyui.initSprWheel( $('.easyui-numberspinner' ) );
		
		$('.easyui-numberspinner' ).numberspinner( {
		//	precision:1,
			onChange:function( nv, ov ){
				console.log( nv );
			}
		});
		
		
		var tid = undefined;
		function keepUpdateGrid(){
			if( tid != undefined ){
				clearInterval( tid );
			}
			tid = setInterval( function(){
				clearInterval( tid );
				vic.easyui.updateDatagridRow( dgd_props, currentRow.index, currentRow.row );
			}, 100 );
		}
		
		spr_value.numberspinner( {
			onChange:function( nv, ov ){
				if( currentRow != undefined ){
					currentRow.row.v = nv;
					keepUpdateGrid();
					event.trigger( 'onPropChange', { currentRow: currentRow } );
				}
			}
		});
			
		var currentRow = undefined;
		dgd_props.datagrid({
			onSelect:function( index, row ){
				currentRow =  {index:index, row:row};
				vic.easyui.setSpinnerValue( spr_value, row.v, false );
			}
		});
		
		var currentAdvRow = undefined;
		dgd_advprops.datagrid({
			onSelect:function( index, row ){
				currentAdvRow = {index:index, row:row};
			}
		});
		
		var currentNode = undefined;
		tree_particle.tree( {
			onSelect:function( node ){
				console.log( node );
				currentNode = node;
				event.trigger( 'onTreeClick', { node:node } );
			}
		});
		
		webgl.mousedown( onmousedown );
		webgl.mouseup( onmouseup );
		webgl.mousemove( onMousemove );
		
		function onMousemove(e) {
			var px = e.offsetX;
			var py = e.offsetY;
			if ( isMouseDown ) {
				targetPos[0] = px;
				targetPos[1] = py;
				event.trigger( 'onMouseMove', { targetPos:targetPos } );
			}
		}
		
		function onmousedown( e ) {
			isMouseDown = true;
		}
		
		function onmouseup( e ) {
			isMouseDown = false;
		}
		
		function setDgdProp( ary_props ){
			vic.easyui.setDatagridRows( dgd_props, ary_props );
		}
		
		function setTree( nodes, selectId ){
			vic.easyui.setTree( tree_particle, nodes );
			
			setTimeout( function(){
				vic.easyui.selectTreeNode( tree_particle,vic.easyui.getTreeNodeById( tree_particle, selectId ));
				event.trigger( 'onViewTreeChange' );
			}, 10 );
		}
		
		function addTree( model ){
			if( currentNode == undefined ){
				vic.easyui.appendTree( tree_particle, vic.easyui.getTreeNodeById( tree_particle, 0 ), { id:model.id, text:model.name, particle:model } );
			}else{
				vic.easyui.appendTree( tree_particle, currentNode, { id:model.id , text:model.name, particle:model } );
			}
			event.trigger( 'onViewTreeChange' );
		}
		
		function removeTree(){
			if( currentNode != undefined ){
				vic.easyui.removeTree( tree_particle, currentNode );
				currentNode = undefined;
				event.trigger( 'onViewTreeChange' );
			}
		}
		
		function addProp(){
			vic.easyui.appendDatagridRow( dgd_advprops, { id:Math.random() , type:'linear'} );
			vic.easyui.selectDatagridRow( dgd_advprops, vic.easyui.getDatagridRows( dgd_advprops ).length - 1 );
		}
		
		function removeProp(){
			if( currentAdvRow != undefined ){
				vic.easyui.deleteDatagridRow( dgd_advprops, currentAdvRow.index );
				currentAdvRow = undefined;
				var ary_rows = vic.easyui.getDatagridRows( dgd_advprops );
				if( ary_rows.length > 0 ){
					vic.easyui.selectDatagridRow( dgd_advprops, vic.easyui.getDatagridRows( dgd_advprops ).length - 1 );
				}
			}
		}
		
		function upMove(){
			if( currentAdvRow != undefined ){
				if( currentAdvRow.index > 0 ){
					vic.easyui.deleteDatagridRow( dgd_advprops, currentAdvRow.index );
					vic.easyui.insertDatagridRow( dgd_advprops, currentAdvRow.index - 1, currentAdvRow.row );
					vic.easyui.selectDatagridRow( dgd_advprops, currentAdvRow.index - 1 );
				}
			}
		}
		
		function downMove(){
			if( currentAdvRow != undefined ){
				var maxCount = vic.easyui.getDatagridRows( dgd_advprops ).length;
				if( currentAdvRow.index < maxCount - 1 ){
					vic.easyui.deleteDatagridRow( dgd_advprops, currentAdvRow.index );
					vic.easyui.insertDatagridRow( dgd_advprops, currentAdvRow.index + 1 , currentAdvRow.row );
					vic.easyui.selectDatagridRow( dgd_advprops, currentAdvRow.index + 1 );
				}
			}
		}
		
		function getTreeRootNode(){
			return vic.easyui.getTreeNodeById( tree_particle, 0 );
		}
		
		function selectPropDgdFirst(){
			vic.easyui.selectDatagridRow( dgd_props, 0 );
		}
		
		module.webgl = webgl;
		module.tree_particle = tree_particle;
		module.addTree = addTree;
		module.removeTree = removeTree;
		module.addProp = addProp;
		module.removeProp = removeProp;
		module.upMove = upMove;
		module.downMove = downMove;
		module.setTree = setTree;
		module.setDgdProp = setDgdProp;
		module.getTreeRootNode = getTreeRootNode;
		module.selectPropDgdFirst = selectPropDgdFirst;
		
		module.event = event;
	})( app.view );
	
	
	var app = app || {};
	app.model = app.model || {};
	
	(function( module ){
	
		//var particles = createInitParticle();
		var particles = createParticle( 0, 'e' );
		particles.lifetime = 0;
		particles.pos[0] = 100;
		particles.pos[1] = 100;
		particles.emit = { 
							count:1,
							duration:.5,
							angle:0,
							range:0,
							force:100,
							prototype:[ createParticle( 1, 'p' ) ] };
		
		function getParticles(){
			return particles;
		}
		
		function createParticle( id, name ){
			return { 
				id: id, 
				name:name,
				lifetime:5,
				mass:1,
				color:'#33ddff',
				size:[10, 10],
				pos:[0, 0, 0], 
				vel:[0, 0, 0],
				tex: "texture id",
				blending: "normal",
			}
		}
		
		module.getParticles = getParticles;
		module.createParticle = createParticle;
	})( app.model );
	
	(function( view, model ){
		var webgl = view.webgl;
		var currentParticle = undefined;
		
		api.init( webgl );
		
		var particles = model.getParticles();
		
		var treeModel = {};
		modelToTree( particles, treeModel )
		view.setTree( [ treeModel ], 1 );
		
		view.event.on( 'onViewTreeChange', function(){
			updateRender();
		});
		
		view.event.on( 'onTreeClick', function( e, options ){
			view.setDgdProp( (function( node ){
				var p = node.particle;
				if( vic.easyui.getTreeIsLeaf( view.tree_particle, node ) ){
					return [
						{id:'lifetime', name:'生命毫秒', v: p.lifetime},
						{id:'mass', name:'質量', v: p.mass},
						{id:'pos_r', name:'角度', v: p.pos[2]},
						{id:'vel_x', name:'速度x', v: p.vel[0]},
						{id:'vel_y', name:'速度y', v: p.vel[1]},
						{id:'vel_r', name:'轉速', v: p.vel[2]},
						{id:'size_x', name:'寬度', v: p.size[0]},
						{id:'size_y', name:'高度', v: p.size[1]}
					];
				}
				return [
					{id:'lifetime', name:'生命毫秒', v: p.lifetime},
					{id:'mass', name:'質量', v: p.mass},
					{id:'pos_r', name:'角度', v: p.pos[2]},
					{id:'vel_r', name:'轉速', v: p.vel[2]},
					{id:'size_x', name:'寬度', v: p.size[0]},
					{id:'size_y', name:'高度', v: p.size[1]},
					{id:'count', name:'發射數目', v: p.emit.count},
					{id:'duration', name:'發射間隔', v: p.emit.duration},
					{id:'angle', name:'發射角度', v: p.emit.angle},
					{id:'range', name:'發射範圍', v: p.emit.range},
					{id:'force', name:'發射力道', v: p.emit.force}
				];
			})( options.node ));
			//vic.easyui.selectDatagridRow( 
			view.selectPropDgdFirst();
			currentParticle = options.node.particle;
		});
		
		view.event.on( 'onMouseMove', function( e, options ){
			var rootParticle = view.getTreeRootNode().particle;
			rootParticle.pos[0] = options.targetPos[0];
			rootParticle.pos[1] = options.targetPos[1];
			updateRender();
		});
		
		view.event.on( 'onDgdPropsClick', function( e, options ){
			console.log( options );
		});
		
		view.event.on( 'onPropChange', function( e, options ){
			var row = options.currentRow.row;
			switch( row.id ){
				case 'pos_r':
					currentParticle.pos[0] = row.v; break;
				case 'vel_x':
					currentParticle.vel[0] = row.v; break;
				case 'vel_y':
					currentParticle.vel[1] = row.v; break;
				case 'vel_r':
					currentParticle.vel[2] = row.v; break;
				case 'size_x':
					currentParticle.size[0] = row.v; break;
				case 'size_y':
					currentParticle.size[1] = row.v; break;
				case 'count':
					currentParticle.emit.count = row.v; break;
				case 'duration':
					currentParticle.emit.duration = row.v; break;
				case 'range':
					currentParticle.emit.range = row.v; break;
				case 'angle':
					currentParticle.emit.angle = row.v; break;
				case 'force':
					currentParticle.emit.force = row.v; break;
				default:
					currentParticle[row.id] = row.v;
			}
			updateRender();
		});
		
		function updateRender(){
			var retobj = { };
			treeToModel( vic.easyui.getTreeNodeById( view.tree_particle, 0 ), retobj );
			api.editParticle( retobj );
		}
		
		function moveParticle(id, x, y) {
			api.changeCenterPos(id, x, y );
		}
		
		function modelToTree( fields, retobj ) {
			retobj.id = fields.id;
			retobj.text = fields.name;
			retobj.particle = fields;
			
			if ( fields.emit != undefined ) {
				retobj.children = [];
				_.each( fields.emit.prototype, function( p ){
					var tobj = {};
					retobj.children.push( tobj );
					modelToTree( p, tobj );
				});
			}
		}
		
		function treeToModel( node, outputData ) {
			var particleData = node.particle;
			outputData.id = particleData.id;
			outputData.lifetime = particleData.lifetime;
			outputData.vel = particleData.vel;
			outputData.pos = particleData.pos;
			outputData.mass = particleData.mass;
			outputData.color = particleData.color;
			outputData.size = particleData.size;
		
			if ( node.children && node.children.length > 0 ) {
				
				if( particleData.emit == undefined ){
					particleData.emit = {};
					particleData.emit.count = 1;
					particleData.emit.duration = .5;
					particleData.emit.angle = 0;
					particleData.emit.range = 0;
					particleData.emit.force = 100;
				}
				particleData.emit.prototype = [];
				if( outputData.emit == undefined ){
					outputData.emit = deepCopy( node.particle.emit );
				}
				_.each( node.children, function( nc ){
					var obj = { };
					outputData.emit.prototype.push( obj );
					//outputData.emit.prototype.push( obj );
					treeToModel( nc, obj );
				});
			}
		}
		
	})( app.view, app.model );
	
	
	function deepCopy( obj ){
		return JSON.parse( JSON.stringify( obj ));
	}
	
	function getUid(){
		return leo.utils.generateUUID();
	}
	
	function onHtmlClick( dom ){
		switch( dom.id ){
			case 'btn_addTree':
				var uid = getUid();
				app.view.addTree( app.model.createParticle( uid, uid ) );
				break;
			case 'btn_removeTree':
				app.view.removeTree();
				break;
			case 'btn_addProp':
				app.view.addProp();
				break;
			case 'btn_removeProp':
				app.view.removeProp();
				break;
			case 'btn_upMove':
				app.view.upMove();
				break;
			case 'btn_downMove':
				app.view.downMove();
				break;
		}
	}
</script>

</html>