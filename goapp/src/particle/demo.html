<html>
	<head>
		<title>幽夢仙境鏡</title>
		<link rel="stylesheet" type="text/css" href="../common/js/lib/jquery-easyui-1.4.3/themes/black/easyui.css">
		<link rel="stylesheet" type="text/css" href="../common/js/lib/jquery-easyui-1.4.3/themes/icon.css">
		<link rel="stylesheet" type="text/css" href="../common/css/normalize.css">
			
		<script type="text/javascript" src="../common/js/lib/leo.utils.js"></script>
		<script type="text/javascript" src="../common/js/lib/jquery-easyui-1.4.3/jquery.min.js"></script>
		<script type="text/javascript" src="../common/js/lib/jquery-easyui-1.4.3/jquery.easyui.min.js"></script>
		<script type="text/javascript" src="../common/js/lib/vic/vic.easyui.js"></script>
		<script type="text/javascript" src="../common/js/lib/jquery/jquery.tmpl.min.js"></script>
		<script type="text/javascript" src="../common/js/lib/myapp.facebook.js"></script>
	</head>
	<style>
	body{
		-webkit-touch-callout: none;
		-webkit-user-select: none;
		-khtml-user-select: none;
		-moz-user-select: none;
		-ms-user-select: none;
		user-select: none;
		outline: 0;
		position:absolute;
		width:100%;
		height:100%;
	}
	
	.group{
		position:relative;
		width:100%;
	}
	
	.hori{
		display:inline-block;
	}
	</style>
	<body>
		<div id="cc" class="easyui-layout" style="position:relative; width:100%;height:100%;">
			<div data-options="region:'north',split:false" style="height:35px; overflow:hidden;">
				<div class="group">
					<div style="position:relative; top:10px; left:5px;">幽夢仙境鏡</div>
				</div>
				<div style="position:absolute; right:5px; top:5px;">
					<a id="btn_about" href="#" class="easyui-linkbutton" onclick="$('#dia_about').panel( 'open' )" data-options="iconCls:'icon-help'"></a>
				</div>
			</div>
			<div data-options="region:'east',split:false" style="width:20%; height:100%; overflow:hidden;">
				<div class="group" style="height:100%;">
					<div class="group" style="height:80%;">
						<input id="txt_input" class="easyui-textbox" data-options="multiline:true" style="width:100%;height:100%;">
					</div>
					<div class="group" style="height:20%; text-align:center; top:30px;">
						<a class="easyui-linkbutton" style="width:50%; height:50%;" data-options="iconCls:'icon-edit'">匯入</a>
					</div>
				</div>
			</div>
			<div data-options="region:'center'" style="overflow:hidden; width:80%;">
				<div style="position:relative; width:24%; height:100%;" class="hori">
					<div id='three' style='position:relative; width: 100%; height: 100%'></div>
					<div style="position:absolute; top:5px; left:5px; color:yellow;">webgl</div>
				</div>
				<div style="position:relative; width:24%; height:100%; vertical-align: top;" class="hori">
					<div id='canvas' style='position:relative; width: 100%; height: 100%; background-color:gray;'></div>
					<div style="position:absolute; top:5px; left:5px; color:yellow;">canvas</div>
				</div>
				<div style="position:relative; width:24%; height:100%; vertical-align: top;" class="hori">
					<div id='div' style='position:relative; width: 100%; height: 100%; background-color:gray;'></div>
					<div style="position:absolute; top:5px; left:5px; color:yellow;">div</div>
				</div>
				<div style="position:relative; width:24%; height:100%; vertical-align: top;" class="hori">
					<div id='lwfdiv' style='position:relative; width: 100%; height: 100%; background-color:gray;'></div>
					<div style="position:absolute; top:5px; left:5px; color:yellow;">lwf</div>
				</div>
			</div>
		</div>
		<div style="display:none;">
			<img id='glow_128_128' src='../common/images/effect/glow_128_128.jpg'>
			<img id='glow_png_128_128' src='../common/images/effect/glow_png_128_128.png'>
			<img id='glow_color_png_128_128' src='../common/images/effect/glow_color_png_128_128.png'>
			<img id='fire_128_128' src='../common/images/effect/fire_128_128.jpg'>
			<img id='fire_png_128_128' src='../common/images/effect/fire_png_128_128.png'>
			<img id='fire_color_png_128_128' src='../common/images/effect/fire_color_png_128_128.png'>
			<img id='smoke_128_128' src='../common/images/effect/smoke_128_128.png'>
			<img id='lead_32_32' src='../common/images/effect/lead_32_32.png'>
			<img id='cornerGlow_256_256' src='../common/images/effect/cornerGlow_256_256.png'>
		</div>
		<div id="dia_about" class="easyui-dialog" title="幽夢仙境" data-options="iconCls:'icon-help',closed:true" style="padding:10px">
			<div class="group" style="position:relative; width:100%; text-align:center;">
				<div class="hori" >
					上善若水
					<br/>
					<img src="../common/images/logo.jpg" width="100" height="100">
					<br/>
					上善若水粉絲頁
					<br/>
					<a style="color:yellow; font-size:12px;" href="https://www.facebook.com/pages/上善若水/1653920964852269" target="_blank">https://www.facebook.com/pages/上善若水/1653920964852269</a>
					<br/>
					幽夢仙境
					<br/>
					<a style="color:yellow; font-size:12px;" href="https://particle-979.appspot.com/particle/index.html#" target="_blank">https://particle-979.appspot.com/particle/index.html#</a>
				</div>
			</div>
		</div>
		<script src='../common/js/lib/lwf.js'></script>
		<script src='../common/js/lib/async.js'></script>
		<script src='../common/js/lib/rxjs/rx.all.min.js'></script>
		<script src='../common/js/lib/three.min.js'></script>
		<script src='../common/js/lib/underscore/underscore-min.js'></script>
		<script src='../common/js/lib/han/particle.js'></script>
		<script src='../common/js/lib/han/particleDrawer.js'></script>
		<script>
		
		
		
		function App(){
		
			
			
			
			// ------ textures ----------// 
			var imgs = _.reduce( $('img'), function(start, img2){
				var id = $(img2).attr('id')
				var obj = {}
				obj[id] = img2
				return _.extend( start, obj )
			}, {})
		
			var texs = _.reduce( $('img'), function(start, img2){
				var tex = new THREE.Texture(img2)
				tex.needsUpdate = true
				tex.minFilter = THREE.LinearFilter 
			
				var id = $(img2).attr('id')
				var obj = {}
				obj[id] = tex
				return _.extend( start, obj )
			}, {})
			
			// ---------- lwf --------------//
			var drawLwf = 0
			
			var stage = document.createElement("canvas");
			LWF.useWebGLRenderer();
			
			var lwfcontainer = $('#lwfdiv')
			stage.width = lwfcontainer.width()
			stage.height = lwfcontainer.height()
			$(stage).appendTo(lwfcontainer)
			
			cache = LWF.ResourceCache.get();
			cache.loadLWF({
				"lwf": "particle.lwf", // *.lwf file name
				"prefix": "../common/lwfdata/particle.lwfdata/", // * lwf, png folder
				"stage": stage, // * target stage
				"onload": function(lwf) {
					lwf.setFrameRate( 60 )
					window.lwf = lwf
					drawLwf = particleDrawer.lwf( lwf )
				},
			});
			
			// --------- canvas drawer ------------- //
			var canvas = $('<canvas></canvas>')
			var ctx2d = canvas[0].getContext('2d')
		
			var canvasContainer = $('#canvas')
			canvas.attr('width', canvasContainer.width())
			canvas.attr('height', canvasContainer.height())
			canvas.appendTo(canvasContainer)
			
		
			var w = canvas.width()
			var h = canvas.height()
		
			var drawCanvas = particleDrawer.canvas( ctx2d )
			
			// -------- div drawer ---------- //
			var divDom = $('#div' )
			divDom.css('background-color', 'black')
			var drawDiv = particleDrawer.dom( divDom )
			
			// -------- three drawer ---------- //
			var jdom = $('#three')
			var w = jdom.width()
			var h = jdom.height()

			var renderer = new THREE.WebGLRenderer({antialias: false})
			renderer.setSize( w, h )
			$(renderer.domElement).appendTo( jdom )
		
			var scene = new THREE.Scene
			var drawThree = particleDrawer.three(w, h, scene, renderer)
			
			var pool = particle.pool( 4000 )
			var ps = particle.particleSystem(pool, function( type, key ){
				if( type == 'three' ){
					return texs[key]
				}
				if( type == 'div' ){
					return imgs[key]
				}
				if( type == 'canvas' ){
					return imgs[key]
				}
				return null
			})
			var last = new Date().getTime()
			setTimeout( function(){
				var now = new Date().getTime()
				var elap = (now - last)/ 1000.0
				last = now
				
				ps.clearOutBound( w, h )
				ps.step( elap )
				ps.draw( drawThree )
				ps.draw( drawDiv )
				ctx2d.fillRect(0, 0, w, h)
				ps.draw( drawCanvas )
				
				if (window.lwf != null) {
					window.lwf.exec(1000.0/30);
					window.lwf.render();        
				}
				if( drawLwf ){
					ps.draw( drawLwf )
				}
				
				setTimeout( arguments.callee, 1000.0/30 )
			}, 0)
			
			return {
				
				reset: function( input ){
					ps.clear()
					var parts =_.map(particle.parseInput( pool, input ), function(item){
						item.pos[0] = w/2
						item.pos[1] = h/2
						return item
					})
					ps.emit( parts )
				}
			}
		}
		
		var app = App()
		var txt_input = $("#txt_input" )
		txt_input.textbox( {
			onChange:function(nv, ov){
				var datastr = nv;
				try{
					var obj = JSON.parse( datastr )
					app.reset( obj )
				} catch (e){
					alert(e)
				}
			}
		})
		
		//txt_input.textbox("setValue", '[{"id":0,"name":"發射器","lifetime":0.081,"vel":[0,0,0],"pos":[261,453,0],"mass":1,"color":[1,1,1,0],"size":[40,40],"tex":"glow_png_128_128","blending":"normal","formulaList":[],"emit":{"prototype":[{"id":"1","name":"粒子","lifetime":4,"vel":[0,0,0],"pos":[0,0,0],"mass":1,"color":[1,1,1,1],"size":[16,16],"tex":"glow_png_128_128","blending":"normal","formulaList":[["lifetime","randStartAdd",2,0,0,0,0],["vy","randAdd",100,0,0,0,0],["vx","randAdd",100,0,0,0,0],["vy","randStartAdd",3000,0,0,0,0],["vx","randStartAdd",3000,0,0,0,0],["scale-x","constMul",0.995,0,0,0,0],["scale-y","constMul",0.995,0,0,0,0],["vx","constMul",0.95,0,0,0,0],["vy","constMul",0.95,0,0,0,0]]}],"count":2,"duration":0.005,"angle":0,"range":0,"force":0}}]')
		txt_input.textbox("setValue", '[{"id":0,"name":"發射器","lifetime":0,"vel":[0,0,0],"pos":[150,160,0],"mass":1,"color":[1,1,1,1],"size":[0,0],"tex":"glow_128_128","blending":"add","formulaList":[],"emit":{"prototype":[{"id":"1","name":"粒子","lifetime":2,"vel":[0,0,0],"pos":[0,0,0],"mass":1,"color":[1,1,1,1],"size":[40,40],"tex":"fire_128_128","blending":"add","formulaList":[["scale-y","randStartAdd",100,0,0,0,0],["scale-x","randStartAdd",100,0,0,0,0],["vr","randStartAdd",1.7453292519943295,0,0,0,0],["vy","randAdd",100,0,0,0,0],["vx","randAdd",100,0,0,0,0],["a","constMul",0.95,0,0,0,0]]}],"count":1,"duration":0.05,"angle":0,"range":0,"force":0}}]')
		
		</script>
	</body>
</html>
