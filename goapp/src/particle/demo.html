<html>
	<head>
		<title>
			
		</title>
		<link rel="stylesheet" type="text/css" href="../common/js/lib/jquery-easyui-1.4.3/themes/black/easyui.css">
		<link rel="stylesheet" type="text/css" href="../common/js/lib/jquery-easyui-1.4.3/themes/icon.css">
		<link rel="stylesheet" type="text/css" href="../common/css/normalize.css">
			
		<script type="text/javascript" src="../common/js/lib/leo.utils.js"></script>
		<script type="text/javascript" src="../common/js/lib/jquery-easyui-1.4.3/jquery.min.js"></script>
		<script type="text/javascript" src="../common/js/lib/jquery-easyui-1.4.3/jquery.easyui.min.js"></script>
		<script type="text/javascript" src="../common/js/lib/vic/vic.easyui.js"></script>
		<script type="text/javascript" src="../common/js/lib/jquery/jquery.tmpl.min.js"></script>
		<script type="text/javascript" src="../common/js/lib/myapp.facebook.js"></script>
	</head>
	<style>
	body{
		-webkit-touch-callout: none;
		-webkit-user-select: none;
		-khtml-user-select: none;
		-moz-user-select: none;
		-ms-user-select: none;
		user-select: none;
		outline: 0;
		position:absolute;
		width:100%;
		height:100%;
	}
	
	.group{
		position:relative;
		width:100%;
	}
	
	.hori{
		display:inline-block;
	}
	</style>
	<body>
		<div id="cc" class="easyui-layout" style="position:relative; width:100%;height:100%;">
			<div data-options="region:'north',split:false" style="height:35px; overflow:hidden;">
				<div class="group">
					<div style="position:relative; top:10px; left:5px;">幽夢仙境鏡</div>
				</div>
				<div style="position:absolute; right:5px; top:5px;">
					<a id="btn_about" href="#" class="easyui-linkbutton" onclick="$('#dia_about').panel( 'open' )" data-options="iconCls:'icon-help'"></a>
				</div>
			</div>
			<div data-options="region:'east',split:false" style="width:20%; height:100%; overflow:hidden;">
				<div class="group" style="height:100%;">
					<div class="group" style="height:80%;">
						<input id="txt_input" class="easyui-textbox" data-options="multiline:true" style="width:100%;height:100%;">
					</div>
					<div class="group" style="height:20%; text-align:center; top:30px;">
						<a class="easyui-linkbutton" style="width:50%; height:50%;" data-options="iconCls:'icon-edit'">匯入</a>
					</div>
				</div>
			</div>
			<div data-options="region:'center'" style="overflow:hidden; width:80%;">
				<div style="position:relative; width:33%; height:100%;" class="hori">
					<div id='three' style='position:relative; width: 100%; height: 100%'></div>
					<div style="position:absolute; top:5px; left:5px; color:yellow;">webgl</div>
				</div>
				<div style="position:relative; width:33%; height:100%; vertical-align: top;" class="hori">
					<div id='div' style='position:relative; width: 100%; height: 100%; background-color:gray;'></div>
					<div style="position:absolute; top:5px; left:5px; color:yellow;">div</div>
				</div>
				<div style="position:relative; width:33%; height:100%; vertical-align: top;" class="hori">
					<div id='canvas' style='position:relative; width: 100%; height: 100%; background-color:gray;'></div>
					<div style="position:absolute; top:5px; left:5px; color:yellow;">canvas</div>
				</div>
			</div>
		</div>
		<div style="display:none;">
			<img id='0' src='images/glow.jpg'>
			<img id='1' src='images/leadB_32_32.png'>
			<img id='2' src='images/fire_128_128.jpg'>
			<img id='3' src='images/smoke_128_128_half_hlaf.png'>
		</div>
		<div id="dia_about" class="easyui-dialog" title="幽夢仙境" data-options="iconCls:'icon-help',closed:true" style="padding:10px">
			<div class="group" style="position:relative; width:100%; text-align:center;">
				<div class="hori" >
					上善若水
					<br/>
					<img src="../common/images/logo.jpg" width="100" height="100">
					<br/>
					上善若水粉絲頁
					<br/>
					<a style="color:yellow; font-size:12px;" href="https://www.facebook.com/pages/上善若水/1653920964852269" target="_blank">https://www.facebook.com/pages/上善若水/1653920964852269</a>
					<br/>
					幽夢仙境
					<br/>
					<a style="color:yellow; font-size:12px;" href="https://particle-979.appspot.com/particle/index.html#" target="_blank">https://particle-979.appspot.com/particle/index.html#</a>
				</div>
			</div>
		</div>
		
		<script src='../common/js/lib/async.js'></script>
		<script src='../common/js/lib/rxjs/rx.all.min.js'></script>
		<script src='../common/js/lib/three.min.js'></script>
		<script src='../common/js/lib/underscore/underscore-min.js'></script>
		<script src='js/particle.js'></script>
		<script src='js/particleDrawer.js'></script>
		<script src='js/api.js'></script>
		<script>
		
		var txt_input = $("#txt_input" )
		txt_input.textbox( {
			onChange:function(nv, ov){
				var datastr = nv;
				console.log( datastr );
			}
		})
		
		var divDom = $('#div' )
		divDom.css('background-color', 'black')
		// -------- div drawer ---------- //
		var drawDiv = particleDrawer.dom( divDom )
		// -------- three drawer ---------- //
		var jdom = $('#three')
		var w = jdom.width()
		var h = jdom.height()

		var useWebgl = true
		var renderer = useWebgl ? new THREE.WebGLRenderer({antialias: true}) : new THREE.CanvasRenderer({antialias: true})
		renderer.setSize( w, h )
		$(renderer.domElement).appendTo( jdom )
		
		var scene = new THREE.Scene
		var drawThree = particleDrawer.three(w, h, scene, renderer)
		
		// ------- main ----------- //
		var pool = particle.pool( 4000 )
		/*
		var input = [{"id":0,"name":"粒子","lifetime":0,"vel":[0,0,0],"pos":[162,284,0],"mass":1,"color":[1,1,1,1],"size":[40,40],"tex":"0","blending":"add","formulaList":[],"emit":{"prototype":[{"id":"1","name":"粒子","lifetime":2,"vel":[0,0,0],"pos":[0,0,0],"mass":1,"color":[1,1,1,1],"size":[40,40],"tex":"1","blending":"add","formulaList":[["vy","randAdd",100,0,0,0,0],["vx","randAdd",100,0,0,0,0]]}],"count":1,"duration":0.05,"angle":0,"range":0,"force":0}},{"id":"61740aa4-0ed4-4aad-804f-631ce3af69e0","name":"61740aa4-0ed4-4aad-804f-631ce3af69e0","lifetime":1,"vel":[0,0,0],"pos":[162,284,0],"mass":1,"color":[1,1,1,1],"size":[40,40],"tex":"0","blending":"add","formulaList":[]}]
		*/
		/*
		var input = [{"id":0,"name":"粒子","lifetime":0,"vel":[0,0,0],"pos":[122,150,0],"mass":1,"color":[1,1,1,1],"size":[40,40],"tex":"0","blending":"add","formulaList":[],"emit":{"prototype":[{"id":"1","name":"粒子","lifetime":2,"vel":[0,0,0],"pos":[0,0,0],"mass":1,"color":[1,1,1,1],"size":[40,40],"tex":0,"blending":"add","formulaList":[["vr","randAdd",1.7453292519943295,0,0,0,0],["vx","randAdd",100,0,0,0,0],["vy","randAdd",100,0,0,0,0]]}],"count":1,"duration":0.01,"angle":0,"range":0,"force":0}}]
		*/
		var input = [{"id":0,"name":"fire","lifetime":0,"vel":[0,0,0],"pos":[190,150,0],"mass":1,"color":[1,1,1,0],"size":[40,40],"tex":"0","blending":"add","formulaList":[],"emit":{"prototype":[{"id":"1","name":"粒子","lifetime":1,"vel":[0,-58,1.7627825445142729],"pos":[0,0,0],"mass":1,"color":[1,1,1,1],"size":[83,99],"tex":"2","blending":"add","formulaList":[["rot","randStartAdd",6.283185307179586,0,0,0,0],["vr","randStartAdd",1.7453292519943295,0,0,0,0],["lifetime","randStartAdd",0.371,0,0,0,0],["scale-y","randStartAdd",100,0,0,0,0],["scale-x","randStartAdd",100,0,0,0,0],["y","randStartAdd",39,0,0,0,0],["x","randStartAdd",31,0,0,0,0],["vy","constMul",1.07,0,0,0,0],["scale-x","custom",0,50,100,50,0],["scale-y","custom",0,50,100,50,0]]}],"count":1,"duration":0.05,"angle":0,"range":0,"force":0}},{"id":"7e8f1d5c-4c48-47cd-a58e-07ce284080f4","name":"glow","lifetime":0,"vel":[0,0,0],"pos":[190,150,0],"mass":1,"color":[1,1,1,0],"size":[40,40],"tex":"0","blending":"add","formulaList":[],"emit":{"count":1,"duration":0.1,"angle":0,"range":0,"force":0,"prototype":[{"id":"22b65a15-5960-4488-a661-1f02d1cda099","name":"pari","lifetime":0.229,"vel":[0,0,0],"pos":[0,-35,0],"mass":1,"color":[1,0.8235294117647058,0.2980392156862745,0.088],"size":[40,40],"tex":"0","blending":"add","formulaList":[["scale-y","randStartAdd",100,0,0,0,0],["scale-x","randStartAdd",100,0,0,0,0],["lifetime","randStartAdd",0.134,0,0,0,0],["scale-x","custom",0,90,238,93,0],["scale-y","custom",0,83,249,90,0]]}]}},{"id":"b3c59990-7fbb-485d-ba03-8fdd6f73a910","name":"smoke","lifetime":0,"vel":[0,0,0],"pos":[190,150,0],"mass":1,"color":[1,1,1,0],"size":[40,40],"tex":"0","blending":"add","formulaList":[],"emit":{"count":1,"duration":0.302,"angle":0,"range":0,"force":0,"prototype":[{"id":"8aa34c3a-25e6-475c-8da9-cca95d0c0042","name":"8aa34c3a-25e6-475c-8da9-cca95d0c0042","lifetime":6,"vel":[12,-104,0],"pos":[0,0,0],"mass":1,"color":[1,1,1,0.532],"size":[208,224],"tex":"3","blending":"add","formulaList":[["vx","randStartAdd",14,0,0,0,0],["vy","randStartAdd",15,0,0,0,0],["lifetime","randStartAdd",3,0,0,0,0],["a","randStartAdd",0.438,0,0,0,0],["rot","randStartAdd",6.283185307179586,0,0,0,0],["a","custom",0,0.326,0.891,0.534,0],["scale-x","custom",0,139,213,280,263],["scale-y","custom",0,123,217,274,283]]}]}}]
		
		
		var parts = _.map( input, function(item){
			particle.formatFormula( item )
			return particle.initParticle( pool.get(), item )
		})
		
		var tex = new THREE.Texture($('#0')[0])
		tex.needsUpdate = true
		
		var ctx = {
			parts: parts,
			textures: {},
			bgColor: [0, 0, 0],
			fps: 30,
			texture: function( type, key ){
				if( type == 'three' ){
					return tex;
				}
				if( type == 'div' ){
					return null
				}
				return null
			}
		}
		
		var last = new Date().getTime()
		setTimeout( function(){
			var now = new Date().getTime()
			var elap = (now - last)/ 1000.0
			last = now
			particle.stepParticles( pool, ctx.parts, elap )
			// 刪除超過螢幕的
			ctx.parts = _.filter( ctx.parts, function(item){
				// 函數式的函式中增加了副作用，還在可以接受的範圍
				var shouldRemove = item.pos[0] < 0 || item.pos[0] > w || item.pos[1] < 0 || item.pos[1] > h
				if( shouldRemove ){
					pool.put( item )
				}
				return shouldRemove == false
			})
			drawThree( ctx )
			drawDiv( ctx )
			setTimeout( arguments.callee, 1000.0/ctx.fps )
		}, 0)
		</script>
	</body>
</html>
