<html>
	<head>
		<title>
			
		</title>
	</head>
	<body>
		<div id='three' style='position:relative; width: 300px; height: 300px'></div>
		<div id='div' style='position:relative; width: 300px; height: 300px; background-color:gray;'></div>
		<img id='tex1' src='images/glow.jpg'>
		<script src="../common/js/lib/jquery-easyui-1.4.3/jquery.min.js"></script>
		<script src='../common/js/lib/async.js'></script>
		<script src='../common/js/lib/rxjs/rx.all.min.js'></script>
		<script src='../common/js/lib/three.min.js'></script>
		<script src='../common/js/lib/underscore/underscore-min.js'></script>
		<script src='js/particle.js'></script>
		<script src='js/particleDrawer.js'></script>
		<script src='js/api.js'></script>
		<script src="js/haxe.js"></script>
		<script>
		
		
		// -------- div drawer ---------- //
		var drawDiv = particleDrawer.basic({
			onCreate: function( key, ctx ){
				var dom = $('<div></div>');
				$('#div' ).append( dom );
				return dom;
			},
			onUpdate: function( obj, part, ctx ){
				
				obj.css( 'position', 'absolute' );
				obj.css( 'left', part.pos[0] - part.size[0] / 2 );
				obj.css( 'top', part.pos[1] - part.size[1] / 2 );
				obj.css( 'width', part.size[0] + 'px' );
				obj.css( 'height', part.size[1] + 'px' );
				
				var hexcolor = (function( rgb ){
					var hex = [
						rgb.r.toString(16),
						rgb.g.toString(16),
						rgb.b.toString(16)
					];
					$.each(hex, function (nr, val) {
						if (val.length == 1) {
							hex[nr] = '0' + val;
						}
					});
					return hex.join('');
				})( {
					r:Math.floor( part.color[0] * 255 ),
					g:Math.floor( part.color[1] * 255 ),
					b:Math.floor( part.color[2] * 255 )
				} );
				
				if( part.tex != '' ) {
					if( obj.find( '#img' ).length == 0 ){
						var tex = ctx.texture( 'div', part.tex ).clone();
						tex.css( 'position', 'relative' );
						tex.css( 'width', '100%' );
						tex.css( 'height', '100%' );
						tex.css( 'left', '0' );
						tex.css( 'top', '0' );
						tex.attr( 'id', 'img' );
						obj.prepend( tex );
					}
				}
				
				obj.css( 'background-color', '#' + hexcolor );
				obj.css( 'opacity', part.color[3] );
				obj.css( 'transform', 'rotate(' + -part.pos[2] / Math.PI * 180 + 'deg)' );
			},
			onRemove: function( obj, ctx ){
				obj.empty();
				obj.remove();
			},
			onRender: function( ctx ){
				
			}
		})
		// -------- three drawer ---------- //
		var jdom = $('#three')
		var w = jdom.width()
		var h = jdom.height()

		var useWebgl = true
		var renderer = useWebgl ? new THREE.WebGLRenderer({antialias: true}) : new THREE.CanvasRenderer({antialias: true})
		renderer.setSize( w, h )
		$(renderer.domElement).appendTo( jdom )
		
		var scene = new THREE.Scene
		var drawThree = particleDrawer.three(w, h, scene, renderer)
		
		// ------- main ----------- //
		var pool = particle.pool( 2000 )
		var first = particle.initParticle( pool.get(), { 
			id: 'root',
			lifetime: 0,
			vel: [1, 1, 1],
			tex:'0',
			size:[50, 50],
			emit: {
				duration: .05,
				force: 100,
				range: 0,
				prototype: [
					{
						lifetime:10,
						color: [0, 1, 1, 1],
						vel: [0, 0, 1],
						tex:'1',
						size:[50, 50],
						blending:'add',
						emit: {
							duration: 1,
							prototype:[
								{
									vel: [0, -100, 1]
								}
							]
						}
					}
				]
			},
			formulaList: [
				function(part, lifep){
				
				}
			]
		})
	
		var tex = new THREE.Texture($('#tex1')[0])
		tex.needsUpdate = true
		
		var ctx = {
			parts: [first],
			textures: {},
			bgColor: [0, 0, 0],
			fps: 30,
			texture: function( type, key ){
				if( type == 'three' ){
					return tex;
				}
				if( type == 'div' ){
					return $('#tex1');
					switch( key ){
						case '0':return $('#tex1');
						case '1':return $('#tex1');
					}
				}
				return null
			}
		}
		
		var last = new Date().getTime()
		setTimeout( function(){
			var now = new Date().getTime()
			var elap = (now - last)/ 1000.0
			last = now
			particle.stepParticles( pool, ctx.parts, elap )
			// 刪除超過螢幕的
			ctx.parts = _.filter( ctx.parts, function(item){
				// 函數式的函式中增加了副作用，還在可以接受的範圍
				var shouldRemove = item.pos[0] < 0 || item.pos[0] > w || item.pos[1] < 0 || item.pos[1] > h
				if( shouldRemove ){
					pool.put( item )
				}
				return shouldRemove == false
			})
			drawThree( ctx )
			drawDiv( ctx )
			setTimeout( arguments.callee, 1000.0/ctx.fps )
		}, 0)
		</script>
	</body>
</html>
