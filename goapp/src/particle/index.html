<html>
	<head>
		<title>幽夢仙境</title>
		<meta charset="utf-8"/>
		<link rel="stylesheet" type="text/css" href="../common/js/lib/jquery-easyui-1.4.3/themes/black/easyui.css">
		<link rel="stylesheet" type="text/css" href="../common/js/lib/jquery-easyui-1.4.3/themes/icon.css">
		<link rel="stylesheet" type="text/css" href="../common/css/normalize.css">
		<link rel="stylesheet" media="screen" type="text/css" href="../common/js/lib/colorpicker/css/colorpicker.css" />
			
		<script type="text/javascript" src="../common/js/lib/leo.utils.js"></script>
		<script type="text/javascript" src="../common/js/lib/jquery-easyui-1.4.3/jquery.min.js"></script>
		<script type="text/javascript" src="../common/js/lib/jquery-easyui-1.4.3/jquery.easyui.min.js"></script>
		<script type="text/javascript" src="../common/js/lib/vic/vic.easyui.js"></script>
		<script type="text/javascript" src="../common/js/lib/jquery/jquery.cookie.js"></script>
		<script type="text/javascript" src="../common/js/lib/jquery/jquery.tmpl.min.js"></script>
		<script type="text/javascript" src="../common/js/lib/myapp.facebook.js"></script>
		<script type="text/javascript" src="../common/js/lib/colorpicker/js/colorpicker.js"></script>
		<script type="text/javascript" src="../common/js/lib/load-image.all.min.js"></script>
	</head>
	<style>

	body{
		-webkit-touch-callout: none;
		-webkit-user-select: none;
		-khtml-user-select: none;
		-moz-user-select: none;
		-ms-user-select: none;
		user-select: none;
		outline: 0;
		position:absolute;
		width:100%;
		height:100%;
	}

	.hori{
		display:inline-block;
	}
	
	.group{
		position:relative; 
		width:100%;
		min-width:250px;
	}
	
	.textImg{
		position:relative;
		width:100px;
		height:100px;
		margin-left:5px;
		display:inline-block;
		cursor:pointer;
	}
	
	.outline{
		outline:red solid 2px;
	}
	
	.outline{
		outline:red solid 2px;
	}
	
	</style>
	
</head>
<script id="tmpl_prop" type="jquery-x-tmpl">
	<div class="group" ptype=${id}>
		<div class="hori"><div style="width:100px;">${name}</div></div>
		<div class="hori"><input id="spr_value" class="easyui-numberspinner" style="width:80px;"></input></div>
		<div class="hori"><a id="btn_rand" class="easyui-linkbutton" data-options="toggle:true">亂數</a></div>
		<div class="hori"><a id="btn_turbu" class="easyui-linkbutton" data-options="toggle:true">湍流</a></div>
		<div class="hori"><a id="btn_fric" class="easyui-linkbutton" data-options="toggle:true">阻力</a></div>
		<div class="hori"><a id="btn_custom" class="easyui-linkbutton" data-options="toggle:true">自訂</a></div>
	</div>
</script>
<body>
	<div class="easyui-layout" style="width:100%;height:100%;">
        <div data-options="region:'north'" style="height:35px; overflow:hidden;">
			<div class="width:90%;">
				<div style="position:relative; left:5px; top:5px">
					<a href="#" class="easyui-menubutton" data-options="menu:'#m1'">幽夢仙境</a>
					<a href="#" class="easyui-menubutton" data-options="menu:'#m2'">本地端功能</a>
				</div>
				<div style="position:absolute; right:5px; top:5px;">
					<a id="btn_about" href="#" class="easyui-linkbutton" onclick="$('#dia_about').panel( 'open' )" data-options="iconCls:'icon-help'"></a>
				</div>
			</div>
		</div>
        <div data-options="region:'east',split:false,collapsible:false" title="樹狀圖及資訊" style="width:70%;">
			<div class="easyui-layout" style="width:100%;height:100%;">
				<div data-options="region:'north',split:false" style="height:20%">
					<div class="easyui-layout" style="width:100%;height:100%;">
						<div data-options="region:'center'" style="width:50%;">
							<div class="group" style="text-align:center; margin-top:5px;">
								<div class="hori"><a id="btn_addTree" href="#" class="easyui-linkbutton" onclick="onHtmlClick(this)" data-options="iconCls:'icon-search'">新增</a></div>
								<div class="hori"><a id="btn_removeTree" href="#" class="easyui-linkbutton" onclick="onHtmlClick(this)" data-options="iconCls:'icon-search'">刪除</a></div>
							</div>
							<div class="group">
								<ul id="tree_particle" class="easyui-tree" data-options="dnd:true">
									<!-- by script -->
								</ul>
							</div>
						</div>
						<div data-options="region:'east',split:true" style="width:50%;">
							<div class="group">
								<div class="group" style="text-align:center; margin-top:10px; ">
									<div class="hori">
										<div>粒子數目(最大2000) :</div>
										<div id="txt_count" style="color:yellow">0</div>
									</div>
								</div>
								<div class="group" style="text-align:center; margin-top:10px; ">
									<div class="hori">
										<div>FPS:</div>
										<div id="txt_fps" style="color:yellow">0</div>
									</div>
								</div>
								<div class="group" style="text-align:center; margin-top:10px;">
									<div class="hori">
										<div>背景顏色</div>
										<div style="position:relative; top:5px; left:4px;">
											<div id="cpr_back"></div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
					
				</div>
				<div data-options="region:'center',title:'參數'">
					<div class="group">
						<div class="hori" style="width:40%;">
							<div class="group" style="text-align:center; margin-top:10px;">
								<div class="hori">基本參數</div>
							</div>
							<div class="group" style="text-align:center; margin-bottom:10px; margin-top:10px; ">
								<div class="hori" style="width:100px; ">
									<input id="txt_name" class="easyui-textbox" style="width:100px;"></input>
								</div>
								<div class="hori" style="margin-right:10px;">
									<a id="btn_confirmName" class="easyui-linkbutton" data-options="iconCls:'icon-ok'">確定</a>
								</div>
								<div class="hori">
									<a id='btn_normalMode' class="easyui-linkbutton" data-options="group:'gType',toggle:true">普通</a>
									<a id='btn_addMode' class="easyui-linkbutton" data-options="group:'gType',toggle:true">疊加</a>
								</div>
								<div class="hori">
									<div style="position:relative; top:14px; ">
										<div id="cpr_color"></div>
									</div>
								</div>
							</div>
							<div id="mc_propContainer" class="group" style="margin-top:10px; text-align:center;">
								<!-- by script -->
							</div>
						</div>
						<div class="hori" style="width:55%; vertical-align:top; text-alien:center;">
							<div class="group" style="text-align:center; margin-top:10px;">
								<div class="hori">進階參數</div>
							</div>
							<div class="group" style="margin-top:10px;">
								<div class="group" style="text-align:center; margin-bottom:5px;">
									<div class="hori">
										<select id="combo_advProps" class="easyui-combobox" name="dept" style="width:100px;">
											<option value="lifetime">生命毫秒</option>
											<option value="x">位置x</option>
											<option value="y">位置y</option>
											<option value="rot">角度</option>
											<option value="vx">速度x</option>
											<option value="vy">速度y</option>
											<option value="vr">轉速</option>
											<option value="scale-x">寬度</option>
											<option value="scale-y">高度</option>
											<option value="r">紅</option>
											<option value="g">綠</option>
											<option value="b">藍</option>
											<option value="a">alpha</option>
											<option value="emit-angle">發射角度</option>
											<option value="emit-range">發射範圍</option>
											<option value="emit-count">發射數目</option>
											<option value="emit-force">發射力道</option>
										</select>
									</div>
									<div class="hori">
										<select id="combo_advType" class="easyui-combobox" name="dept" style="width:100px;">
											<option value="const">常數</option>
											<option value="constAdd">常數累加</option>
											<option value="constMul">常數累乘</option>
											<option value="linear">線性</option>
											<option value="linearAdd">線性累加</option>
											<option value="linearMul">線性累乘</option>
											<option value="randStartAdd">亂數開始</option>
											<option value="rand">亂數重設</option>
											<option value="randAdd">亂數累加</option>
											<option value="custom">自訂重設</option>
											<option value="customAdd">自訂累加</option>
											<option value="customMul">自訂累乘</option>
										</select>
									</div>
									<div class="hori"> <a href="#" id="btn_addAdvProp" class="easyui-linkbutton" onclick="onHtmlClick(this)" data-options="iconCls:'icon-add'">新增</a></div>
									<div class="hori"> <a href="#" id="btn_removeAdvProp" class="easyui-linkbutton" onclick="onHtmlClick(this)" data-options="iconCls:'icon-remove'">刪除</a></div>
									<div class="hori"> <a href="#" id="btn_upMove" class="easyui-linkbutton" onclick="onHtmlClick(this)" data-options="iconCls:'icon-undo'">上移</a></div>
									<div class="hori"> <a href="#" id="btn_downMove" class="easyui-linkbutton" onclick="onHtmlClick(this)" data-options="iconCls:'icon-redo'">下移</a></div>
								</div>
								<div class="group" style="text-align:center; margin-bottom:5px;">
									<div class="hori"><input id="spr_v1" class="easyui-numberspinner" style="width:80px;" data-options="value:0"></input></div>
									<div class="hori"><input id="spr_v2" class="easyui-numberspinner" style="width:80px;" data-options="value:0"></input></div>
									<div class="hori"><input id="spr_v3" class="easyui-numberspinner" style="width:80px;" data-options="value:0"></input></div>
									<div class="hori"><input id="spr_v4" class="easyui-numberspinner" style="width:80px;" data-options="value:0"></input></div>
									<div class="hori"><input id="spr_v5" class="easyui-numberspinner" style="width:80px;" data-options="value:0"></input></div>
								</div>
								<div class="group" style="text-align:center; margin-bottom:50px;">
									<div class="hori" style="width:90%;">
										<table id="dgd_advprops" class="easyui-datagrid" data-options="singleSelect:true" style="width:100%;">
											<thead>
												<tr>
													<th data-options="field:'name',width:'14%'">屬性</th>
													<th data-options="field:'type',width:'14%'">種類</th>
													<th data-options="field:'v1',width:'15%'">參數1</th>
													<th data-options="field:'v2',width:'15%'">參數2</th>
													<th data-options="field:'v3',width:'15%'">參數3</th>
													<th data-options="field:'v4',width:'15%'">參數4</th>
													<th data-options="field:'v5',width:'15%'">參數5</th>
												</tr>
											</thead>
										</table>
									</div>
								</div>
							</div>
						</div>
					</div>
					
					
				</div>
				<div data-options="region:'south', title:'貼圖',split:true" style="height:20%">
					<div id="mc_imgs" class="group">
					</div>
				</div>
			</div>
		</div>
        <div data-options="region:'center'" style="width:30%; overflow:hidden;">
           <div id="canvas_container" style="position:relative; width:100%; height:100%">
				<div id="webgl" style="position:relative; width:100%; height:100%; left:0; top:0;"></div>
			</div>
        </div>
    </div>
	<div id="m1">
		<div id="btn_import" onclick="onHtmlClick(this)" data-options="iconCls:'icon-save'">匯入/匯出</div>
		<div id="btn_saveToServer" onclick="onHtmlClick(this)" data-options="iconCls:'icon-save'">儲存至Serverlo</div>
	</div>
	<div id="m2">
		<div id="btn_uploadText" onclick="onHtmlClick(this)" data-options="iconCls:'icon-add'">上傳貼圖</div>
	</div>
	<input type="file" id="file" style="display:none">
	<div id="dia_about" class="easyui-dialog" title="幽夢仙境" data-options="iconCls:'icon-help',closed:true" style="padding:10px">
		<div class="group" style="position:relative; width:100%; text-align:center;">
			<div class="hori" >
				上善若水
				<br/>
				<img src="../common/images/logo.jpg" width="100" height="100">
				<br/>
				上善若水粉絲頁
				<br/>
				<a style="color:yellow; font-size:12px;" href="//www.facebook.com/pages/上善若水/1653920964852269" target="_blank">//www.facebook.com/pages/上善若水/1653920964852269</a>
			</div>
		</div>
	</div>
	<div id="win_output" class="easyui-window" title="匯入/匯出" data-options="minimizable:false,maximizable:false,collapsible:false,closed:true" style="width:600px;height:300px;text-align:center;">
        <input class="easyui-textbox" data-options="multiline:true" value="This TextBox will allow the user to enter multiple lines of text." style="width:100%;height:85%">
		<div class="group" style="margin-top:5px;">
			<a id="btn_outputConfirm" class="easyui-linkbutton" onclick="onHtmlClick(this)">確定</a>
		</div>
    </div>
	
</body>
<script src='../common/js/lib/async.js'></script>
<script src='../common/js/lib/rxjs/rx.all.min.js'></script>
<script src='../common/js/lib/three.min.js'></script>
<script src='../common/js/lib/underscore/underscore-min.js'></script>
<script type="text/javascript" src="../common/js/lib/google/ga.js"></script>
<script type="text/javascript" src="../common/js/lib/han/particle.js"></script>
<script type="text/javascript" src="../common/js/lib/han/particleDrawer.js"></script>
<script src='../common/js/store.js'></script>
<script src='js/api.js'></script>
<script src="js/app.utils.js"></script>
<script src="js/app.view.js"></script>
<script src="js/app.model.js"></script>
<script src="js/app.controller.js"></script>
<script type="text/javascript">

googleTracking.init( 'UA-55273266-3' );

document.addEventListener("contextmenu", function(e){
	e.preventDefault();
}, false);
	
vic.easyui.showLoading();
loadImages( [
				{id:'glow_128_128', path:'../common/images/effect/glow_128_128.jpg' },
				{id:'glow_png_128_128', path:'../common/images/effect/glow_png_128_128.png' },
				{id:'glow_color_png_128_128', path:'../common/images/effect/glow_color_png_128_128.png' },
				{id:'fire_128_128', path:'../common/images/effect/fire_128_128.jpg' },
				{id:'fire_png_128_128', path:'../common/images/effect/fire_png_128_128.png' },
				{id:'fire_color_png_128_128', path:'../common/images/effect/fire_color_png_128_128.png' },
				{id:'smoke_128_128', path:'../common/images/effect/smoke_128_128.png' },
				{id:'lead_32_32', path:'../common/images/effect/lead_32_32.png' },
				{id:'cornerGlow_256_256', path:'../common/images/effect/cornerGlow_256_256.png' }
			] );

function loadImages( ary_image ){
	var imgItem = ary_image.shift();
	appLoadImage( imgItem.path, function( img ) {
		app.view.appendImage( imgItem.id, img );
		api.addTexture( imgItem.id, img );
	});
	
	if( ary_image.length > 0 ){
		loadImages( ary_image );
	}else{
		vic.easyui.closeLoading();
		app.controller.appStart( app.view, app.model );
	}
}

function appLoadImage( src, cb ) {
	var img = new Image();
	img.src = src;
	img.onload = function() {
		cb( img );
	};
}
/*
function saveToServer( name, content, cb ){
	store.saveParticle({
		Name: name,
		Content: content,
		Override: "off"
	}, cb );
}
*/
function startToSave(){
	vic.easyui.showLoading();
	api.snapshot( 300, 300, 1000, function( err, img ){
		var uid = app.utils.getUid();
		api.saveToServer( uid, img, app.controller.renderToOutputString(), function( err, ret ){
			vic.easyui.closeLoading();
			if( err ){
				vic.easyui.showAlert( err );
			} else {
				vic.easyui.showMessage( '儲存成功!' );
			}
		})
	})
	/*
	var tid = setTimeout( function(){
		var secondClip = $( '<canvas width="300" height="300"></canvas>' );
		secondClip[0].getContext( '2d' ).drawImage( $('#webgl' ).find( 'canvas' )[0], 0, 0 );
		
		var uid = app.utils.getUid();
		saveToServer( uid + '.json', JSON.stringify( app.controller.renderToOutputString() ), function(err, ret){
			if( err == null ){
				var base64 = secondClip[0].toDataURL().split( ',' )[1];
				saveToServer( uid + '.jpg', base64, function(err, ret){
					if( err == null ){
						vic.easyui.showMessage( '儲存成功!' );
					}else{
						vic.easyui.showAlert( err );
					}
					vic.easyui.closeLoading();
				});
			}else{
				vic.easyui.showAlert( err );
				vic.easyui.closeLoading();
			}
		});
		
		clearTimeout( tid );
	}, 1000 );
	*/
}


function onHtmlClick( dom ){
	switch( dom.id ){
		case 'btn_saveToServer':
			app.controller.moveRenderRoots( app.view, 150, 150 );
			startToSave();
			break;
		case 'btn_uploadText':
			app.view.openFileBrowser();
			break;
		case 'btn_import':
			app.view.setWinOutput( JSON.stringify( app.controller.renderToOutputString() ));
			break;
		case 'btn_outputConfirm':
			app.view.closeImport();
			break;
		case 'btn_addTree':
			var uid = app.utils.getUid();
			app.view.addTree( app.model.createParticle( uid, uid ) );
			break;
		case 'btn_removeTree':
			app.view.removeTree();
			break;
		case 'btn_addAdvProp':
			app.view.addAdvProp();
			break;
		case 'btn_removeAdvProp':
			app.view.removeAdvProp();
			break;
		case 'btn_upMove':
			app.view.upMove();
			break;
		case 'btn_downMove':
			app.view.downMove();
			break;
	}
}

</script>

</html>