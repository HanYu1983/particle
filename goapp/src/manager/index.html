<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8"/>
	<title>上善若水</title>
	<meta name="description" content="" />
	
	<link rel="stylesheet" type="text/css" href="../common/js/lib/jquery-easyui-1.4.3/themes/black/easyui.css">
	<link rel="stylesheet" type="text/css" href="../common/js/lib/jquery-easyui-1.4.3/themes/icon.css">
	<link rel="stylesheet" type="text/css" href="../common/css/normalize.css">
		
	<script type="text/javascript" src="../common/js/lib/rectSelect/rectSelect.js"></script>
	<link rel="stylesheet" type="text/css" href="../common/js/lib/rectSelect/rectSelect.css">
		
	<script type="text/javascript" src="../common/js/lib/leo.utils.js"></script>
	<script type="text/javascript" src="../common/js/lib/jquery-easyui-1.4.3/jquery.min.js"></script>
	<script type="text/javascript" src="../common/js/lib/jquery-easyui-1.4.3/jquery.easyui.min.js"></script>
	<script type="text/javascript" src="../common/js/lib/jquery/jquery.tmpl.min.js"></script>
	<script type="text/javascript" src="../common/js/lib/myapp.facebook.js"></script>
		
</head>
<style>

#btn_team,
#btn_stock,
#btn_particle,
#btn_card
{
	position:relative;
	width:97%;
	height:40px;
}

.img_intro{
	width:400px;
}

.group{
	position:relative;
	width:100%;
}

.hori{
	position:relative;
	display:inline-block;
}

a{
	color:white;
	font-size:20px;
}
</style>
<script id="tmpl_deck" type="jquery-x-tmpl">
	<div id=${name} class="group">
		<a id="btn_remove" href="#" class="easyui-linkbutton" data-options="iconCls:'icon-remove'" ></a>
		<div class="hori"><a id="btn_fighter" href="#" class="easyui-linkbutton" data-options="toggle:true,selected:true" >格</a></div>
		<div class="hori"><a id="btn_gundamWar" href="#" class="easyui-linkbutton" data-options="toggle:true,selected:false" >鋼</a></div>
		<div class="hori"><a id="btn_sangoWar" href="#" class="easyui-linkbutton" data-options="toggle:true,selected:false" >三</a></div>
		<div class="hori"><input id="txt_name" class="easyui-textbox" style="width:100px" value=${name}></div>
		<div class="hori"><input id="txt_cards" class="easyui-textbox" style="width:500px"></div>
	</div>
</script>
<body>
	<div class="easyui-layout" style="width:100%;height:100%;">
		<div data-options="region:'north',split:false" style="height:36px;">
			<div style="position:absolute; right:0; top:0;">
				<a href="#" id="btn_login" class="easyui-linkbutton" data-options="iconCls:'icon-fb-login',disabled:true" onclick="onBtnClick(this)" style="margin-top:5px; margin-right:5px; ">登入</a>
			</div>
		</div>
		<div data-options="region:'west',title:'選單',split:true" style="width:200px; min-width:200px;">
			<div class="group">
				<div class="group">
					<div class="hori" style="width:20%">
						<a id="btn_stockLink" href="#" class="easyui-linkbutton" style="width:100%; height:40px;" onclick="onBtnClick(this)" data-options="iconCls:'icon-back'" ></a>
					</div>
					<div class="hori" style="width:78%">
						<a id="btn_stock" href="#" class="easyui-linkbutton" onclick="onBtnClick(this)" data-options="toggle:true,group:'g1',selected:false" >余氏k線圖</a>
					</div>
				</div>
				<div class="group">
					<div class="hori" style="width:20%">
						<a id="btn_particleLink"  href="#"  class="easyui-linkbutton" style="width:100%; height:40px;" onclick="onBtnClick(this)" data-options="iconCls:'icon-back'" ></a>
					</div>
					<div class="hori" style="width:78%">
						<a id="btn_particle" href="#" class="easyui-linkbutton" onclick="onBtnClick(this)" data-options="toggle:true,group:'g1',selected:false" >幽夢幻境</a>
					</div>
				</div>
				<div class="group">
					<div class="hori" style="width:20%">
						<a id="btn_cardLink" href="#" class="easyui-linkbutton" style="width:100%; height:40px;" onclick="onBtnClick(this)" data-options="iconCls:'icon-back'" ></a>
					</div>
					<div class="hori" style="width:78%">
						<a id="btn_card" href="#" class="easyui-linkbutton" onclick="onBtnClick(this)" data-options="toggle:true,group:'g1',selected:true" >卡牌風雲</a>
					</div>
				</div>
				<a id="btn_team" href="#" class="easyui-linkbutton" onclick="onBtnClick(this)" data-options="toggle:true,group:'g1'">開發人員</a>
			</div>
		</div>
		<div data-options="region:'center',title:'內容'" style="">
			<div id="mc_stock" style="position:relative; width:100%; height:100%; "></div>
			<div id="mc_particle" style="position:relative; width:100%; height:100%; "></div>
			<div id="mc_card" style="position:relative; width:100%; height:100%; ">
				<div class="group" style="text-align:center; margin-top:10px;">
					<a id="btn_addDeck" href="#" class="easyui-linkbutton" onclick="onBtnClick(this)" data-options="iconCls:'icon-add'" >新增套牌</a>
				</div>
				<div id="mc_deckContainer" class="group" style="text-align:center; margin-top:10px;">
					
				</div>
			</div>
			<div id="mc_team" style="position:relative; width:100%; height:100%; display:none;">
				team
			</div>
		</div>
	</div>
	<script src="../common/js/lib/underscore/underscore-min.js"></script>	
	<script src="../common/js/store.js"></script>	
	<script src="js/model.js"></script>	
	<script>
	/*
	online:'425311264344425',
	local:'679171275511375',
	*/
	
	var fbid, token;
	var loadModel;
	function getNewName(){
		
	}
	
	myapp.facebook.init( '679171275511375', function(){
		$('#btn_login' ).linkbutton( 'enable' );
	});
	
	openCard();
	
	function appStart(){
	
	}
	
	function showDeckList( retModel ){
		console.log( retModel );
		$("#mc_deckContainer").empty();
		_.each( retModel.cardSuit, function( deck ){
			var copyDeck = JSON.parse( JSON.stringify( deck ) );
			addDeck( copyDeck );
		});
		console.log( 'end' );
	}
	
	function handleModel( func ){
		return function( err, ret ){
			if( err != null ){
				alert( err );
			}else{
				func( ret );
			}
		}
	}
	
	function onBtnClick( target ){
		switch( target.id ){
			case 'btn_login':
				loginFacebook( function( ret ){
					$('#btn_login' ).linkbutton( 'disable' );
					showMessage( '登入成功' );
					
					fbid = ret.authResponse.userID;
					token = ret.authResponse.accessToken;
					
					model.load( fbid, token, handleModel( function( ret ){
						loadModel = ret;
						showDeckList( loadModel );
					}));
				});
				break;
			case 'btn_addDeck':
				model.editCardSuit( loadModel, {
					name: leo.utils.generateUUID(),
					game: "fighter",
					cards:[]
				})
				showDeckList( loadModel );
				break;
			case 'btn_stockLink':
				window.open( 'http://particle-979.appspot.com/stock/index.html#' );
				break;
			case 'btn_particleLink':
				window.open( 'http://particle-979.appspot.com/particle/index.html#' );
				break;
			case 'btn_cardLink':
				window.open( 'http://particle-979.appspot.com/card/index.html#' );
				break;
			case 'btn_stock':
				openStock();
				break;
			case 'btn_particle':
				openParticle();
				break;
			case 'btn_card':
				openCard();
				break;
			case 'btn_team':
				openTeam();
				break;
		}
	}
	
	function editAndShow( editModel ){
		model.editCardSuit( loadModel, editModel );
		showDeckList( loadModel );
		
		model.save( fbid, token, loadModel, handleModel( function( ret ){
			console.log( ret );
		}));
	}
	
	function addDeck( _model ){
		var dom = $("#tmpl_deck" ).tmpl( _model );
		$('#mc_deckContainer').append( dom );
		dom.find( '.easyui-linkbutton' ).linkbutton({
			group:_model.name,
			onClick:(function( __model ){
				return function(){
					switch( this.id ){
						case 'btn_fighter':__model.game = 'fighter';break;
						case 'btn_gundamWar':__model.game = 'gundamWar';break;
						case 'btn_sangoWar':__model.game = 'sangoWar';break;
					}
					editAndShow( __model );
				}
			})( _model )
		});
		dom.find( '.easyui-textbox' ).textbox();
		dom.find( '.easyui-textbox' ).textbox({
			onChange:(function( __model ){
				return function( nv, ov ){
					switch( $( this ).attr( 'id' )){
						case 'txt_name':
							__model.name = nv;
							editAndShow( __model );
							break;
						case 'txt_cards':
							try{
							__model.cards = JSON.parse( '[' + nv + ']' );
							}catch( e ){
								console.log("DD");
							}
							editAndShow( __model );
							break;
					}
					
				}
			})( _model )
		});
		
		var cardstr = (function(){
			var str = JSON.stringify( _model.cards );
			str = str.substr( 1, str.length - 2 );
			return str;
		})();
		switch( _model.game ){
			case 'fighter':
				dom.find( '#btn_fighter' ).linkbutton( 'select' );
				break;
			case 'gundamWar':
				dom.find( '#btn_gundamWar' ).linkbutton( 'select' );
				break;
			case 'sangoWar':
				dom.find( '#btn_sangoWar' ).linkbutton( 'select' );
		}
		
		dom.find( '#txt_cards' ).textbox( {
			value:cardstr
		});
		
		dom.find( '#btn_remove' ).click( function(){
			model.removeCardSuit( loadModel, $(this).attr( 'group' ) );
			model.save( fbid, token, loadModel, handleModel( function( ret ){
				console.log( ret );
				showDeckList( loadModel );
			}));
			
		});
	}
	
	function loginFacebook( cb ){
		myapp.facebook.login( cb );
	}
	
	function openStock(){
		$('#mc_stock' ).show();
		$('#mc_particle' ).hide();
		$('#mc_card' ).hide();
		$('#mc_team' ).hide();
	}
	
	function openParticle(){
		$('#mc_stock' ).hide();
		$('#mc_particle' ).show();
		$('#mc_card' ).hide();
		$('#mc_team' ).hide();
	}
	
	function openCard(){
		$('#mc_stock' ).hide();
		$('#mc_particle' ).hide();
		$('#mc_card' ).show();
		$('#mc_team' ).hide();
	}
	
	function openTeam(){
		$('#mc_stock' ).hide();
		$('#mc_particle' ).hide();
		$('#mc_card' ).hide();
		$('#mc_team' ).show();
	}
	
	function showMessage( msg ){
		$.messager.show({
			title:'提示',
			msg: msg,
			timeout:2000,
			showType:'slide'
		});
	}
	</script>
	<script src="js/manager.js"></script>
</body>
</html>